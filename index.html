<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ward Round List</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="app-container">
        <!-- Main Navigation Tabs -->
        <div class="main-tabs">
            <button class="main-tab-btn active" data-view="patients">
                <i class="fas fa-user-injured"></i> Patients
            </button>
            <button class="main-tab-btn" data-view="all-tasks">
                <i class="fas fa-tasks"></i> All Tasks
            </button>
        </div>
        
        <!-- Main View (Patient List) -->
        <div id="patient-list-view" class="main-view active">
            <header>
                <h1><i class="fas fa-clipboard-list"></i> Ward Round List</h1>
                <div class="header-actions">
                    <button id="sort-by-ward-btn" class="secondary-btn">
                        <i class="fas fa-sort"></i> Sort by Ward
                    </button>
                    <button id="add-patient-btn" class="primary-btn">
                        <i class="fas fa-user-plus"></i> Add Patient
                    </button>
                </div>
            </header>
            
            <div class="search-container">
                <input type="text" id="patient-search" placeholder="Search patients...">
                <i class="fas fa-search search-icon"></i>
            </div>
            
            <div id="patients-container" class="patients-list">
                <!-- Patients will be listed here -->
            </div>
        </div>
        
        <!-- All Tasks View -->
        <div id="all-tasks-view" class="main-view">
            <header>
                <h1><i class="fas fa-tasks"></i> All Tasks</h1>
                <div class="header-actions">
                    <select id="task-filter" class="task-filter-select">
                        <option value="all">All Tasks</option>
                        <option value="urgent">Urgent Only</option>
                        <option value="normal">Normal Only</option>
                        <option value="completed">Completed Only</option>
                        <option value="pending">Pending Only</option>
                    </select>
                </div>
            </header>
            
            <div class="search-container">
                <input type="text" id="task-search" placeholder="Search tasks...">
                <i class="fas fa-search search-icon"></i>
            </div>
            
            <div id="all-tasks-container">
                <!-- Tasks will be listed here -->
            </div>
        </div>
        
        <!-- Patient Detail View (Hidden initially) -->
        <div id="patient-detail-view" class="hidden">
            <header class="detail-header">
                <button id="back-to-list-btn" class="secondary-btn">
                    <i class="fas fa-arrow-left"></i> Back to List
                </button>
                <h2 id="patient-name-header">Patient Name</h2>
                <div class="patient-actions">
                    <button id="edit-patient-btn" class="secondary-btn">
                        <i class="fas fa-user-edit"></i> Edit
                    </button>
                    <button id="delete-patient-btn" class="danger-btn">
                        <i class="fas fa-user-minus"></i> Delete
                    </button>
                </div>
            </header>
            
            <div class="patient-info-container">
                <div class="patient-basic-info">
                    <div class="info-group">
                        <p><strong>Hospital #:</strong> <span id="patient-id"></span></p>
                        <p><strong>Age/Gender:</strong> <span id="patient-age"></span>/<span id="patient-gender"></span></p>
                    </div>
                    <div class="info-group">
                        <p><strong>Ward/Bed:</strong> <span id="patient-ward"></span></p>
                        <p><strong>Diagnosis:</strong> <span id="patient-diagnosis"></span></p>
                    </div>
                </div>
                
                <!-- Tabs for Tasks, Notes and Medical History -->
                <div class="tabs">
                    <button class="tab-btn active" data-tab="tasks">Tasks</button>
                    <button class="tab-btn" data-tab="notes">Notes</button>
                    <button class="tab-btn" data-tab="medical-history">History</button>
                </div>
                
                <!-- Tasks Tab Content -->
                <div id="tasks-tab" class="tab-content active">
                    <div class="note-form">
                        <form id="task-form">
                            <div class="form-row">
                                <input type="text" id="task-input" placeholder="Add new task..." required>
                                <select id="task-priority">
                                    <option value="normal">Normal</option>
                                    <option value="urgent">Urgent</option>
                                    <option value="completed">Completed</option>
                                </select>
                                <button type="submit" class="primary-btn">Add</button>
                            </div>
                        </form>
                    </div>
                    
                    <div id="tasks-list" class="tasks-list">
                        <!-- Tasks will be added here -->
                    </div>
                </div>
                
                <!-- Notes Tab Content -->
                <div id="notes-tab" class="tab-content">
                    <div class="note-form">
                        <form id="clinical-note-form">
                            <textarea id="clinical-note-input" placeholder="Enter clinical note..." rows="3"></textarea>
                            <button type="submit" class="primary-btn">Add Note</button>
                        </form>
                    </div>
                    
                    <div id="clinical-notes-list" class="notes-list">
                        <!-- Clinical notes will be added here -->
                    </div>
                </div>
                
                <!-- Medical History Tab Content -->
                <div id="medical-history-tab" class="tab-content">
                    <div class="note-form">
                        <form id="medical-history-form">
                            <input type="text" id="diagnosis-input" placeholder="Enter diagnosis...">
                            <button type="submit" class="primary-btn">Add Diagnosis</button>
                        </form>
                    </div>
                    
                    <div id="medical-history-list" class="diagnosis-list">
                        <!-- Medical history items will be added here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Add/Edit Patient Modal (Hidden initially) -->
        <div id="patient-modal" class="modal hidden">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <h2 id="modal-title">Add New Patient</h2>
                <form id="patient-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="patient-name-input">Name</label>
                            <input type="text" id="patient-name-input" required>
                        </div>
                        <div class="form-group">
                            <label for="patient-id-input">Hospital #</label>
                            <input type="text" id="patient-id-input" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="patient-age-input">Age</label>
                            <input type="number" id="patient-age-input" min="0" max="120" required>
                        </div>
                        <div class="form-group">
                            <label for="patient-gender-input">Gender</label>
                            <select id="patient-gender-input" required>
                                <option value="">Select</option>
                                <option value="M">M</option>
                                <option value="F">F</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="patient-ward-input">Ward/Bed</label>
                            <input type="text" id="patient-ward-input" placeholder="e.g. B4/12" required>
                        </div>
                        <div class="form-group">
                            <label for="patient-diagnosis-input">Primary Diagnosis</label>
                            <input type="text" id="patient-diagnosis-input" required>
                        </div>
                    </div>
                    <button type="submit" id="save-patient-btn" class="primary-btn">Save Patient</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Data structure
        let patients = JSON.parse(localStorage.getItem('patients') || '[]');
        let currentPatientId = null;
        
        // If no patients exist, add sample data
        if (patients.length === 0) {
            patients = [
                {
                    id: 'MRN12345',
                    name: 'John Smith',
                    age: 67,
                    gender: 'M',
                    ward: 'B4/12',
                    diagnosis: 'Myocardial Infarction',
                    tasks: [
                        {
                            id: Date.now() - 50000,
                            text: 'Arrange echo',
                            priority: 'normal',
                            date: new Date(Date.now() - 50000).toLocaleString()
                        },
                        {
                            id: Date.now() - 60000,
                            text: 'Cardiology review',
                            priority: 'urgent',
                            date: new Date(Date.now() - 60000).toLocaleString()
                        },
                        {
                            id: Date.now() - 70000,
                            text: 'Discharge planning',
                            priority: 'completed',
                            date: new Date(Date.now() - 70000).toLocaleString()
                        }
                    ],
                    clinicalNotes: [
                        {
                            id: Date.now() - 100000,
                            text: 'Patient admitted with chest pain. ECG shows ST elevation in leads V1-V4. Started on aspirin and referred for urgent angiography.',
                            date: new Date(Date.now() - 100000).toLocaleString()
                        }
                    ],
                    medicalHistory: [
                        {
                            id: Date.now() - 200000,
                            diagnosis: 'Hypertension',
                            date: new Date(Date.now() - 200000).toLocaleString()
                        },
                        {
                            id: Date.now() - 300000,
                            diagnosis: 'Type 2 Diabetes',
                            date: new Date(Date.now() - 300000).toLocaleString()
                        }
                    ]
                },
                {
                    id: 'MRN67890',
                    name: 'Sarah Johnson',
                    age: 42,
                    gender: 'F',
                    ward: 'A2/05',
                    diagnosis: 'Subarachnoid Hemorrhage',
                    tasks: [
                        {
                            id: Date.now() - 55000,
                            text: 'Nimodipine due at 2pm',
                            priority: 'urgent',
                            date: new Date(Date.now() - 55000).toLocaleString()
                        },
                        {
                            id: Date.now() - 65000,
                            text: 'Check Na+',
                            priority: 'normal',
                            date: new Date(Date.now() - 65000).toLocaleString()
                        }
                    ],
                    clinicalNotes: [
                        {
                            id: Date.now() - 400000,
                            text: 'Patient presented with sudden onset headache and neck stiffness. CT scan shows subarachnoid hemorrhage. Neurosurgery consulted.',
                            date: new Date(Date.now() - 400000).toLocaleString()
                        }
                    ],
                    medicalHistory: [
                        {
                            id: Date.now() - 500000,
                            diagnosis: 'Migraine',
                            date: new Date(Date.now() - 500000).toLocaleString()
                        }
                    ]
                },
                {
                    id: 'MRN24680',
                    name: 'Michael Chen',
                    age: 55,
                    gender: 'M',
                    ward: 'C1/08',
                    diagnosis: 'Colorectal Cancer',
                    tasks: [
                        {
                            id: Date.now() - 75000,
                            text: 'Prescribe antiemetics',
                            priority: 'normal',
                            date: new Date(Date.now() - 75000).toLocaleString()
                        },
                        {
                            id: Date.now() - 85000,
                            text: 'Discuss scan results',
                            priority: 'urgent',
                            date: new Date(Date.now() - 85000).toLocaleString()
                        },
                        {
                            id: Date.now() - 95000,
                            text: 'Order CBC',
                            priority: 'completed',
                            date: new Date(Date.now() - 95000).toLocaleString()
                        }
                    ],
                    clinicalNotes: [
                        {
                            id: Date.now() - 600000,
                            text: 'Cycle 3 of FOLFOX chemotherapy administered today. Patient tolerating treatment well with mild peripheral neuropathy.',
                            date: new Date(Date.now() - 600000).toLocaleString()
                        }
                    ],
                    medicalHistory: [
                        {
                            id: Date.now() - 700000,
                            diagnosis: 'Colorectal Adenocarcinoma',
                            date: new Date(Date.now() - 700000).toLocaleString()
                        },
                        {
                            id: Date.now() - 800000,
                            diagnosis: 'Hyperlipidemia',
                            date: new Date(Date.now() - 800000).toLocaleString()
                        }
                    ]
                }
            ];
            localStorage.setItem('patients', JSON.stringify(patients));
        }
        
        // DOM Elements
        const patientListView = document.getElementById('patient-list-view');
        const patientDetailView = document.getElementById('patient-detail-view');
        const patientsContainer = document.getElementById('patients-container');
        const patientSearch = document.getElementById('patient-search');
        const addPatientBtn = document.getElementById('add-patient-btn');
        const sortByWardBtn = document.getElementById('sort-by-ward-btn');
        const backToListBtn = document.getElementById('back-to-list-btn');
        const editPatientBtn = document.getElementById('edit-patient-btn');
        const deletePatientBtn = document.getElementById('delete-patient-btn');
        const patientModal = document.getElementById('patient-modal');
        const closeModal = document.querySelector('.close-modal');
        const patientForm = document.getElementById('patient-form');
        const modalTitle = document.getElementById('modal-title');
        const taskForm = document.getElementById('task-form');
        const taskInput = document.getElementById('task-input');
        const taskPriority = document.getElementById('task-priority');
        const tasksList = document.getElementById('tasks-list');
        const clinicalNoteForm = document.getElementById('clinical-note-form');
        const clinicalNoteInput = document.getElementById('clinical-note-input');
        const clinicalNotesList = document.getElementById('clinical-notes-list');
        const medicalHistoryForm = document.getElementById('medical-history-form');
        const diagnosisInput = document.getElementById('diagnosis-input');
        const medicalHistoryList = document.getElementById('medical-history-list');
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // Get main tab elements
        const mainTabButtons = document.querySelectorAll('.main-tab-btn');
        const mainViews = document.querySelectorAll('.main-view');
        const allTasksView = document.getElementById('all-tasks-view');
        const allTasksContainer = document.getElementById('all-tasks-container');
        const taskFilter = document.getElementById('task-filter');
        const taskSearch = document.getElementById('task-search');
        
        // Render patient list
        function renderPatientList(patientsToRender = patients) {
            patientsContainer.innerHTML = '';
            
            if (patientsToRender.length === 0) {
                patientsContainer.innerHTML = '<p class="no-patients">No patients found. Add a new patient to get started.</p>';
                return;
            }
            
            // Group patients by ward
            const patientsByWard = {};
            patientsToRender.forEach(patient => {
                const wardName = patient.ward.split('/')[0]; // Extract ward part before the bed number
                if (!patientsByWard[wardName]) {
                    patientsByWard[wardName] = [];
                }
                patientsByWard[wardName].push(patient);
            });
            
            // Sort the wards alphabetically
            const sortedWards = Object.keys(patientsByWard).sort();
            
            // Create ward groups with patients
            sortedWards.forEach(ward => {
                const wardGroup = document.createElement('div');
                wardGroup.className = 'ward-group';
                
                const wardHeader = document.createElement('div');
                wardHeader.className = 'ward-header';
                wardHeader.innerHTML = `<i class="fas fa-hospital"></i> Ward ${ward}`;
                wardGroup.appendChild(wardHeader);
                
                patientsByWard[ward].forEach(patient => {
                    const patientCard = document.createElement('div');
                    patientCard.className = 'patient-card';
                    
                    // Count tasks by priority
                    const taskCounts = {
                        normal: 0,
                        urgent: 0,
                        completed: 0
                    };
                    
                    if (patient.tasks) {
                        patient.tasks.forEach(task => {
                            if (taskCounts.hasOwnProperty(task.priority)) {
                                taskCounts[task.priority]++;
                            }
                        });
                    }
                    
                    patientCard.innerHTML = `
                        <div class="patient-card-content">
                            <div class="patient-header">
                                <h3 class="patient-name">${patient.name}</h3>
                            </div>
                            <div class="patient-info">
                                <p><span class="info-label">Hospital #:</span> ${patient.id}</p>
                                <p><span class="info-label">Age/Gender:</span> ${patient.age}/${patient.gender}</p>
                                <p><span class="info-label">Location:</span> ${patient.ward}</p>
                                <p><span class="info-label">DOB:</span> ${patient.dob || 'Not available'}</p>
                            </div>
                            <div class="diagnosis-badge">${patient.diagnosis || 'No diagnosis'}</div>
                            <div class="patient-footer">
                                <div class="task-indicators">
                                    ${taskCounts.urgent > 0 ? 
                                    `<div class="task-indicator">
                                        <span class="task-count urgent">${taskCounts.urgent}</span> Urgent
                                    </div>` : ''}
                                    ${taskCounts.normal > 0 ? 
                                    `<div class="task-indicator">
                                        <span class="task-count normal">${taskCounts.normal}</span> Tasks
                                    </div>` : ''}
                                    ${taskCounts.completed > 0 ? 
                                    `<div class="task-indicator">
                                        <span class="task-count completed">${taskCounts.completed}</span> Done
                                    </div>` : ''}
                                </div>
                                <button class="view-patient-btn" data-id="${patient.id}">View Details</button>
                            </div>
                        </div>
                    `;
                    wardGroup.appendChild(patientCard);
                });
                
                patientsContainer.appendChild(wardGroup);
            });
            
            // Add event listeners to view buttons
            document.querySelectorAll('.view-patient-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const patientId = this.getAttribute('data-id');
                    showPatientDetails(patientId);
                });
            });
        }
        
        // Show patient details
        function showPatientDetails(patientId) {
            currentPatientId = patientId;
            const patient = patients.find(p => p.id === patientId);
            
            if (!patient) return;
            
            // Update patient info
            document.getElementById('patient-name-header').textContent = patient.name;
            document.getElementById('patient-id').textContent = patient.id;
            document.getElementById('patient-age').textContent = patient.age;
            document.getElementById('patient-gender').textContent = patient.gender;
            document.getElementById('patient-ward').textContent = patient.ward;
            document.getElementById('patient-diagnosis').textContent = patient.diagnosis || 'Not specified';
            
            // Render tasks
            renderTasks(patient);
            
            // Render clinical notes
            renderClinicalNotes(patient);
            
            // Render medical history
            renderMedicalHistory(patient);
            
            // Show patient detail view
            patientListView.classList.add('hidden');
            patientDetailView.classList.remove('hidden');
            
            // Reset to tasks tab
            document.querySelector('.tab-btn[data-tab="tasks"]').click();
        }
        
        // Render tasks
        function renderTasks(patient) {
            tasksList.innerHTML = '';
            
            if (!patient.tasks || patient.tasks.length === 0) {
                tasksList.innerHTML = '<p class="no-tasks">No tasks yet. Add one above.</p>';
                return;
            }
            
            // Group tasks by priority
            const urgentTasks = patient.tasks.filter(task => task.priority === 'urgent');
            const normalTasks = patient.tasks.filter(task => task.priority === 'normal');
            const completedTasks = patient.tasks.filter(task => task.priority === 'completed');
            
            // Render urgent tasks first, then normal, then completed
            [...urgentTasks, ...normalTasks, ...completedTasks].forEach(task => {
                const taskElement = document.createElement('div');
                taskElement.className = `task-item ${task.priority}`;
                taskElement.innerHTML = `
                    <div class="task-content">
                        <div class="task-checkbox" data-id="${task.id}" data-status="${task.priority}">
                            ${task.priority === 'completed' ? 
                                '<i class="fas fa-check-circle"></i>' : 
                                '<i class="far fa-circle"></i>'}
                        </div>
                        <p class="task-text">${task.text}</p>
                    </div>
                    <div class="task-actions">
                        <span class="task-date">${task.date}</span>
                        <button class="delete-task-btn" data-id="${task.id}">×</button>
                    </div>
                `;
                tasksList.appendChild(taskElement);
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-task-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const taskId = parseInt(this.getAttribute('data-id'));
                    deleteTask(taskId);
                });
            });
            
            // Add event listeners to task checkboxes
            document.querySelectorAll('.task-checkbox').forEach(checkbox => {
                checkbox.addEventListener('click', function() {
                    const taskId = parseInt(this.getAttribute('data-id'));
                    const status = this.getAttribute('data-status');
                    toggleTaskStatus(taskId, status);
                });
            });
        }
        
        // Render clinical notes
        function renderClinicalNotes(patient) {
            clinicalNotesList.innerHTML = '';
            
            if (!patient.clinicalNotes || patient.clinicalNotes.length === 0) {
                clinicalNotesList.innerHTML = '<p class="no-notes">No clinical notes yet.</p>';
                return;
            }
            
            // Sort notes by date (newest first)
            const sortedNotes = [...patient.clinicalNotes].sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );
            
            sortedNotes.forEach(note => {
                const noteElement = document.createElement('div');
                noteElement.className = 'note';
                noteElement.innerHTML = `
                    <div class="note-header">
                        <span class="note-date">${note.date}</span>
                        <button class="delete-note-btn" data-id="${note.id}">×</button>
                    </div>
                    <p class="note-text">${note.text}</p>
                `;
                clinicalNotesList.appendChild(noteElement);
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-note-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const noteId = parseInt(this.getAttribute('data-id'));
                    deleteClinicalNote(noteId);
                });
            });
        }
        
        // Render medical history
        function renderMedicalHistory(patient) {
            medicalHistoryList.innerHTML = '';
            
            if (!patient.medicalHistory || patient.medicalHistory.length === 0) {
                medicalHistoryList.innerHTML = '<p class="no-notes">No medical history recorded.</p>';
                return;
            }
            
            patient.medicalHistory.forEach(item => {
                const historyElement = document.createElement('div');
                historyElement.className = 'diagnosis-item';
                historyElement.innerHTML = `
                    <div class="diagnosis-header">
                        <span class="diagnosis-text">${item.diagnosis}</span>
                        <div class="diagnosis-actions">
                            <button class="delete-diagnosis-btn" data-id="${item.id}">×</button>
                        </div>
                    </div>
                `;
                medicalHistoryList.appendChild(historyElement);
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-diagnosis-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const diagnosisId = parseInt(this.getAttribute('data-id'));
                    deleteDiagnosis(diagnosisId);
                });
            });
        }
        
        // Add task
        function addTask(e) {
            e.preventDefault();
            const text = taskInput.value.trim();
            const priority = taskPriority.value;
            
            if (text && currentPatientId) {
                const patientIndex = patients.findIndex(p => p.id === currentPatientId);
                
                if (patientIndex === -1) return;
                
                const newTask = {
                    id: Date.now(),
                    text,
                    priority,
                    date: new Date().toLocaleString()
                };
                
                if (!patients[patientIndex].tasks) {
                    patients[patientIndex].tasks = [];
                }
                
                patients[patientIndex].tasks.push(newTask);
                localStorage.setItem('patients', JSON.stringify(patients));
                taskInput.value = '';
                taskPriority.value = 'normal';
                renderTasks(patients[patientIndex]);
            }
        }
        
        // Delete task
        function deleteTask(taskId) {
            const patientIndex = patients.findIndex(p => p.id === currentPatientId);
            
            if (patientIndex === -1) return;
            
            patients[patientIndex].tasks = patients[patientIndex].tasks.filter(
                task => task.id !== taskId
            );
            
            localStorage.setItem('patients', JSON.stringify(patients));
            renderTasks(patients[patientIndex]);
        }
        
        // Toggle task status
        function toggleTaskStatus(taskId, currentStatus) {
            const patientIndex = patients.findIndex(p => p.id === currentPatientId);
            
            if (patientIndex === -1) return;
            
            const taskIndex = patients[patientIndex].tasks.findIndex(task => task.id === taskId);
            
            if (taskIndex === -1) return;
            
            // Toggle between completed and normal
            patients[patientIndex].tasks[taskIndex].priority = 
                currentStatus === 'completed' ? 'normal' : 'completed';
            
            localStorage.setItem('patients', JSON.stringify(patients));
            renderTasks(patients[patientIndex]);
        }
        
        // Add clinical note
        function addClinicalNote(e) {
            e.preventDefault();
            const text = clinicalNoteInput.value.trim();
            
            if (text && currentPatientId) {
                const patientIndex = patients.findIndex(p => p.id === currentPatientId);
                
                if (patientIndex === -1) return;
                
                const newNote = {
                    id: Date.now(),
                    text,
                    date: new Date().toLocaleString()
                };
                
                if (!patients[patientIndex].clinicalNotes) {
                    patients[patientIndex].clinicalNotes = [];
                }
                
                patients[patientIndex].clinicalNotes.push(newNote);
                localStorage.setItem('patients', JSON.stringify(patients));
                clinicalNoteInput.value = '';
                renderClinicalNotes(patients[patientIndex]);
            }
        }
        
        // Delete clinical note
        function deleteClinicalNote(noteId) {
            const patientIndex = patients.findIndex(p => p.id === currentPatientId);
            
            if (patientIndex === -1) return;
            
            patients[patientIndex].clinicalNotes = patients[patientIndex].clinicalNotes.filter(
                note => note.id !== noteId
            );
            
            localStorage.setItem('patients', JSON.stringify(patients));
            renderClinicalNotes(patients[patientIndex]);
        }
        
        // Add diagnosis to medical history
        function addDiagnosis(e) {
            e.preventDefault();
            const diagnosis = diagnosisInput.value.trim();
            
            if (diagnosis && currentPatientId) {
                const patientIndex = patients.findIndex(p => p.id === currentPatientId);
                
                if (patientIndex === -1) return;
                
                const newDiagnosis = {
                    id: Date.now(),
                    diagnosis,
                    date: new Date().toLocaleString()
                };
                
                if (!patients[patientIndex].medicalHistory) {
                    patients[patientIndex].medicalHistory = [];
                }
                
                patients[patientIndex].medicalHistory.push(newDiagnosis);
                localStorage.setItem('patients', JSON.stringify(patients));
                diagnosisInput.value = '';
                renderMedicalHistory(patients[patientIndex]);
            }
        }
        
        // Delete diagnosis
        function deleteDiagnosis(diagnosisId) {
            const patientIndex = patients.findIndex(p => p.id === currentPatientId);
            
            if (patientIndex === -1) return;
            
            patients[patientIndex].medicalHistory = patients[patientIndex].medicalHistory.filter(
                item => item.id !== diagnosisId
            );
            
            localStorage.setItem('patients', JSON.stringify(patients));
            renderMedicalHistory(patients[patientIndex]);
        }
        
        // Show add patient modal
        function showAddPatientModal() {
            modalTitle.textContent = 'Add New Patient';
            patientForm.reset();
            patientModal.classList.remove('hidden');
        }
        
        // Show edit patient modal
        function showEditPatientModal() {
            const patient = patients.find(p => p.id === currentPatientId);
            
            if (!patient) return;
            
            modalTitle.textContent = 'Edit Patient';
            document.getElementById('patient-name-input').value = patient.name;
            document.getElementById('patient-id-input').value = patient.id;
            document.getElementById('patient-age-input').value = patient.age;
            document.getElementById('patient-gender-input').value = patient.gender;
            document.getElementById('patient-ward-input').value = patient.ward;
            document.getElementById('patient-diagnosis-input').value = patient.diagnosis || '';
            
            patientModal.classList.remove('hidden');
        }
        
        // Save patient (add or edit)
        function savePatient(e) {
            e.preventDefault();
            
            const patientData = {
                name: document.getElementById('patient-name-input').value,
                id: document.getElementById('patient-id-input').value,
                age: parseInt(document.getElementById('patient-age-input').value),
                gender: document.getElementById('patient-gender-input').value,
                ward: document.getElementById('patient-ward-input').value,
                diagnosis: document.getElementById('patient-diagnosis-input').value
            };
            
            if (modalTitle.textContent === 'Edit Patient') {
                // Edit existing patient
                const patientIndex = patients.findIndex(p => p.id === currentPatientId);
                
                if (patientIndex === -1) return;
                
                // Preserve notes, tasks and medical history
                patientData.tasks = patients[patientIndex].tasks || [];
                patientData.clinicalNotes = patients[patientIndex].clinicalNotes || [];
                patientData.medicalHistory = patients[patientIndex].medicalHistory || [];
                
                patients[patientIndex] = patientData;
                
                // Update current patient ID in case hospital number changed
                currentPatientId = patientData.id;
                
                // Update patient details view
                document.getElementById('patient-name-header').textContent = patientData.name;
                document.getElementById('patient-id').textContent = patientData.id;
                document.getElementById('patient-age').textContent = patientData.age;
                document.getElementById('patient-gender').textContent = patientData.gender;
                document.getElementById('patient-ward').textContent = patientData.ward;
                document.getElementById('patient-diagnosis').textContent = patientData.diagnosis || 'Not specified';
            } else {
                // Add new patient
                patientData.tasks = [];
                patientData.clinicalNotes = [];
                patientData.medicalHistory = [];
                patients.push(patientData);
            }
            
            localStorage.setItem('patients', JSON.stringify(patients));
            patientModal.classList.add('hidden');
            renderPatientList();
        }
        
        // Delete patient
        function deletePatient() {
            if (!confirm('Are you sure you want to delete this patient? This action cannot be undone.')) {
                return;
            }
            
            patients = patients.filter(p => p.id !== currentPatientId);
            localStorage.setItem('patients', JSON.stringify(patients));
            
            // Go back to patient list
            patientDetailView.classList.add('hidden');
            patientListView.classList.remove('hidden');
            renderPatientList();
        }
        
        // Search patients
        function searchPatients() {
            const searchTerm = patientSearch.value.toLowerCase();
            
            if (!searchTerm) {
                renderPatientList();
                return;
            }
            
            const filteredPatients = patients.filter(patient => 
                patient.name.toLowerCase().includes(searchTerm) || 
                patient.id.toLowerCase().includes(searchTerm) ||
                patient.ward.toLowerCase().includes(searchTerm) ||
                (patient.diagnosis && patient.diagnosis.toLowerCase().includes(searchTerm))
            );
            
            renderPatientList(filteredPatients);
        }
        
        // Sort patients by ward
        function sortPatientsByWard() {
            const sortedPatients = [...patients].sort((a, b) => {
                if (a.ward < b.ward) return -1;
                if (a.ward > b.ward) return 1;
                return 0;
            });
            
            renderPatientList(sortedPatients);
        }
        
        // Function to render all tasks
        function renderAllTasks(filter = 'all', searchTerm = '') {
            allTasksContainer.innerHTML = '';
            
            // Group tasks by ward and completion status
            const tasksByWard = {};
            let totalTasksFound = 0;
            
            patients.forEach(patient => {
                if (!patient.tasks || patient.tasks.length === 0) return;
                
                const wardName = patient.ward.split('/')[0]; // Extract ward part
                
                if (!tasksByWard[wardName]) {
                    tasksByWard[wardName] = {
                        pending: [],
                        completed: []
                    };
                }
                
                patient.tasks.forEach(task => {
                    // Apply filters
                    if (filter !== 'all') {
                        if (filter === 'urgent' && task.priority !== 'urgent') return;
                        if (filter === 'normal' && task.priority !== 'normal') return;
                        if (filter === 'completed' && task.priority !== 'completed') return;
                        if (filter === 'pending' && task.priority === 'completed') return;
                    }
                    
                    // Apply search term
                    if (searchTerm && !task.text.toLowerCase().includes(searchTerm.toLowerCase())) {
                        return;
                    }
                    
                    // Add patient info to task
                    const taskWithPatient = {
                        ...task,
                        patientName: patient.name,
                        patientId: patient.id,
                        ward: patient.ward
                    };
                    
                    // Group by completion status
                    if (task.priority === 'completed') {
                        tasksByWard[wardName].completed.push(taskWithPatient);
                    } else {
                        tasksByWard[wardName].pending.push(taskWithPatient);
                    }
                    
                    totalTasksFound++;
                });
            });
            
            if (totalTasksFound === 0) {
                allTasksContainer.innerHTML = `
                    <div class="no-tasks">
                        <i class="fas fa-check-circle"></i>
                        <p>No tasks found matching your criteria</p>
                    </div>
                `;
                return;
            }
            
            // Sort wards alphabetically
            const sortedWards = Object.keys(tasksByWard).sort();
            
            sortedWards.forEach(ward => {
                const wardGroup = document.createElement('div');
                wardGroup.className = 'ward-group';
                
                // Ward header
                const wardHeader = document.createElement('div');
                wardHeader.className = 'ward-header';
                wardHeader.innerHTML = `<i class="fas fa-hospital"></i> Ward ${ward}`;
                wardGroup.appendChild(wardHeader);
                
                // Pending tasks section
                const pendingTasks = tasksByWard[ward].pending;
                if (pendingTasks.length > 0) {
                    const pendingSection = document.createElement('div');
                    pendingSection.className = 'task-section';
                    
                    const pendingHeader = document.createElement('div');
                    pendingHeader.className = 'task-section-header';
                    pendingHeader.innerHTML = `
                        <h3><i class="fas fa-spinner"></i> Pending Tasks (${pendingTasks.length})</h3>
                    `;
                    pendingSection.appendChild(pendingHeader);
                    
                    // Sort pending tasks: urgent first, then by date
                    pendingTasks.sort((a, b) => {
                        if (a.priority === 'urgent' && b.priority !== 'urgent') return -1;
                        if (a.priority !== 'urgent' && b.priority === 'urgent') return 1;
                        return new Date(b.date) - new Date(a.date);
                    });
                    
                    pendingTasks.forEach(task => {
                        const taskItem = document.createElement('div');
                        taskItem.className = `task-item ${task.priority}`;
                        taskItem.innerHTML = `
                            <div class="task-content">
                                <div class="task-text">${task.text}</div>
                                <div class="task-meta">
                                    <span class="task-patient">
                                        <i class="fas fa-user"></i> ${task.patientName} (${task.patientId})
                                    </span>
                                    <span class="task-location">
                                        <i class="fas fa-map-marker-alt"></i> ${task.ward}
                                    </span>
                                    <span class="task-date">
                                        <i class="fas fa-clock"></i> ${task.date}
                                    </span>
                                </div>
                            </div>
                            <div class="task-actions">
                                <button class="complete-task-btn" data-patient-id="${task.patientId}" data-task-id="${task.id}">
                                    <i class="fas fa-check-circle"></i>
                                </button>
                                <button class="view-patient-task-btn" data-patient-id="${task.patientId}">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        `;
                        pendingSection.appendChild(taskItem);
                    });
                    
                    wardGroup.appendChild(pendingSection);
                }
                
                // Completed tasks section
                const completedTasks = tasksByWard[ward].completed;
                if (completedTasks.length > 0) {
                    const completedSection = document.createElement('div');
                    completedSection.className = 'task-section';
                    
                    const completedHeader = document.createElement('div');
                    completedHeader.className = 'task-section-header';
                    completedHeader.innerHTML = `
                        <h3><i class="fas fa-check"></i> Completed Tasks (${completedTasks.length})</h3>
                    `;
                    completedSection.appendChild(completedHeader);
                    
                    // Sort completed tasks by date (newest first)
                    completedTasks.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    completedTasks.forEach(task => {
                        const taskItem = document.createElement('div');
                        taskItem.className = `task-item ${task.priority}`;
                        taskItem.innerHTML = `
                            <div class="task-content">
                                <div class="task-text">${task.text}</div>
                                <div class="task-meta">
                                    <span class="task-patient">
                                        <i class="fas fa-user"></i> ${task.patientName} (${task.patientId})
                                    </span>
                                    <span class="task-location">
                                        <i class="fas fa-map-marker-alt"></i> ${task.ward}
                                    </span>
                                    <span class="task-date">
                                        <i class="fas fa-clock"></i> ${task.date}
                                    </span>
                                </div>
                            </div>
                            <div class="task-actions">
                                <button class="reopen-task-btn" data-patient-id="${task.patientId}" data-task-id="${task.id}">
                                    <i class="fas fa-redo"></i>
                                </button>
                                <button class="view-patient-task-btn" data-patient-id="${task.patientId}">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        `;
                        completedSection.appendChild(taskItem);
                    });
                    
                    wardGroup.appendChild(completedSection);
                }
                
                allTasksContainer.appendChild(wardGroup);
            });
            
            // Add event listeners for task actions
            document.querySelectorAll('.complete-task-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const patientId = this.getAttribute('data-patient-id');
                    const taskId = parseInt(this.getAttribute('data-task-id'));
                    completeTask(patientId, taskId);
                });
            });
            
            document.querySelectorAll('.reopen-task-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const patientId = this.getAttribute('data-patient-id');
                    const taskId = parseInt(this.getAttribute('data-task-id'));
                    reopenTask(patientId, taskId);
                });
            });
            
            document.querySelectorAll('.view-patient-task-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const patientId = this.getAttribute('data-patient-id');
                    showPatientDetails(patientId);
                    
                    // Ensure the tasks tab is active
                    document.querySelector('.tab-btn[data-tab="tasks"]').click();
                });
            });
        }
        
        // Function to complete a task from the all tasks view
        function completeTask(patientId, taskId) {
            const patientIndex = patients.findIndex(p => p.id === patientId);
            if (patientIndex === -1) return;
            
            const taskIndex = patients[patientIndex].tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;
            
            patients[patientIndex].tasks[taskIndex].priority = 'completed';
            patients[patientIndex].tasks[taskIndex].completedDate = new Date().toLocaleString();
            localStorage.setItem('patients', JSON.stringify(patients));
            
            // Re-render the all tasks view
            const currentFilter = taskFilter.value;
            const searchTerm = taskSearch.value.trim();
            renderAllTasks(currentFilter, searchTerm);
        }
        
        // Function to reopen a completed task
        function reopenTask(patientId, taskId) {
            const patientIndex = patients.findIndex(p => p.id === patientId);
            if (patientIndex === -1) return;
            
            const taskIndex = patients[patientIndex].tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;
            
            // Set to normal by default when reopening
            patients[patientIndex].tasks[taskIndex].priority = 'normal';
            delete patients[patientIndex].tasks[taskIndex].completedDate;
            localStorage.setItem('patients', JSON.stringify(patients));
            
            // Re-render the all tasks view
            const currentFilter = taskFilter.value;
            const searchTerm = taskSearch.value.trim();
            renderAllTasks(currentFilter, searchTerm);
        }
        
        // Event listeners
        addPatientBtn.addEventListener('click', showAddPatientModal);
        sortByWardBtn.addEventListener('click', sortPatientsByWard);
        backToListBtn.addEventListener('click', () => {
            patientDetailView.classList.add('hidden');
            patientListView.classList.remove('hidden');
            // Update the patient list to show any new urgent tasks
            renderPatientList();
        });
        editPatientBtn.addEventListener('click', showEditPatientModal);
        deletePatientBtn.addEventListener('click', deletePatient);
        closeModal.addEventListener('click', () => patientModal.classList.add('hidden'));
        patientForm.addEventListener('submit', savePatient);
        taskForm.addEventListener('submit', addTask);
        clinicalNoteForm.addEventListener('submit', addClinicalNote);
        medicalHistoryForm.addEventListener('submit', addDiagnosis);
        patientSearch.addEventListener('input', searchPatients);
        
        // Tab switching
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Remove active class from all tabs
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                
                // Add active class to clicked tab
                button.classList.add('active');
                const tabId = button.getAttribute('data-tab');
                document.getElementById(`${tabId}-tab`).classList.add('active');
            });
        });
        
        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === patientModal) {
                patientModal.classList.add('hidden');
            }
        });
        
        // Main tab switching
        mainTabButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Remove active class from all tabs
                mainTabButtons.forEach(btn => btn.classList.remove('active'));
                mainViews.forEach(view => view.classList.remove('active'));
                
                // Add active class to clicked tab
                button.classList.add('active');
                const viewId = button.getAttribute('data-view');
                
                if (viewId === 'patients') {
                    patientListView.classList.add('active');
                    renderPatientList();
                } else if (viewId === 'all-tasks') {
                    allTasksView.classList.add('active');
                    renderAllTasks();
                }
            });
        });
        
        // Event listener for task filter
        taskFilter.addEventListener('change', function() {
            const searchTerm = taskSearch.value.trim();
            renderAllTasks(this.value, searchTerm);
        });
        
        // Event listener for task search
        taskSearch.addEventListener('input', function() {
            const currentFilter = taskFilter.value;
            const searchTerm = this.value.trim();
            renderAllTasks(currentFilter, searchTerm);
        });
        
        // Initial render
        renderPatientList();
    </script>
</body>
</html> 