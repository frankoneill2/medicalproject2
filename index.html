<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ward Round List</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="app-container">
        <!-- Main Navigation Tabs -->
        <div class="main-tabs">
            <button class="main-tab-btn active" data-view="patients">
                <i class="fas fa-user-injured"></i> Patients
            </button>
            <button class="main-tab-btn" data-view="all-tasks">
                <i class="fas fa-tasks"></i> All Tasks
            </button>
            <button class="main-tab-btn" data-view="settings">
                <i class="fas fa-cog"></i> Settings
            </button>
        </div>
        
        <!-- Main View (Patient List) -->
        <div id="patient-list-view" class="main-view active" role="region" aria-label="Patient list">
            <header>
                <div class="title-section">
                    <h1>
                        <i class="fas fa-clipboard-list"></i> Ward Round List
                        <span class="version-badge">v1.4</span>
                    </h1>
                    <button id="theme-toggle" class="theme-toggle" aria-label="Toggle dark mode">
                        <i class="fas fa-moon" aria-hidden="true"></i>
                    </button>
                </div>
                <div class="header-actions">
                    <button id="add-patient-btn" class="primary-btn">
                        <i class="fas fa-user-plus"></i> Add Patient
                    </button>
                </div>
            </header>
            
            <div class="search-container">
                <input type="text" id="patient-search" placeholder="Search patients...">
                <i class="fas fa-search search-icon"></i>
            </div>
            
            <div id="patients-container" class="patients-list">
                <!-- Patients will be listed here -->
            </div>
        </div>
        
        <!-- All Tasks View -->
        <div id="all-tasks-view" class="main-view" role="region" aria-label="All tasks">
            <header>
                <h1><i class="fas fa-tasks"></i> All Tasks</h1>
                <div class="header-actions">
                    <div class="task-filter-container">
                        <div class="task-filter-checkbox-group">
                            <h4>Task Status</h4>
                            <label class="task-filter-label">
                                <input type="checkbox" value="normal" class="task-filter-checkbox" checked>
                                <span>Normal</span>
                            </label>
                            <label class="task-filter-label">
                                <input type="checkbox" value="urgent" class="task-filter-checkbox" checked>
                                <span>Urgent</span>
                            </label>
                            <label class="task-filter-label">
                                <input type="checkbox" value="in-progress" class="task-filter-checkbox" checked>
                                <span>In Progress</span>
                            </label>
                            <label class="task-filter-label">
                                <input type="checkbox" value="completed" class="task-filter-checkbox" checked>
                                <span>Completed</span>
                            </label>
                        </div>
                        <div class="task-type-filter-container">
                            <h4>Task Type</h4>
                            <label class="task-type-filter-label">
                                <input type="checkbox" value="all" class="task-type-filter-checkbox" checked>
                                <span>All Types</span>
                            </label>
                            <label class="task-type-filter-label">
                                <input type="checkbox" value="investigation" class="task-type-filter-checkbox">
                                <span>Investigations</span>
                            </label>
                            <label class="task-type-filter-label">
                                <input type="checkbox" value="bloods" class="task-type-filter-checkbox">
                                <span>Bloods</span>
                            </label>
                            <label class="task-type-filter-label">
                                <input type="checkbox" value="imaging" class="task-type-filter-checkbox">
                                <span>Imaging</span>
                            </label>
                            <label class="task-type-filter-label">
                                <input type="checkbox" value="other" class="task-type-filter-checkbox">
                                <span>Other</span>
                            </label>
                        </div>
                    </div>
                </div>
            </header>
            
            <div class="search-container">
                <input type="text" id="task-search" placeholder="Search tasks...">
                <i class="fas fa-search search-icon"></i>
            </div>
            
            <div id="all-tasks-container">
                <!-- Tasks will be listed here -->
            </div>
        </div>
        
        <!-- Settings View -->
        <div id="settings-view" class="main-view" role="region" aria-label="Settings">
            <header>
                <h1><i class="fas fa-cog"></i> Settings</h1>
            </header>
            
            <div class="settings-container">
                <div class="settings-section">
                    <h2><i class="fas fa-hospital"></i> Ward Management</h2>
                    <p class="settings-description">Manage the list of wards available for patient assignment.</p>
                    
                    <div class="ward-management">
                        <div class="ward-list-container">
                            <h3>Available Wards</h3>
                            <div id="ward-list" class="list-container">
                                <!-- Wards will be listed here -->
                            </div>
                            <div class="add-item-form">
                                <input type="text" id="new-ward-input" placeholder="Enter ward name (e.g., A1)">
                                <button id="add-ward-btn" class="primary-btn"><i class="fas fa-plus"></i> Add Ward</button>
                            </div>
                        </div>
                        
                        <div class="bed-management" id="bed-management">
                            <h3>Beds for Ward: <span id="selected-ward-name">None selected</span></h3>
                            <div class="bed-management-actions">
                                <button id="sort-beds-numeric-btn" class="secondary-btn" disabled><i class="fas fa-sort-numeric-down"></i> Sort Numeric</button>
                                <button id="sort-beds-alpha-btn" class="secondary-btn" disabled><i class="fas fa-sort-alpha-down"></i> Sort Alpha</button>
                            </div>
                            <div id="bed-list" class="list-container sortable">
                                <!-- Beds will be listed here -->
                            </div>
                            <div class="add-item-form">
                                <input type="text" id="new-bed-input" placeholder="Enter bed identifier (e.g., 1, 2, etc.)">
                                <button id="add-bed-btn" class="primary-btn" disabled><i class="fas fa-plus"></i> Add Bed</button>
                            </div>
                        </div>
                        
                        <!-- Ward Edit Modal -->
                        <div id="ward-edit-modal" class="modal hidden">
                            <div class="modal-content">
                                <span class="close-ward-modal">&times;</span>
                                <h2>Edit Ward</h2>
                                <form id="edit-ward-form" class="styled-form">
                                    <div class="form-section">
                                        <div class="form-group">
                                            <label for="edit-ward-name">Ward Name</label>
                                            <input type="text" id="edit-ward-name" class="styled-input" required>
                                        </div>
                                    </div>
                                    
                                    <div class="form-actions">
                                        <button type="submit" class="primary-btn">Save Changes</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Patient Detail View (Hidden initially) -->
        <div id="patient-detail-view" class="hidden" role="region" aria-label="Patient details">
            <header class="detail-header">
                <button id="back-to-list-btn" class="secondary-btn">
                    <i class="fas fa-arrow-left"></i> Back to List
                </button>
                <h2 id="patient-name-header">Patient Name</h2>
                <div class="patient-actions">
                    <button id="edit-patient-btn" class="secondary-btn">
                        <i class="fas fa-user-edit"></i> Edit
                    </button>
                    <button id="delete-patient-btn" class="danger-btn">
                        <i class="fas fa-user-minus"></i> Delete
                    </button>
                </div>
            </header>
            
            <div class="patient-info-container">
                <div class="patient-basic-info">
                    <div class="info-group">
                        <p><strong>Hospital #:</strong> <span id="patient-id"></span></p>
                        <p><strong>Age/Gender:</strong> <span id="patient-age"></span>/<span id="patient-gender"></span></p>
                    </div>
                    <div class="info-group">
                        <p><strong>Ward/Bed:</strong> <span id="patient-ward"></span></p>
                        <p><strong>Diagnoses:</strong> <span id="patient-diagnoses"></span></p>
                    </div>
                </div>
                
                <!-- Tabs for Tasks, Notes and Background -->
                <div class="tabs">
                    <button class="tab-btn active" data-tab="tasks">Tasks</button>
                    <button class="tab-btn" data-tab="notes">Notes</button>
                    <button class="tab-btn" data-tab="medical-history">Background</button>
                </div>
                
                <!-- Tasks Tab Content -->
                <div id="tasks-tab" class="tab-content active">
                    <div class="note-form enhanced-task-form">
                        <h3 class="task-form-title"><i class="fas fa-clipboard-check"></i> Add New Task</h3>
                        <form id="task-form" class="task-add-form">
                            <div class="form-row task-main-row">
                                <div class="form-group task-input-container">
                                    <label for="task-input">Task Title</label>
                                    <input type="text" id="task-input" placeholder="Enter task title here..." class="styled-input" required>
                                </div>
                            </div>
                            <div class="form-row task-options-row">
                                <div class="form-group priority-select-container">
                                    <label for="task-priority">Priority</label>
                                    <select id="task-priority" class="styled-select">
                                        <option value="normal">Normal</option>
                                        <option value="urgent">Urgent</option>
                                        <option value="in-progress">In Progress</option>
                                        <option value="completed">Completed</option>
                                    </select>
                                </div>
                                <div class="form-group type-select-container">
                                    <label for="task-type">Type</label>
                                    <select id="task-type" class="styled-select">
                                        <option value="none">No Type</option>
                                        <option value="investigation">Investigation</option>
                                        <option value="bloods">Bloods</option>
                                        <option value="imaging">Imaging</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="task-description-container">
                                <div class="form-group">
                                    <label for="task-description-input">Description (Optional)</label>
                                    <textarea id="task-description-input" placeholder="Add more details about this task..." rows="3" class="styled-textarea"></textarea>
                                </div>
                            </div>
                            <div class="task-form-actions">
                                <button type="button" id="toggle-task-details" class="toggle-details-btn">
                                    <i class="fas fa-chevron-down"></i> <span>Description</span>
                                </button>
                                <button type="submit" class="primary-btn">
                                    <i class="fas fa-plus"></i> Add Task
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div id="tasks-list" class="tasks-list">
                        <!-- Tasks will be added here -->
                    </div>
                </div>
                
                <!-- Notes Tab Content -->
                <div id="notes-tab" class="tab-content">
                    <div class="note-form">
                        <form id="clinical-note-form">
                            <textarea id="clinical-note-input" placeholder="Enter clinical note..." rows="3"></textarea>
                            <button type="submit" class="primary-btn">Add Note</button>
                        </form>
                    </div>
                    
                    <div id="clinical-notes-list" class="notes-list">
                        <!-- Clinical notes will be added here -->
                    </div>
                </div>
                
                <!-- Background Tab Content -->
                <div id="medical-history-tab" class="tab-content">
                    <!-- Diagnoses Section -->
                    <div class="background-section">
                        <h3 class="section-title">Diagnoses</h3>
                        <div class="note-form">
                            <form id="medical-history-form">
                                <input type="text" id="diagnosis-input" placeholder="Enter diagnosis...">
                                <button type="submit" class="primary-btn">Add Diagnosis</button>
                            </form>
                        </div>
                        
                        <div id="medical-history-list" class="diagnosis-list">
                            <!-- Diagnoses will be added here -->
                        </div>
                    </div>
                    
                    <!-- Social History Section -->
                    <div class="background-section">
                        <h3 class="section-title">Social History</h3>
                        <div class="note-form">
                            <form id="social-history-form">
                                <input type="text" id="social-history-input" placeholder="Enter social history item...">
                                <button type="submit" class="primary-btn">Add Social History</button>
                            </form>
                        </div>
                        
                        <div id="social-history-list" class="diagnosis-list">
                            <!-- Social history items will be added here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Add/Edit Patient Modal (Hidden initially) -->
        <div id="patient-modal" class="modal hidden">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <h2 id="modal-title">Add New Patient</h2>
                <form id="patient-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="patient-name-input">Name</label>
                            <input type="text" id="patient-name-input" required>
                        </div>
                        <div class="form-group">
                            <label for="patient-id-input">Hospital #</label>
                            <input type="text" id="patient-id-input" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="patient-dob-input">Date of Birth</label>
                            <input type="date" id="patient-dob-input">
                            <div class="form-hint">Age: <span id="calculated-age">Not set</span></div>
                        </div>
                        <div class="form-group">
                            <label for="patient-gender-input">Gender</label>
                            <select id="patient-gender-input">
                                <option value="">Select</option>
                                <option value="M">M</option>
                                <option value="F">F</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="patient-location">Location</label>
                            <div class="location-selector">
                                <div class="location-select-group">
                                    <select id="patient-ward-select" class="styled-select">
                                        <option value="">Select Ward</option>
                                        <!-- Ward options will be dynamically added -->
                                    </select>
                                    <select id="patient-bed-select" class="styled-select" disabled>
                                        <option value="">Select Bed</option>
                                        <!-- Bed options will be dynamically added -->
                                    </select>
                                </div>
                                <div class="other-location-container" style="display: none;">
                                    <input type="text" id="patient-other-location" placeholder="Enter custom location">
                                </div>
                                <div class="location-toggle">
                                    <label class="other-location-checkbox">
                                        <input type="checkbox" id="other-location-toggle">
                                        <span>Use other location</span>
                                    </label>
                                </div>
                            </div>
                            <input type="hidden" id="patient-ward-input">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="patient-diagnoses-container">Diagnoses</label>
                        <div id="patient-diagnoses-container" class="diagnoses-container">
                            <div class="diagnosis-input-group">
                                <input type="text" class="diagnosis-input styled-input" placeholder="Enter diagnosis">
                                <button type="button" class="remove-diagnosis-btn"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                        <button type="button" id="add-diagnosis-btn" class="secondary-btn"><i class="fas fa-plus"></i> Add Another Diagnosis</button>
                    </div>
                    <button type="submit" id="save-patient-btn" class="primary-btn">Save Patient</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Edit Task Modal (Hidden initially) -->
    <div id="task-edit-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-task-modal">&times;</span>
            <h2>Edit Task</h2>
            <form id="edit-task-form" class="styled-form">
                <div class="form-section">
                    <h3 class="form-section-title">Task Details</h3>
                    <div class="form-group">
                        <label for="edit-task-text">Title</label>
                        <input type="text" id="edit-task-text" class="styled-input" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-task-description">Description (Optional)</label>
                        <textarea id="edit-task-description" class="styled-textarea" rows="3" placeholder="Add detailed information about this task..."></textarea>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3 class="form-section-title">Task Status</h3>
                    <div class="form-group">
                        <label for="edit-task-priority">Priority</label>
                        <select id="edit-task-priority" class="styled-select" required>
                            <option value="normal">Normal</option>
                            <option value="urgent">Urgent</option>
                            <option value="in-progress">In Progress</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-task-type">Task Type</label>
                        <select id="edit-task-type" class="styled-select">
                            <option value="none">No Type</option>
                            <option value="investigation">Investigation</option>
                            <option value="bloods">Bloods</option>
                            <option value="imaging">Imaging</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="primary-btn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Edit Note Modal (Hidden initially) -->
    <div id="note-edit-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-note-modal">&times;</span>
            <h2>Edit Clinical Note</h2>
            <form id="edit-note-form" class="styled-form">
                <div class="form-section">
                    <div class="form-group">
                        <label for="edit-note-text">Note</label>
                        <textarea id="edit-note-text" class="styled-textarea" rows="5" required></textarea>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="primary-btn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Edit Diagnosis Modal (Hidden initially) -->
    <div id="diagnosis-edit-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-diagnosis-modal">&times;</span>
            <h2>Edit Diagnosis</h2>
            <form id="edit-diagnosis-form" class="styled-form">
                <div class="form-section">
                    <div class="form-group">
                        <label for="edit-diagnosis-text">Diagnosis</label>
                        <input type="text" id="edit-diagnosis-text" class="styled-input" required>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="primary-btn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Edit Social History Modal (Hidden initially) -->
    <div id="social-history-edit-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-social-history-modal">&times;</span>
            <h2>Edit Social History</h2>
            <form id="edit-social-history-form" class="styled-form">
                <div class="form-section">
                    <div class="form-group">
                        <label for="edit-social-history-text">Social History</label>
                        <input type="text" id="edit-social-history-text" class="styled-input" required>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="primary-btn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Data structure
        let patients = JSON.parse(localStorage.getItem('patients') || '[]');
        let currentPatientId = null;
        
        // Ward and Bed management
        let wards = JSON.parse(localStorage.getItem('wards') || '[]');
        let wardBeds = JSON.parse(localStorage.getItem('wardBeds') || '{}');
        let currentSelectedWard = null;
        
        // Helper function to format location string for display
        function formatLocation(locationString) {
            // Common formats to handle: 
            // - "B4/12" → "B4 • Bed 12"
            // - "B4-3/12" → "B4 • Room 3 • Bed 12"
            // - "B4" → "Ward B4"
            
            if (!locationString) return 'Not specified';
            
            // Check for the room-bed pattern (e.g., "B4-3/12")
            const roomBedMatch = locationString.match(/([A-Za-z0-9]+)-(\d+)\/(\d+)/);
            if (roomBedMatch) {
                const [_, ward, room, bed] = roomBedMatch;
                return `${ward} • Room ${room} • Bed ${bed}`;
            }
            
            // Check for the ward-bed pattern (e.g., "B4/12")
            const wardBedMatch = locationString.match(/([A-Za-z0-9]+)\/(\d+)/);
            if (wardBedMatch) {
                const [_, ward, bed] = wardBedMatch;
                return `${ward} • Bed ${bed}`;
            }
            
            // Try to match explicit "Ward X Room Y Bed Z" pattern
            const explicitMatch = locationString.match(/Ward\s+([A-Za-z0-9]+)\s+Room\s+(\d+)\s+Bed\s+(\d+)/i);
            if (explicitMatch) {
                const [_, ward, room, bed] = explicitMatch;
                return `${ward} • Room ${room} • Bed ${bed}`;
            }
            
            // Check if the string is just a ward identifier (e.g., "B4")
            // No slashes or dashes should be present for simple ward
            if (/^[A-Za-z0-9]+$/.test(locationString) && !locationString.includes('/') && !locationString.includes('-')) {
                return `Ward ${locationString}`;
            }
            
            // If no pattern matches, return the original string
            return locationString;
        }
        
        // If no patients exist, add sample data
        if (patients.length === 0) {
            patients = [
                {
                    id: 'MRN12345',
                    name: 'John Smith',
                    age: 67,
                    gender: 'M',
                    ward: 'B4-2/12',
                    diagnoses: ['Myocardial Infarction', 'Hypertension', 'Type 2 Diabetes'],
                    tasks: [
                        {
                            id: Date.now() - 50000,
                            text: 'Arrange echo',
                            priority: 'normal',
                            date: new Date(Date.now() - 50000).toLocaleString()
                        },
                        {
                            id: Date.now() - 60000,
                            text: 'Cardiology review',
                            priority: 'urgent',
                            date: new Date(Date.now() - 60000).toLocaleString()
                        },
                        {
                            id: Date.now() - 70000,
                            text: 'Discharge planning',
                            priority: 'completed',
                            date: new Date(Date.now() - 70000).toLocaleString()
                        }
                    ],
                    clinicalNotes: [
                        {
                            id: Date.now() - 100000,
                            text: 'Patient admitted with chest pain. ECG shows ST elevation in leads V1-V4. Started on aspirin and referred for urgent angiography.',
                            date: new Date(Date.now() - 100000).toLocaleString()
                        }
                    ],
                    medicalHistory: [
                        {
                            id: Date.now() - 200000,
                            diagnoses: ['Hypertension'],
                            date: new Date(Date.now() - 200000).toLocaleString()
                        },
                        {
                            id: Date.now() - 300000,
                            diagnoses: ['Type 2 Diabetes'],
                            date: new Date(Date.now() - 300000).toLocaleString()
                        }
                    ]
                },
                {
                    id: 'MRN67890',
                    name: 'Sarah Johnson',
                    age: 42,
                    gender: 'F',
                    ward: 'A2-1/05',
                    diagnoses: ['Subarachnoid Hemorrhage', 'Migraine'],
                    tasks: [
                        {
                            id: Date.now() - 55000,
                            text: 'Nimodipine due at 2pm',
                            priority: 'urgent',
                            date: new Date(Date.now() - 55000).toLocaleString()
                        },
                        {
                            id: Date.now() - 65000,
                            text: 'Check Na+',
                            priority: 'normal',
                            date: new Date(Date.now() - 65000).toLocaleString()
                        }
                    ],
                    clinicalNotes: [
                        {
                            id: Date.now() - 400000,
                            text: 'Patient presented with sudden onset headache and neck stiffness. CT scan shows subarachnoid hemorrhage. Neurosurgery consulted.',
                            date: new Date(Date.now() - 400000).toLocaleString()
                        }
                    ],
                    medicalHistory: [
                        {
                            id: Date.now() - 500000,
                            diagnoses: ['Migraine'],
                            date: new Date(Date.now() - 500000).toLocaleString()
                        }
                    ]
                },
                {
                    id: 'MRN24680',
                    name: 'Michael Chen',
                    age: 55,
                    gender: 'M',
                    ward: 'C1-3/08',
                    diagnoses: ['Colorectal Adenocarcinoma', 'Hyperlipidemia'],
                    tasks: [
                        {
                            id: Date.now() - 75000,
                            text: 'Prescribe antiemetics',
                            priority: 'normal',
                            date: new Date(Date.now() - 75000).toLocaleString()
                        },
                        {
                            id: Date.now() - 85000,
                            text: 'Discuss scan results',
                            priority: 'urgent',
                            date: new Date(Date.now() - 85000).toLocaleString()
                        },
                        {
                            id: Date.now() - 95000,
                            text: 'Order CBC',
                            priority: 'completed',
                            date: new Date(Date.now() - 95000).toLocaleString()
                        }
                    ],
                    clinicalNotes: [
                        {
                            id: Date.now() - 600000,
                            text: 'Cycle 3 of FOLFOX chemotherapy administered today. Patient tolerating treatment well with mild peripheral neuropathy.',
                            date: new Date(Date.now() - 600000).toLocaleString()
                        }
                    ],
                    medicalHistory: [
                        {
                            id: Date.now() - 700000,
                            diagnoses: ['Colorectal Adenocarcinoma'],
                            date: new Date(Date.now() - 700000).toLocaleString()
                        },
                        {
                            id: Date.now() - 800000,
                            diagnoses: ['Hyperlipidemia'],
                            date: new Date(Date.now() - 800000).toLocaleString()
                        }
                    ]
                }
            ];
            localStorage.setItem('patients', JSON.stringify(patients));
        }
        
        // DOM Elements
        const patientListView = document.getElementById('patient-list-view');
        const patientDetailView = document.getElementById('patient-detail-view');
        const patientsContainer = document.getElementById('patients-container');
        const patientSearch = document.getElementById('patient-search');
        const addPatientBtn = document.getElementById('add-patient-btn');
        const backToListBtn = document.getElementById('back-to-list-btn');
        const editPatientBtn = document.getElementById('edit-patient-btn');
        const deletePatientBtn = document.getElementById('delete-patient-btn');
        const patientModal = document.getElementById('patient-modal');
        const closeModal = document.querySelector('.close-modal');
        const patientForm = document.getElementById('patient-form');
        const modalTitle = document.getElementById('modal-title');
        const diagnosesContainer = document.getElementById('patient-diagnoses-container');
        const addDiagnosisBtn = document.getElementById('add-diagnosis-btn');
        const taskForm = document.getElementById('task-form');
        const taskInput = document.getElementById('task-input');
        const taskDescriptionInput = document.getElementById('task-description-input');
        const taskPriority = document.getElementById('task-priority');
        const taskFormExpandable = document.getElementById('task-form-expandable');
        const toggleTaskDetailsBtn = document.getElementById('toggle-task-details');
        const tasksList = document.getElementById('tasks-list');
        const clinicalNoteForm = document.getElementById('clinical-note-form');
        const clinicalNoteInput = document.getElementById('clinical-note-input');
        const clinicalNotesList = document.getElementById('clinical-notes-list');
        const medicalHistoryForm = document.getElementById('medical-history-form');
        const diagnosisInput = document.getElementById('diagnosis-input');
        const medicalHistoryList = document.getElementById('medical-history-list');
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // Task Edit Modal Elements
        const taskEditModal = document.getElementById('task-edit-modal');
        const closeTaskModal = document.querySelector('.close-task-modal');
        const editTaskForm = document.getElementById('edit-task-form');
        const editTaskText = document.getElementById('edit-task-text');
        const editTaskDescription = document.getElementById('edit-task-description');
        const editTaskPriority = document.getElementById('edit-task-priority');
        const editTaskType = document.getElementById('edit-task-type');
        let currentEditingTaskId = null;
        
        // Get main tab elements
        const mainTabButtons = document.querySelectorAll('.main-tab-btn');
        const mainViews = document.querySelectorAll('.main-view');
        const allTasksView = document.getElementById('all-tasks-view');
        const allTasksContainer = document.getElementById('all-tasks-container');
        const taskFilter = document.getElementById('task-filter');
        const taskSearch = document.getElementById('task-search');
        
        // At the top of your script section, add these variables and functions
        const themeToggle = document.getElementById('theme-toggle');
        
        // Function to set theme
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            
            // Update theme toggle icon
            if (theme === 'dark') {
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            }
        }
        
        // Check for saved theme preference
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                setTheme(savedTheme);
            } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                // Use dark mode if user prefers dark mode
                setTheme('dark');
            } else {
                // Default to light mode
                setTheme('light');
            }
        }
        
        // Event listener for theme toggle
        themeToggle.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
        });
        
        // Call initTheme at the bottom of your script section, before the initial render
        initTheme();
        
        // Add this function to create patient cards
        function createPatientCard(patient) {
            const patientCard = document.createElement('div');
            patientCard.className = 'patient-card';
            
            // Count tasks by priority
            const taskCounts = {
                normal: 0,
                urgent: 0,
                'in-progress': 0,
                completed: 0
            };
            
            // Get all tasks and sort them by priority and date
            let allTasks = [];
            if (patient.tasks && patient.tasks.length > 0) {
                allTasks = [...patient.tasks].sort((a, b) => {
                    // Urgent tasks first
                    if (a.priority === 'urgent' && b.priority !== 'urgent') return -1;
                    if (a.priority !== 'urgent' && b.priority === 'urgent') return 1;
                    
                    // Then in-progress tasks
                    if (a.priority === 'in-progress' && b.priority !== 'in-progress' && b.priority !== 'urgent') return -1;
                    if (a.priority !== 'in-progress' && a.priority !== 'urgent' && b.priority === 'in-progress') return 1;
                    
                    // Then normal tasks
                    if (a.priority === 'normal' && b.priority === 'completed') return -1;
                    if (a.priority === 'completed' && b.priority === 'normal') return 1;
                    
                    // Within the same priority, sort by date (newest first)
                    return new Date(b.date) - new Date(a.date);
                });
                
                // Count tasks by priority for indicators
                allTasks.forEach(task => {
                    if (taskCounts.hasOwnProperty(task.priority)) {
                        taskCounts[task.priority]++;
                    }
                });
            }
            
            // Get all diagnoses
            let diagnosesHtml = '<div class="diagnoses-container">';
            
            if (patient.diagnoses && patient.diagnoses.length > 0) {
                patient.diagnoses.forEach(diagnosis => {
                    diagnosesHtml += `<div class="diagnosis-badge">${diagnosis}</div>`;
                });
            } else if (patient.diagnosis) {
                // For backward compatibility
                diagnosesHtml += `<div class="diagnosis-badge">${patient.diagnosis}</div>`;
            } else {
                diagnosesHtml += `<div class="diagnosis-badge">No diagnosis</div>`;
            }
            
            diagnosesHtml += '</div>';
            
            // Create the base HTML for the patient card
            patientCard.innerHTML = `
                <div class="patient-card-content">
                    <div class="patient-header">
                        <h3 class="patient-name">${patient.name}</h3>
                        <button class="bloods-button" data-patient-id="${patient.id}" title="Toggle bloods task for tomorrow">
                            <i class="fas fa-vial"></i>
                        </button>
                    </div>
                    <div class="patient-info">
                        <p><span class="info-label">Hospital #:</span> ${patient.id}</p>
                        <p><span class="info-label">Gender:</span> ${patient.gender || 'Not specified'}</p>
                        <p><span class="info-label">Location:</span> ${formatLocation(patient.ward)}</p>
                        <p><span class="info-label">Age/DOB:</span> ${patient.age || '-'} ${patient.dob ? `(${patient.dob})` : ''}</p>
                    </div>
                    ${diagnosesHtml}
                    <div class="patient-tasks-container">
                        <div class="patient-tasks-header">
                            <h4>Tasks</h4>
                            <div class="task-indicators">
                                ${taskCounts.urgent > 0 ? 
                                `<div class="task-indicator">
                                    <span class="task-count urgent">${taskCounts.urgent}</span> Urgent
                                </div>` : ''}
                                ${taskCounts.normal > 0 ? 
                                `<div class="task-indicator">
                                    <span class="task-count normal">${taskCounts.normal}</span> Tasks
                                </div>` : ''}
                                ${taskCounts['in-progress'] > 0 ? 
                                `<div class="task-indicator">
                                    <span class="task-count in-progress">${taskCounts['in-progress']}</span> In Progress
                                </div>` : ''}
                                ${taskCounts.completed > 0 ? 
                                `<div class="task-indicator">
                                    <span class="task-count completed">${taskCounts.completed}</span> Done
                                </div>` : ''}
                            </div>
                        </div>
                        <div class="patient-quick-add-task">
                            <button class="quick-task-toggle-btn" data-patient-id="${patient.id}">
                                <i class="fas fa-plus"></i>
                            </button>
                            <form class="quick-task-form hidden" data-patient-id="${patient.id}">
                                <input type="text" class="quick-task-input" placeholder="Add new task..." required>
                                <div class="quick-task-actions">
                                    <div class="quick-task-selects">
                                        <select class="quick-task-priority">
                                            <option value="normal">Normal</option>
                                            <option value="urgent">Urgent</option>
                                        </select>
                                        <select class="quick-task-type">
                                            <option value="none">No Type</option>
                                            <option value="investigation">Investigation</option>
                                            <option value="bloods">Bloods</option>
                                            <option value="imaging">Imaging</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                    <div class="quick-task-buttons">
                                        <button type="submit" class="quick-task-add-btn">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button type="button" class="quick-task-cancel-btn">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="patient-tasks-list">
                            ${allTasks.length === 0 ? 
                            '<p class="no-tasks-message">No tasks for this patient</p>' : ''}
                        </div>
                    </div>
                    <div class="patient-footer">
                        <button class="view-patient-btn" data-id="${patient.id}">View Details</button>
                    </div>
                </div>
            `;
            
            const tasksList = patientCard.querySelector('.patient-tasks-list');
            
            // If there are tasks, add them to the task list
            if (allTasks.length > 0) {
                // First, add the visible tasks (up to 3)
                const visibleTasks = allTasks.slice(0, 3);
                visibleTasks.forEach(task => {
                    const taskItem = document.createElement('div');
                    taskItem.className = `compact-task-item ${task.priority}`;
                    taskItem.innerHTML = `
                        <div class="compact-task-content">
                            <span class="compact-task-text">
                                ${task.tags && task.tags.includes('investigation') ? '<span class="task-tag investigation">Investigation</span>' : ''}
                                ${task.tags && task.tags.includes('bloods') ? '<span class="task-tag bloods">Bloods</span>' : ''}
                                ${task.isBloodsTask && (!task.tags || !task.tags.includes('bloods')) ? '<span class="task-tag bloods">Bloods</span>' : ''}
                                ${task.tags && task.tags.includes('imaging') ? '<span class="task-tag imaging">Imaging</span>' : ''}
                                ${task.tags && task.tags.includes('other') ? '<span class="task-tag other">Other</span>' : ''}
                                ${task.text}
                            </span>
                            <div class="compact-task-actions">
                                ${task.priority === 'normal' || task.priority === 'urgent' ? 
                                    `<button class="compact-task-complete-btn" data-patient-id="${patient.id}" data-task-id="${task.id}" title="Mark Complete">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="compact-task-progress-btn" data-patient-id="${patient.id}" data-task-id="${task.id}" title="Mark In Progress">
                                        <i class="fas fa-spinner"></i>
                                    </button>` : 
                                 task.priority === 'in-progress' ?
                                    `<button class="compact-task-complete-btn" data-patient-id="${patient.id}" data-task-id="${task.id}" title="Mark Complete">
                                        <i class="fas fa-check"></i>
                                    </button>` :
                                    ''
                                }
                                ${task.priority === 'completed' ? 
                                    `<button class="compact-task-reopen-btn" data-patient-id="${patient.id}" data-task-id="${task.id}" title="Reopen Task">
                                        <i class="fas fa-redo-alt"></i>
                                    </button>` : ''
                                }
                                <button class="compact-task-edit-btn" data-patient-id="${patient.id}" data-task-id="${task.id}" title="Edit Task">
                                    <i class="fas fa-pencil-alt"></i>
                                </button>
                                <button class="compact-task-delete-btn" data-patient-id="${patient.id}" data-task-id="${task.id}" title="Delete Task">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    tasksList.appendChild(taskItem);
                });
                
                // If there are more than 3 tasks, add a button to show more
                if (allTasks.length > 3) {
                    const showMoreBtn = document.createElement('button');
                    showMoreBtn.className = 'show-more-tasks-btn';
                    showMoreBtn.textContent = `Show ${allTasks.length - 3} more tasks`;
                    showMoreBtn.setAttribute('data-expanded', 'false');
                    showMoreBtn.setAttribute('data-patient-id', patient.id);
                    tasksList.appendChild(showMoreBtn);
                    
                    // Create the container for hidden tasks
                    const hiddenTasksContainer = document.createElement('div');
                    hiddenTasksContainer.className = 'hidden-tasks-container';
                    hiddenTasksContainer.style.display = 'none';
                    
                    // Add the remaining tasks to the hidden container
                    const hiddenTasks = allTasks.slice(3);
                    hiddenTasks.forEach(task => {
                        const taskItem = document.createElement('div');
                        taskItem.className = `compact-task-item ${task.priority}`;
                        taskItem.innerHTML = `
                            <div class="compact-task-content">
                                <span class="compact-task-text">
                                    ${task.tags && task.tags.includes('investigation') ? '<span class="task-tag investigation">Investigation</span>' : ''}
                                    ${task.tags && task.tags.includes('bloods') ? '<span class="task-tag bloods">Bloods</span>' : ''}
                                    ${task.isBloodsTask && (!task.tags || !task.tags.includes('bloods')) ? '<span class="task-tag bloods">Bloods</span>' : ''}
                                    ${task.tags && task.tags.includes('imaging') ? '<span class="task-tag imaging">Imaging</span>' : ''}
                                    ${task.tags && task.tags.includes('other') ? '<span class="task-tag other">Other</span>' : ''}
                                    ${task.text}
                                </span>
                                <div class="compact-task-actions">
                                    ${task.priority === 'normal' || task.priority === 'urgent' ? 
                                        `<button class="compact-task-complete-btn" data-patient-id="${patient.id}" data-task-id="${task.id}" title="Mark Complete">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="compact-task-progress-btn" data-patient-id="${patient.id}" data-task-id="${task.id}" title="Mark In Progress">
                                            <i class="fas fa-spinner"></i>
                                        </button>` : 
                                     task.priority === 'in-progress' ?
                                        `<button class="compact-task-complete-btn" data-patient-id="${patient.id}" data-task-id="${task.id}" title="Mark Complete">
                                            <i class="fas fa-check"></i>
                                        </button>` :
                                        ''
                                    }
                                    ${task.priority === 'completed' ? 
                                        `<button class="compact-task-reopen-btn" data-patient-id="${patient.id}" data-task-id="${task.id}" title="Reopen Task">
                                            <i class="fas fa-redo-alt"></i>
                                        </button>` : ''
                                    }
                                    <button class="compact-task-edit-btn" data-patient-id="${patient.id}" data-task-id="${task.id}" title="Edit Task">
                                        <i class="fas fa-pencil-alt"></i>
                                    </button>
                                    <button class="compact-task-delete-btn" data-patient-id="${patient.id}" data-task-id="${task.id}" title="Delete Task">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                        hiddenTasksContainer.appendChild(taskItem);
                    });
                    
                    tasksList.appendChild(hiddenTasksContainer);
                    
                    // Add event listener to toggle hidden tasks
                    showMoreBtn.addEventListener('click', function() {
                        const isExpanded = this.getAttribute('data-expanded') === 'true';
                        if (isExpanded) {
                            hiddenTasksContainer.style.display = 'none';
                            this.textContent = `Show ${allTasks.length - 3} more tasks`;
                            this.setAttribute('data-expanded', 'false');
                        } else {
                            hiddenTasksContainer.style.display = 'block';
                            this.textContent = 'Show less';
                            this.setAttribute('data-expanded', 'true');
                        }
                    });
                }
                
                // Add event listeners for task action buttons
                patientCard.querySelectorAll('.compact-task-complete-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const patientId = this.getAttribute('data-patient-id');
                        const taskId = parseInt(this.getAttribute('data-task-id'));
                        markTaskCompleteFromCard(patientId, taskId);
                    });
                });
                
                patientCard.querySelectorAll('.compact-task-progress-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const patientId = this.getAttribute('data-patient-id');
                        const taskId = parseInt(this.getAttribute('data-task-id'));
                        markTaskInProgressFromCard(patientId, taskId);
                    });
                });
                
                patientCard.querySelectorAll('.compact-task-reopen-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const patientId = this.getAttribute('data-patient-id');
                        const taskId = parseInt(this.getAttribute('data-task-id'));
                        reopenTaskFromCard(patientId, taskId);
                    });
                });
                
                patientCard.querySelectorAll('.compact-task-edit-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const patientId = this.getAttribute('data-patient-id');
                        const taskId = parseInt(this.getAttribute('data-task-id'));
                        showEditTaskModalFromCard(patientId, taskId);
                    });
                });
                
                patientCard.querySelectorAll('.compact-task-delete-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const patientId = this.getAttribute('data-patient-id');
                        const taskId = parseInt(this.getAttribute('data-task-id'));
                        deleteTaskFromCard(patientId, taskId);
                    });
                });
            } else {
                // Add "no tasks" message for empty task list
                const noTasksMessage = document.createElement('p');
                noTasksMessage.className = 'no-tasks-message';
                noTasksMessage.textContent = 'No tasks for this patient';
                tasksList.appendChild(noTasksMessage);
            }
            
            // Add event listener for the quick task toggle button - moved outside of allTasks.length condition
            const quickTaskToggleBtn = patientCard.querySelector('.quick-task-toggle-btn');
            const quickTaskForm = patientCard.querySelector('.quick-task-form');
            
            if (quickTaskToggleBtn && quickTaskForm) {
                // Show form when toggle button is clicked
                quickTaskToggleBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const patientId = this.getAttribute('data-patient-id');
                    quickTaskForm.classList.remove('hidden');
                    quickTaskForm.querySelector('.quick-task-input').focus();
                    this.classList.add('hidden');
                });
                
                // Handle form submission
                quickTaskForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const patientId = this.getAttribute('data-patient-id');
                    const taskText = this.querySelector('.quick-task-input').value.trim();
                    const taskPriority = this.querySelector('.quick-task-priority').value;
                    const taskType = this.querySelector('.quick-task-type').value;
                    
                    if (taskText) {
                        addTaskFromCard(patientId, taskText, taskPriority, taskType);
                        this.querySelector('.quick-task-input').value = '';
                        this.classList.add('hidden');
                        quickTaskToggleBtn.classList.remove('hidden');
                    }
                });
                
                // Handle cancel button click
                const cancelBtn = quickTaskForm.querySelector('.quick-task-cancel-btn');
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        quickTaskForm.classList.add('hidden');
                        quickTaskForm.querySelector('.quick-task-input').value = '';
                        quickTaskToggleBtn.classList.remove('hidden');
                    });
                }
            }
            
            // Add event listener to view button
            patientCard.querySelector('.view-patient-btn').addEventListener('click', function() {
                const patientId = this.getAttribute('data-id');
                showPatientDetails(patientId);
            });
            
            // Add event listener to bloods button
            const bloodsButton = patientCard.querySelector('.bloods-button');
            if (bloodsButton) {
                // Check if there's already a bloods task for tomorrow
                const bloodsTask = findBloodsTaskForTomorrow(patient);
                
                // Update button state based on existing task
                if (bloodsTask) {
                    bloodsButton.classList.add(bloodsTask.priority);
                    bloodsButton.setAttribute('data-task-id', bloodsTask.id);
                }
                
                // Add click event listener
                bloodsButton.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const patientId = this.getAttribute('data-patient-id');
                    const taskId = this.getAttribute('data-task-id');
                    
                    if (taskId) {
                        // Task exists, toggle its status
                        toggleBloodsTaskStatus(patientId, parseInt(taskId));
                    } else {
                        // Create new task
                        createBloodsTask(patientId);
                    }
                });
            }
            
            return patientCard;
        }
        
        // Helper functions for the bloods button feature
        function findBloodsTaskForTomorrow(patient) {
            if (!patient.tasks || !patient.tasks.length) {
                return null;
            }
            
            // Get tomorrow's date in YYYY-MM-DD format
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            
            // Find a task with "bloods for tomorrow" or similar text
            const bloodsTask = patient.tasks.find(task => 
                task.text.toLowerCase().includes("blood") && 
                (task.targetDate === tomorrowStr || task.text.toLowerCase().includes("tomorrow"))
            );
            
            return bloodsTask || null;
        }
        
        function createBloodsTask(patientId) {
            const patientIndex = patients.findIndex(p => p.id === patientId);
            if (patientIndex === -1) return;
            
            // Get tomorrow's date in YYYY-MM-DD format
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            
            // Create new task
            const taskId = Date.now();
            const newTask = {
                id: taskId,
                text: "Bloods for tomorrow",
                description: "Patient needs blood tests for tomorrow. Click to add specific tests required.",
                priority: "normal",
                date: new Date().toLocaleString(),
                targetDate: tomorrowStr,
                isBloodsTask: true,
                tags: ["investigation", "bloods"]  // Add tags to identify task type and category
            };
            
            // Ensure patient has a tasks array
            if (!patients[patientIndex].tasks) {
                patients[patientIndex].tasks = [];
            }
            
            // Add the new task
            patients[patientIndex].tasks.push(newTask);
            
            // Save changes
            localStorage.setItem('patients', JSON.stringify(patients));
            
            // Update the button state
            updateBloodsButtonState(patientId, taskId, "normal");
            
            // Re-render the patient list to show the updated task
            renderPatientList();
        }
        
        function toggleBloodsTaskStatus(patientId, taskId) {
            const patientIndex = patients.findIndex(p => p.id === patientId);
            if (patientIndex === -1) return;
            
            const taskIndex = patients[patientIndex].tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;
            
            const currentStatus = patients[patientIndex].tasks[taskIndex].priority;
            let newStatus;
            
            // Cycle through statuses: normal → in-progress → completed → [delete task]
            if (currentStatus === 'normal') {
                newStatus = 'in-progress';
                patients[patientIndex].tasks[taskIndex].progressDate = new Date().toLocaleString();
                
                // Update the task priority and save
                patients[patientIndex].tasks[taskIndex].priority = newStatus;
                localStorage.setItem('patients', JSON.stringify(patients));
                
                // Update the button state
                updateBloodsButtonState(patientId, taskId, newStatus);
            } else if (currentStatus === 'in-progress') {
                newStatus = 'completed';
                patients[patientIndex].tasks[taskIndex].completedDate = new Date().toLocaleString();
                
                // Update the task priority and save
                patients[patientIndex].tasks[taskIndex].priority = newStatus;
                localStorage.setItem('patients', JSON.stringify(patients));
                
                // Update the button state
                updateBloodsButtonState(patientId, taskId, newStatus);
            } else if (currentStatus === 'completed') {
                // Delete the task instead of cycling back to normal
                patients[patientIndex].tasks = patients[patientIndex].tasks.filter(t => t.id !== taskId);
                localStorage.setItem('patients', JSON.stringify(patients));
                
                // Reset the button state
                const button = document.querySelector(`.bloods-button[data-patient-id="${patientId}"]`);
                if (button) {
                    button.classList.remove('normal', 'in-progress', 'completed');
                    button.removeAttribute('data-task-id');
                }
            }
            
            // Re-render the patient list to show the updated task
            renderPatientList();
        }
        
        function updateBloodsButtonState(patientId, taskId, status) {
            // Find the button element
            const button = document.querySelector(`.bloods-button[data-patient-id="${patientId}"]`);
            if (!button) return;
            
            // Remove existing status classes
            button.classList.remove('normal', 'in-progress', 'completed');
            
            // Add the new status class
            button.classList.add(status);
            
            // Set the task ID as a data attribute
            button.setAttribute('data-task-id', taskId);
        }
        
        // Render patient list
        function renderPatientList(searchTerm = '') {
            // Group patients by ward
            const patientsByWard = {};
            
            patients.forEach(patient => {
                if (!patient.ward) {
                    // If no ward, place in 'Unassigned' group
                    if (!patientsByWard['Unassigned']) {
                        patientsByWard['Unassigned'] = [];
                    }
                    patientsByWard['Unassigned'].push(patient);
                    return;
                }
                
                // Extract the ward name from location string
                let wardName;
                
                // For ward/bed format (e.g., "B4/12")
                if (patient.ward.includes('/')) {
                    wardName = patient.ward.split('/')[0];
                } 
                // For ward-room-bed format (e.g., "B4-3/12")
                else if (patient.ward.includes('-')) {
                    wardName = patient.ward.split('-')[0];
                }
                // For simple ward name (e.g., "B4")
                else {
                    wardName = patient.ward;
                }
                
                // Remove "Ward " prefix if it exists
                wardName = wardName.replace(/^Ward\s+/i, '');
                
                if (!patientsByWard[wardName]) {
                    patientsByWard[wardName] = [];
                }
                patientsByWard[wardName].push(patient);
            });
            
            // Clear the container
            patientsContainer.innerHTML = '';
            
            // Create and display wards
            Object.keys(patientsByWard).sort().forEach(ward => {
                const wardPatients = patientsByWard[ward];
                
                // Filter patients if search term is provided
                const filteredPatients = searchTerm 
                    ? wardPatients.filter(patient => {
                        // Check in patient name or ID
                        if (patient.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                            patient.id.toLowerCase().includes(searchTerm.toLowerCase())) {
                            return true;
                        }
                        
                        // Check in diagnoses array
                        if (patient.diagnoses && patient.diagnoses.length > 0) {
                            return patient.diagnoses.some(diagnosis => 
                                diagnosis.toLowerCase().includes(searchTerm.toLowerCase()));
                        }
                        
                        // Backward compatibility for old data structure
                        if (patient.diagnosis) {
                            return patient.diagnosis.toLowerCase().includes(searchTerm.toLowerCase());
                        }
                        
                        return false;
                    })
                    : wardPatients;
                
                // Sort patients by room and bed number within the ward
                filteredPatients.sort((a, b) => {
                    // Handle empty ward fields
                    const aLocation = a.ward || '';
                    const bLocation = b.ward || '';
                    
                    // Function to parse ward/room/bed from location string
                    const parseLocation = (locationString) => {
                        // Initialize result object
                        const result = {
                            ward: '',
                            room: 0,
                            bed: 0
                        };
                        
                        // Common formats: 
                        // - "B4/12" (Ward B4, Bed 12)
                        // - "B4-3/12" (Ward B4, Room 3, Bed 12)
                        // - "Ward B4 Room 3 Bed 12"
                        
                        // First, extract any ward identifier (letters possibly followed by numbers)
                        const wardMatch = locationString.match(/([A-Za-z]+\d*)/);
                        if (wardMatch) {
                            result.ward = wardMatch[1];
                        }
                        
                        // Try to match room-bed pattern like "B4-3/12"
                        const roomBedMatch = locationString.match(/[A-Za-z]*\d*-(\d+)\/(\d+)/);
                        if (roomBedMatch) {
                            result.room = parseInt(roomBedMatch[1], 10);
                            result.bed = parseInt(roomBedMatch[2], 10);
                            return result;
                        }
                        
                        // Try to match explicit "Room X Bed Y" pattern
                        const explicitMatch = locationString.match(/Room\s+(\d+)\s+Bed\s+(\d+)/i);
                        if (explicitMatch) {
                            result.room = parseInt(explicitMatch[1], 10);
                            result.bed = parseInt(explicitMatch[2], 10);
                            return result;
                        }
                        
                        // Try to match simple ward/bed pattern like "B4/12"
                        const simpleBedMatch = locationString.match(/\/(\d+)$/);
                        if (simpleBedMatch) {
                            // When only ward and bed are specified, use 0 for room sorting
                            result.bed = parseInt(simpleBedMatch[1], 10);
                            return result;
                        }
                        
                        // Fall back to checking for any numbers as room/bed
                        const numbers = locationString.match(/\d+/g);
                        if (numbers && numbers.length >= 2) {
                            // Assume last two numbers are room and bed
                            result.room = parseInt(numbers[numbers.length - 2], 10);
                            result.bed = parseInt(numbers[numbers.length - 1], 10);
                        } else if (numbers && numbers.length === 1) {
                            // Assume single number is the bed
                            result.bed = parseInt(numbers[0], 10);
                        }
                        
                        return result;
                    };
                    
                    // Parse locations for both patients
                    const aLoc = parseLocation(aLocation);
                    const bLoc = parseLocation(bLocation);
                    
                    // First sort by room number
                    if (aLoc.room !== bLoc.room) {
                        return aLoc.room - bLoc.room;
                    }
                    
                    // Then sort by bed number
                    return aLoc.bed - bLoc.bed;
                });
                    
                if (filteredPatients.length === 0) return;
                
                const wardGroup = document.createElement('div');
                wardGroup.className = 'ward-group';
                
                const wardHeader = document.createElement('div');
                wardHeader.className = 'ward-header';
                wardHeader.innerHTML = `<i class="fas fa-hospital"></i> ${ward}`;
                
                wardGroup.appendChild(wardHeader);
                
                // Add patients for this ward
                filteredPatients.forEach(patient => {
                    // Create patient card
                    const patientCard = createPatientCard(patient);
                    wardGroup.appendChild(patientCard);
                });
                
                patientsContainer.appendChild(wardGroup);
            });
            
            // Show message if no patients found
            if (patientsContainer.children.length === 0) {
                patientsContainer.innerHTML = '<p class="no-items">No patients found. Add a patient or adjust your search.</p>';
            }
        }
        
        // Show patient details
        function showPatientDetails(patientId) {
            currentPatientId = patientId;
            const patient = patients.find(p => p.id === patientId);
            
            if (!patient) return;
            
            // Update patient info
            document.getElementById('patient-name-header').textContent = patient.name;
            document.getElementById('patient-id').textContent = patient.id;
            document.getElementById('patient-age').textContent = patient.age || 'Not specified';
            document.getElementById('patient-gender').textContent = patient.gender || 'Not specified';
            document.getElementById('patient-ward').textContent = formatLocation(patient.ward);
            
            // Format diagnoses for display
            let diagnosesText = 'None';
            if (patient.diagnoses && patient.diagnoses.length > 0) {
                diagnosesText = patient.diagnoses.join(', ');
            } else if (patient.diagnosis) {
                // For backward compatibility with older data structure
                diagnosesText = patient.diagnosis;
            }
            document.getElementById('patient-diagnoses').textContent = diagnosesText;
            
            // Show patient detail view FIRST, then render components
            patientListView.classList.add('hidden');
            allTasksView.classList.add('hidden');
            patientDetailView.classList.remove('hidden');
            
            // Now render everything with the patient
            renderTasks(patient);
            renderClinicalNotes(patient);
            renderMedicalHistory(patient);
            renderSocialHistory(patient);
            
            // Reset to tasks tab
            document.querySelector('.tab-btn[data-tab="tasks"]').click();
        }
        
        // Render tasks
        function renderTasks(patient) {
            const tasksList = document.getElementById('tasks-list');
            tasksList.innerHTML = '';
            
            // Make sure we have a valid patient
            if (!patient) {
                tasksList.innerHTML = '<p class="no-items">No tasks available.</p>';
                return;
            }
            
            if (!patient.tasks || patient.tasks.length === 0) {
                tasksList.innerHTML = '<p class="no-items">No tasks yet. Add a task above.</p>';
                return;
            }
            
            // Group tasks by status
            const normalTasks = patient.tasks.filter(task => 
                task.priority === 'normal' || task.priority === 'urgent');
            const inProgressTasks = patient.tasks.filter(task => 
                task.priority === 'in-progress');
            const completedTasks = patient.tasks.filter(task => 
                task.priority === 'completed');
            
            // Normal Tasks Section
            if (normalTasks.length > 0) {
                const normalSection = document.createElement('div');
                normalSection.className = 'task-status-section';
                normalSection.innerHTML = `<h4><i class="fas fa-clipboard-list"></i> Pending Tasks</h4>`;
                
                // Sort by urgency then date
                normalTasks.sort((a, b) => {
                    if (a.priority === 'urgent' && b.priority !== 'urgent') return -1;
                    if (a.priority !== 'urgent' && b.priority === 'urgent') return 1;
                    return new Date(b.date) - new Date(a.date);
                });
                
                normalTasks.forEach(task => {
                    const taskItem = document.createElement('div');
                    taskItem.className = `task-item ${task.priority}`;
                    taskItem.innerHTML = `
                        <div class="task-content">
                            <div class="task-text">
                                ${task.tags && task.tags.includes('bloods') ? '<span class="task-tag bloods">Bloods</span>' : ''}
                                ${task.isBloodsTask && (!task.tags || !task.tags.includes('bloods')) ? '<span class="task-tag bloods">Bloods</span>' : ''}
                                ${task.text}
                            </div>
                            ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                            <div class="task-date">${task.date}</div>
                        </div>
                        <div class="task-actions">
                            <button class="edit-task-btn" data-id="${task.id}" title="Edit Task">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="toggle-task-status-btn" data-id="${task.id}" data-status="normal" data-next-state="Mark In Progress" title="Toggle Status">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="complete-task-btn" data-id="${task.id}" title="Mark Complete">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="delete-task-btn" data-id="${task.id}" title="Delete Task">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    `;
                    normalSection.appendChild(taskItem);
                });
                
                tasksList.appendChild(normalSection);
            }
            
            // In Progress Tasks Section
            if (inProgressTasks.length > 0) {
                const progressSection = document.createElement('div');
                progressSection.className = 'task-status-section';
                progressSection.innerHTML = `<h4><i class="fas fa-spinner"></i> In Progress</h4>`;
                
                inProgressTasks.forEach(task => {
                    const taskItem = document.createElement('div');
                    taskItem.className = `task-item in-progress`;
                    taskItem.innerHTML = `
                        <div class="task-content">
                            <div class="task-text">
                                ${task.tags && task.tags.includes('bloods') ? '<span class="task-tag bloods">Bloods</span>' : ''}
                                ${task.isBloodsTask && (!task.tags || !task.tags.includes('bloods')) ? '<span class="task-tag bloods">Bloods</span>' : ''}
                                ${task.text}
                            </div>
                            ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                            <div class="task-date">${task.progressDate || task.date}</div>
                        </div>
                        <div class="task-actions">
                            <button class="edit-task-btn" data-id="${task.id}" title="Edit Task">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="toggle-task-status-btn" data-id="${task.id}" data-status="in-progress" data-next-state="Mark Complete" title="Toggle Status">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="delete-task-btn" data-id="${task.id}" title="Delete Task">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    `;
                    progressSection.appendChild(taskItem);
                });
                
                tasksList.appendChild(progressSection);
            }
            
            // Completed Tasks Section
            if (completedTasks.length > 0) {
                const completedSection = document.createElement('div');
                completedSection.className = 'task-status-section';
                completedSection.innerHTML = `<h4><i class="fas fa-check-circle"></i> Completed</h4>`;
                
                completedTasks.forEach(task => {
                    const taskItem = document.createElement('div');
                    taskItem.className = `task-item completed`;
                    taskItem.innerHTML = `
                        <div class="task-content">
                            <div class="task-text">
                                ${task.tags && task.tags.includes('bloods') ? '<span class="task-tag bloods">Bloods</span>' : ''}
                                ${task.isBloodsTask && (!task.tags || !task.tags.includes('bloods')) ? '<span class="task-tag bloods">Bloods</span>' : ''}
                                ${task.text}
                            </div>
                            ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                            <div class="task-date">${task.completedDate || task.date}</div>
                        </div>
                        <div class="task-actions">
                            <button class="edit-task-btn" data-id="${task.id}" title="Edit Task">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="toggle-task-status-btn" data-id="${task.id}" data-status="completed" data-next-state="Reopen Task" title="Toggle Status">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="delete-task-btn" data-id="${task.id}" title="Delete Task">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    `;
                    completedSection.appendChild(taskItem);
                });
                
                tasksList.appendChild(completedSection);
            }
            
            // Add event listeners for the buttons
            document.querySelectorAll('#tasks-list .toggle-task-status-btn').forEach(button => {
                button.addEventListener('click', toggleTaskStatus);
            });
            
            document.querySelectorAll('#tasks-list .delete-task-btn').forEach(button => {
                button.addEventListener('click', deleteTask);
            });
            
            document.querySelectorAll('#tasks-list .edit-task-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const taskId = parseInt(this.getAttribute('data-id'));
                    showEditTaskModal(taskId);
                });
            });
            
            document.querySelectorAll('#tasks-list .complete-task-btn').forEach(button => {
                button.addEventListener('click', markTaskComplete);
            });
        }
        
        // New function to toggle task status in a cycle
        function toggleTaskStatus() {
            const taskId = parseInt(this.getAttribute('data-id'));
            const currentStatus = this.getAttribute('data-status');
            const patient = patients.find(p => p.id === currentPatientId);
            
            if (!patient) return;
            
            const taskIndex = patient.tasks.findIndex(task => task.id === taskId);
            if (taskIndex === -1) return;
            
            // Cycle through statuses: normal → in-progress → completed → normal
            if (currentStatus === 'normal' || currentStatus === 'urgent') {
                // Move to in-progress
                patient.tasks[taskIndex].priority = 'in-progress';
                patient.tasks[taskIndex].progressDate = new Date().toLocaleString();
            } else if (currentStatus === 'in-progress') {
                // Move to completed
                patient.tasks[taskIndex].priority = 'completed';
                patient.tasks[taskIndex].completedDate = new Date().toLocaleString();
            } else if (currentStatus === 'completed') {
                // Move back to normal
                patient.tasks[taskIndex].priority = 'normal';
                delete patient.tasks[taskIndex].completedDate;
                delete patient.tasks[taskIndex].progressDate;
            }
            
            localStorage.setItem('patients', JSON.stringify(patients));
            renderTasks(patient);
        }
        
        // Function to mark a task as complete directly from pending
        function markTaskComplete() {
            const taskId = parseInt(this.getAttribute('data-id'));
            const patient = patients.find(p => p.id === currentPatientId);
            
            if (!patient) return;
            
            const taskIndex = patient.tasks.findIndex(task => task.id === taskId);
            if (taskIndex === -1) return;
            
            // Set directly to completed
            patient.tasks[taskIndex].priority = 'completed';
            patient.tasks[taskIndex].completedDate = new Date().toLocaleString();
            
            localStorage.setItem('patients', JSON.stringify(patients));
            renderTasks(patient);
        }
        
        // Render clinical notes
        function renderClinicalNotes(patient) {
            clinicalNotesList.innerHTML = '';
            
            if (!patient.clinicalNotes || patient.clinicalNotes.length === 0) {
                clinicalNotesList.innerHTML = '<p class="no-notes">No clinical notes yet.</p>';
                return;
            }
            
            // Sort notes by date (newest first)
            const sortedNotes = [...patient.clinicalNotes].sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );
            
            sortedNotes.forEach(note => {
                const noteElement = document.createElement('div');
                noteElement.className = 'note';
                noteElement.innerHTML = `
                    <div class="note-header">
                        <span class="note-date">${note.date}</span>
                        <div class="note-actions">
                            <button class="edit-note-btn" data-id="${note.id}" title="Edit Note">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-note-btn" data-id="${note.id}" title="Delete Note">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                    <p class="note-text">${note.text}</p>
                `;
                clinicalNotesList.appendChild(noteElement);
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-note-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const noteId = parseInt(this.getAttribute('data-id'));
                    deleteClinicalNote(noteId);
                });
            });
            
            // Add event listeners to edit buttons
            document.querySelectorAll('.edit-note-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const noteId = parseInt(this.getAttribute('data-id'));
                    showEditNoteModal(noteId);
                });
            });
        }
        
        // Render medical history
        function renderMedicalHistory(patient) {
            medicalHistoryList.innerHTML = '';
            
            if (!patient.medicalHistory || patient.medicalHistory.length === 0) {
                medicalHistoryList.innerHTML = '<p class="no-notes">No diagnoses recorded.</p>';
                return;
            }
            
            patient.medicalHistory.forEach(item => {
                const historyElement = document.createElement('div');
                historyElement.className = 'diagnosis-item';
                historyElement.innerHTML = `
                    <div class="diagnosis-header">
                        <span class="diagnosis-text">${item.diagnosis}</span>
                        <div class="diagnosis-actions">
                            <button class="edit-diagnosis-btn" data-id="${item.id}" title="Edit Diagnosis">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-diagnosis-btn" data-id="${item.id}" title="Delete Diagnosis">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                `;
                medicalHistoryList.appendChild(historyElement);
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-diagnosis-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const diagnosisId = parseInt(this.getAttribute('data-id'));
                    deleteDiagnosis(diagnosisId);
                });
            });
            
            // Add event listeners to edit buttons
            document.querySelectorAll('.edit-diagnosis-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const diagnosisId = parseInt(this.getAttribute('data-id'));
                    showEditDiagnosisModal(diagnosisId);
                });
            });
        }
        
        // Render social history
        function renderSocialHistory(patient) {
            const socialHistoryList = document.getElementById('social-history-list');
            socialHistoryList.innerHTML = '';
            
            if (!patient.socialHistory || patient.socialHistory.length === 0) {
                socialHistoryList.innerHTML = '<p class="no-notes">No social history recorded.</p>';
                return;
            }
            
            patient.socialHistory.forEach(item => {
                const historyElement = document.createElement('div');
                historyElement.className = 'social-history-item';
                historyElement.innerHTML = `
                    <div class="social-history-header">
                        <span class="social-history-text">${item.text}</span>
                        <div class="social-history-actions">
                            <button class="edit-social-history-btn" data-id="${item.id}" title="Edit Social History">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-social-history-btn" data-id="${item.id}" title="Delete Social History">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                `;
                socialHistoryList.appendChild(historyElement);
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-social-history-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const socialHistoryId = parseInt(this.getAttribute('data-id'));
                    deleteSocialHistory(socialHistoryId);
                });
            });
            
            // Add event listeners to edit buttons
            document.querySelectorAll('.edit-social-history-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const socialHistoryId = parseInt(this.getAttribute('data-id'));
                    showEditSocialHistoryModal(socialHistoryId);
                });
            });
        }
        
        // Add task
        function addTask(e) {
            e.preventDefault();
            const text = taskInput.value.trim();
            const description = taskDescriptionInput.value.trim();
            const priority = taskPriority.value;
            const taskType = document.getElementById('task-type').value;
            
            if (text && currentPatientId) {
                const patientIndex = patients.findIndex(p => p.id === currentPatientId);
                
                if (patientIndex === -1) return;
                
                const newTask = {
                    id: Date.now(),
                    text,
                    description,
                    priority,
                    date: new Date().toLocaleString(),
                    tags: []
                };
                
                if (!patients[patientIndex].tasks) {
                    patients[patientIndex].tasks = [];
                }
                
                // Handle task type from selection
                if (taskType !== 'none') {
                    // Add tags based on selected type
                    if (taskType === 'investigation' || taskType === 'bloods' || taskType === 'imaging' || taskType === 'other') {
                        if (!newTask.tags.includes('investigation')) {
                            newTask.tags.push('investigation');
                        }
                        
                        if (taskType !== 'investigation') {
                            newTask.tags.push(taskType);
                        }
                        
                        // Set isBloodsTask for bloods
                        if (taskType === 'bloods') {
                            newTask.isBloodsTask = true;
                        }
                    }
                } 
                // Auto-detect type from text if no type was selected
                else {
                    // Convert to lowercase for consistent matching
                    const lowercaseText = text.toLowerCase();
                    // Use regular expressions with word boundaries for accurate matching
                    const isBloodTask = /\b(blood|fbc|cbc|hb|hgb|wcc|plt|u&e|lft|lfts|coag|bnp|trop|troponin)\b/.test(lowercaseText);
                    const isImagingTask = /\b(xray|x-ray|ultrasound|scan|mri|ct scan|cat scan|pet|imaging|radiology)\b/.test(lowercaseText);
                    
                    if (isBloodTask || isImagingTask) {
                        // Add investigation tag
                        if (!newTask.tags.includes('investigation')) {
                            newTask.tags.push('investigation');
                        }
                        
                        // Add specific tag based on content
                        if (isBloodTask) {
                            if (!newTask.tags.includes('bloods')) {
                                newTask.tags.push('bloods');
                            }
                            newTask.isBloodsTask = true;
                        } else if (isImagingTask) {
                            if (!newTask.tags.includes('imaging')) {
                                newTask.tags.push('imaging');
                            }
                        }
                    }
                }
                
                patients[patientIndex].tasks.push(newTask);
                localStorage.setItem('patients', JSON.stringify(patients));
                
                // Reset form
                taskInput.value = '';
                taskDescriptionInput.value = '';
                taskPriority.value = 'normal';
                document.getElementById('task-type').value = 'none';
                
                // Hide the description if it's expanded
                const descriptionContainer = document.querySelector('.task-description-container');
                if (descriptionContainer.classList.contains('expanded')) {
                    toggleTaskDetails();
                }
                
                renderTasks(patients[patientIndex]);
            }
        }
        
        // Delete task
        function deleteTask() {
            const taskId = parseInt(this.getAttribute('data-id'));
            const patient = patients.find(p => p.id === currentPatientId);
            
            if (!patient) return;
            
            // Find the task index and remove it
            const taskIndex = patient.tasks.findIndex(task => task.id === taskId);
            if (taskIndex !== -1) {
                // Confirm before deleting
                if (confirm('Are you sure you want to delete this task?')) {
                    patient.tasks.splice(taskIndex, 1);
                    localStorage.setItem('patients', JSON.stringify(patients));
                    renderTasks(patient);
                }
            }
        }
        
        // Add clinical note
        function addClinicalNote(e) {
            e.preventDefault();
            const text = clinicalNoteInput.value.trim();
            
            if (text && currentPatientId) {
                const patientIndex = patients.findIndex(p => p.id === currentPatientId);
                
                if (patientIndex === -1) return;
                
                const newNote = {
                    id: Date.now(),
                    text,
                    date: new Date().toLocaleString()
                };
                
                if (!patients[patientIndex].clinicalNotes) {
                    patients[patientIndex].clinicalNotes = [];
                }
                
                patients[patientIndex].clinicalNotes.push(newNote);
                localStorage.setItem('patients', JSON.stringify(patients));
                clinicalNoteInput.value = '';
                renderClinicalNotes(patients[patientIndex]);
            }
        }
        
        // Delete clinical note
        function deleteClinicalNote(noteId) {
            const patientIndex = patients.findIndex(p => p.id === currentPatientId);
            
            if (patientIndex === -1) return;
            
            patients[patientIndex].clinicalNotes = patients[patientIndex].clinicalNotes.filter(
                note => note.id !== noteId
            );
            
            localStorage.setItem('patients', JSON.stringify(patients));
            renderClinicalNotes(patients[patientIndex]);
        }
        
        // Add diagnosis to medical history
        function addDiagnosis(e) {
            e.preventDefault();
            const diagnosis = diagnosisInput.value.trim();
            
            if (diagnosis && currentPatientId) {
                const patientIndex = patients.findIndex(p => p.id === currentPatientId);
                
                if (patientIndex === -1) return;
                
                const newDiagnosis = {
                    id: Date.now(),
                    diagnosis,
                    date: new Date().toLocaleString()
                };
                
                if (!patients[patientIndex].medicalHistory) {
                    patients[patientIndex].medicalHistory = [];
                }
                
                patients[patientIndex].medicalHistory.push(newDiagnosis);
                localStorage.setItem('patients', JSON.stringify(patients));
                diagnosisInput.value = '';
                renderMedicalHistory(patients[patientIndex]);
            }
        }
        
        // Delete diagnosis
        function deleteDiagnosis(diagnosisId) {
            const patientIndex = patients.findIndex(p => p.id === currentPatientId);
            
            if (patientIndex === -1) return;
            
            patients[patientIndex].medicalHistory = patients[patientIndex].medicalHistory.filter(
                item => item.id !== diagnosisId
            );
            
            localStorage.setItem('patients', JSON.stringify(patients));
            renderMedicalHistory(patients[patientIndex]);
        }
        
        // Add social history
        function addSocialHistory(e) {
            e.preventDefault();
            const text = document.getElementById('social-history-input').value.trim();
            
            if (text && currentPatientId) {
                const patientIndex = patients.findIndex(p => p.id === currentPatientId);
                
                if (patientIndex === -1) return;
                
                const newItem = {
                    id: Date.now(),
                    text,
                    date: new Date().toLocaleString()
                };
                
                if (!patients[patientIndex].socialHistory) {
                    patients[patientIndex].socialHistory = [];
                }
                
                patients[patientIndex].socialHistory.push(newItem);
                localStorage.setItem('patients', JSON.stringify(patients));
                document.getElementById('social-history-input').value = '';
                renderSocialHistory(patients[patientIndex]);
            }
        }
        
        // Delete social history
        function deleteSocialHistory(socialHistoryId) {
            const patientIndex = patients.findIndex(p => p.id === currentPatientId);
            
            if (patientIndex === -1) return;
            
            patients[patientIndex].socialHistory = patients[patientIndex].socialHistory.filter(
                item => item.id !== socialHistoryId
            );
            
            localStorage.setItem('patients', JSON.stringify(patients));
            renderSocialHistory(patients[patientIndex]);
        }
        
        // Show add patient modal
        function showAddPatientModal() {
            modalTitle.textContent = 'Add New Patient';
            patientForm.reset();
            patientModal.classList.remove('hidden');
        }
        
        // Show edit patient modal
        function showEditPatientModal() {
            const patient = patients.find(p => p.id === currentPatientId);
            
            if (!patient) return;
            
            modalTitle.textContent = 'Edit Patient';
            document.getElementById('patient-name-input').value = patient.name;
            document.getElementById('patient-id-input').value = patient.id;
            document.getElementById('patient-dob-input').value = patient.dob || '';
            document.getElementById('patient-gender-input').value = patient.gender;
            
            // Update the calculated age
            if (patient.dob) {
                updateCalculatedAge(patient.dob);
            }
            
            // Set location form values based on patient's location
            setLocationFormValues(patient.ward);
            document.getElementById('patient-ward-input').value = patient.ward || '';
            
            // Clear existing diagnosis inputs except the first one
            diagnosesContainer.innerHTML = '';
            
            // Add diagnosis inputs based on patient data
            if (patient.diagnoses && patient.diagnoses.length > 0) {
                patient.diagnoses.forEach((diagnosis, index) => {
                    addDiagnosisInput(diagnosis);
                });
            } else if (patient.diagnosis) {
                // For backward compatibility
                addDiagnosisInput(patient.diagnosis);
            } else {
                // Add an empty diagnosis input if none exist
                addDiagnosisInput('');
            }
            
            patientModal.classList.remove('hidden');
        }
        
        // Function to add a diagnosis input field
        function addDiagnosisInput(value = '') {
            const diagnosisGroup = document.createElement('div');
            diagnosisGroup.className = 'diagnosis-input-group';
            diagnosisGroup.innerHTML = `
                <input type="text" class="diagnosis-input styled-input" placeholder="Enter diagnosis" value="${value}">
                <button type="button" class="remove-diagnosis-btn"><i class="fas fa-times"></i></button>
            `;
            
            diagnosesContainer.appendChild(diagnosisGroup);
            
            // Add event listener to remove button
            const removeBtn = diagnosisGroup.querySelector('.remove-diagnosis-btn');
            removeBtn.addEventListener('click', function() {
                // Don't remove if it's the last diagnosis field
                if (diagnosesContainer.querySelectorAll('.diagnosis-input-group').length > 1) {
                    diagnosisGroup.remove();
                }
            });
        }
        
        // Function to calculate age from DOB
        function calculateAge(dob) {
            if (!dob) return '';
            
            const dobDate = new Date(dob);
            const now = new Date();
            
            let age = now.getFullYear() - dobDate.getFullYear();
            const monthDiff = now.getMonth() - dobDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && now.getDate() < dobDate.getDate())) {
                age--;
            }
            
            return age;
        }
        
        // Function to update calculated age display
        function updateCalculatedAge(dob) {
            const calculatedAgeElement = document.getElementById('calculated-age');
            if (calculatedAgeElement) {
                const age = calculateAge(dob);
                calculatedAgeElement.textContent = age ? age : 'Not set';
            }
        }
        
        // Save patient (add or edit)
        function savePatient(e) {
            e.preventDefault();
            
            // Collect diagnoses from all input fields
            const diagnoses = [];
            document.querySelectorAll('.diagnosis-input').forEach(input => {
                const value = input.value.trim();
                if (value) {
                    diagnoses.push(value);
                }
            });
            
            // Get DOB and calculate age
            const dob = document.getElementById('patient-dob-input').value;
            const age = calculateAge(dob);
            
            const patientData = {
                name: document.getElementById('patient-name-input').value,
                id: document.getElementById('patient-id-input').value,
                dob: dob,
                age: age,
                gender: document.getElementById('patient-gender-input').value || '',
                ward: document.getElementById('patient-ward-input').value || '',
                diagnoses: diagnoses
            };
            
            if (modalTitle.textContent === 'Edit Patient') {
                // Edit existing patient
                const patientIndex = patients.findIndex(p => p.id === currentPatientId);
                
                if (patientIndex === -1) return;
                
                // Preserve notes, tasks and medical history
                patientData.tasks = patients[patientIndex].tasks || [];
                patientData.clinicalNotes = patients[patientIndex].clinicalNotes || [];
                patientData.medicalHistory = patients[patientIndex].medicalHistory || [];
                
                patients[patientIndex] = patientData;
                
                // Update current patient ID in case hospital number changed
                currentPatientId = patientData.id;
                
                // Update patient details view
                document.getElementById('patient-name-header').textContent = patientData.name;
                document.getElementById('patient-id').textContent = patientData.id;
                document.getElementById('patient-age').textContent = patientData.age || 'Not specified';
                document.getElementById('patient-gender').textContent = patientData.gender || 'Not specified';
                document.getElementById('patient-ward').textContent = patientData.ward || 'Not specified';
                document.getElementById('patient-diagnoses').textContent = patientData.diagnoses.length > 0 ? patientData.diagnoses.join(', ') : 'None';
            } else {
                // Add new patient
                patientData.tasks = [];
                patientData.clinicalNotes = [];
                patientData.medicalHistory = [];
                patients.push(patientData);
            }
            
            localStorage.setItem('patients', JSON.stringify(patients));
            patientModal.classList.add('hidden');
            renderPatientList();
        }
        
        // Delete patient
        function deletePatient() {
            const confirmDialog = document.createElement('div');
            confirmDialog.className = 'confirm-dialog';
            confirmDialog.innerHTML = `
                <div class="confirm-dialog-content">
                    <h3>Delete Patient</h3>
                    <p>Are you sure you want to delete this patient and all their data? This action cannot be undone.</p>
                    <div class="confirm-dialog-actions">
                        <button class="secondary-btn" id="cancel-delete">Cancel</button>
                        <button class="danger-btn" id="confirm-delete">Delete</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmDialog);
            
            document.getElementById('cancel-delete').addEventListener('click', () => {
                document.body.removeChild(confirmDialog);
            });
            
            document.getElementById('confirm-delete').addEventListener('click', () => {
                // Actual deletion logic
                patients = patients.filter(p => p.id !== currentPatientId);
                localStorage.setItem('patients', JSON.stringify(patients));
                document.body.removeChild(confirmDialog);
                
                patientDetailView.classList.add('hidden');
                patientListView.classList.remove('hidden');
                renderPatientList();
            });
        }
        
        // Search patients
        function searchPatients() {
            const searchTerm = this.value.trim().toLowerCase();
            renderPatientList(searchTerm);
        }
        
        // Function to render all tasks
        function renderAllTasks(filters = ['normal', 'urgent', 'in-progress', 'completed'], searchTerm = '', taskTypeFilter = 'all') {
            allTasksContainer.innerHTML = '';
            
            // Group tasks by ward and completion status
            const tasksByWard = {};
            let totalTasksFound = 0;
            
            patients.forEach(patient => {
                if (!patient.tasks || patient.tasks.length === 0) return;
                
                // Handle case where patient.ward might be undefined
                const wardName = patient.ward ? patient.ward.split('/')[0] : 'Unassigned'; // Extract ward part
                
                if (!tasksByWard[wardName]) {
                    tasksByWard[wardName] = {
                        pending: [],
                        'in-progress': [],
                        completed: []
                    };
                }
                
                patient.tasks.forEach(task => {
                    // Apply multi-selection filters
                    if (filters.length > 0) {
                        // Handle 'normal' and 'urgent' as pending tasks
                        if (task.priority === 'normal' || task.priority === 'urgent') {
                            // Return if neither normal nor urgent are in filters
                            if (!filters.includes(task.priority)) return;
                        } else if (!filters.includes(task.priority)) {
                            // For other priorities, check exact match
                            return;
                        }
                    }
                    
                    // Apply task type filter
                    if (taskTypeFilter !== 'all') {
                        // Helper functions for accurate word boundary matching
                        const isBloodRelated = (text) => {
                            return /\b(blood|fbc|cbc|hb|hgb|wcc|plt|u&e|lft|lfts|coag|bnp|trop|troponin)\b/i.test(text);
                        };
                        
                        const isImagingRelated = (text) => {
                            return /\b(xray|x-ray|ultrasound|scan|mri|ct scan|cat scan|pet|imaging|radiology)\b/i.test(text);
                        };
                        
                        // Handle investigation (parent category)
                        if (taskTypeFilter === 'investigation') {
                            if (!(
                                // Check tags first
                                (task.tags && task.tags.includes('investigation')) ||
                                (task.tags && task.tags.includes('bloods')) ||
                                (task.isBloodsTask) ||
                                (task.tags && task.tags.includes('imaging')) ||
                                // Then check text with proper word boundary matching
                                isBloodRelated(task.text) || 
                                isImagingRelated(task.text)
                            )) {
                                return;
                            }
                        }
                        // Handle specific investigation types
                        else if (taskTypeFilter === 'bloods') {
                            if (!(
                                task.isBloodsTask || 
                                (task.tags && task.tags.includes('bloods')) || 
                                isBloodRelated(task.text)
                            )) {
                                return;
                            }
                        }
                        else if (taskTypeFilter === 'imaging') {
                            if (!(
                                (task.tags && task.tags.includes('imaging')) || 
                                isImagingRelated(task.text)
                            )) {
                                return;
                            }
                        }
                        else if (taskTypeFilter === 'other') {
                            if (!((task.tags && task.tags.includes('other')) || 
                                 (task.tags && task.tags.includes('investigation') && 
                                  !task.tags.includes('bloods') && 
                                  !task.tags.includes('imaging')))) {
                                return;
                            }
                        }
                    }
                    
                    // Apply search term
                    if (searchTerm && !task.text.toLowerCase().includes(searchTerm.toLowerCase())) {
                        return;
                    }
                    
                    // Add patient info to task
                    const taskWithPatient = {
                        ...task,
                        patientName: patient.name,
                        patientId: patient.id,
                        ward: patient.ward
                    };
                    
                    // Group by status
                    if (task.priority === 'completed') {
                        tasksByWard[wardName].completed.push(taskWithPatient);
                    } else if (task.priority === 'in-progress') {
                        tasksByWard[wardName]['in-progress'].push(taskWithPatient);
                    } else {
                        tasksByWard[wardName].pending.push(taskWithPatient);
                    }
                    
                    totalTasksFound++;
                });
            });
            
            if (totalTasksFound === 0) {
                allTasksContainer.innerHTML = `
                    <div class="no-tasks">
                        <i class="fas fa-check-circle"></i>
                        <p>No tasks found matching your criteria</p>
                    </div>
                `;
                return;
            }
            
            // Sort wards alphabetically
            const sortedWards = Object.keys(tasksByWard).sort();
            
            sortedWards.forEach(ward => {
                const wardGroup = document.createElement('div');
                wardGroup.className = 'ward-group';
                
                const wardHeader = document.createElement('div');
                wardHeader.className = 'ward-header';
                wardHeader.innerHTML = `<i class="fas fa-hospital"></i> ${ward}`;
                wardGroup.appendChild(wardHeader);
                
                // Pending tasks section
                const pendingTasks = tasksByWard[ward].pending;
                if (pendingTasks.length > 0) {
                    const pendingSection = document.createElement('div');
                    pendingSection.className = 'task-section';
                    
                    const pendingHeader = document.createElement('div');
                    pendingHeader.className = 'task-section-header';
                    pendingHeader.innerHTML = `
                        <h3><i class="fas fa-clipboard-list"></i> Pending Tasks (${pendingTasks.length})</h3>
                    `;
                    pendingSection.appendChild(pendingHeader);
                    
                    // Sort pending tasks by priority and date
                    pendingTasks.sort((a, b) => {
                        if (a.priority === 'urgent' && b.priority !== 'urgent') return -1;
                        if (a.priority !== 'urgent' && b.priority === 'urgent') return 1;
                        return new Date(b.date) - new Date(a.date);
                    });
                    
                    pendingTasks.forEach(task => {
                        const taskItem = document.createElement('div');
                        taskItem.className = `task-item ${task.priority}`;
                        taskItem.innerHTML = `
                            <div class="task-content">
                                <div class="task-text">${task.text}</div>
                                <div class="task-meta">
                                    <span class="task-patient">
                                        <i class="fas fa-user"></i> ${task.patientName} (${task.patientId})
                                    </span>
                                    <span class="task-location">
                                        <i class="fas fa-map-marker-alt"></i> ${task.ward}
                                    </span>
                                    <span class="task-date">
                                        <i class="fas fa-clock"></i> ${task.date}
                                    </span>
                                </div>
                            </div>
                            <div class="task-actions">
                                <button class="toggle-task-status-btn-all" data-patient-id="${task.patientId}" data-task-id="${task.id}" data-status="normal" title="Toggle Status">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button class="complete-task-btn-all" data-patient-id="${task.patientId}" data-task-id="${task.id}" title="Mark Complete">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="view-patient-task-btn" data-patient-id="${task.patientId}" title="View Patient">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="delete-task-all-btn" data-patient-id="${task.patientId}" data-task-id="${task.id}" title="Delete Task">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        `;
                        pendingSection.appendChild(taskItem);
                    });
                    
                    wardGroup.appendChild(pendingSection);
                }
                
                // In-progress tasks section
                const inProgressTasks = tasksByWard[ward]['in-progress'];
                if (inProgressTasks.length > 0) {
                    const inProgressSection = document.createElement('div');
                    inProgressSection.className = 'task-section';
                    
                    const inProgressHeader = document.createElement('div');
                    inProgressHeader.className = 'task-section-header';
                    inProgressHeader.innerHTML = `
                        <h3><i class="fas fa-spinner"></i> In Progress (${inProgressTasks.length})</h3>
                    `;
                    inProgressSection.appendChild(inProgressHeader);
                    
                    // Sort by date
                    inProgressTasks.sort((a, b) => new Date(b.progressDate || b.date) - new Date(a.progressDate || a.date));
                    
                    inProgressTasks.forEach(task => {
                        const taskItem = document.createElement('div');
                        taskItem.className = `task-item in-progress`;
                        taskItem.innerHTML = `
                            <div class="task-content">
                                <div class="task-text">${task.text}</div>
                                <div class="task-meta">
                                    <span class="task-patient">
                                        <i class="fas fa-user"></i> ${task.patientName} (${task.patientId})
                                    </span>
                                    <span class="task-location">
                                        <i class="fas fa-map-marker-alt"></i> ${task.ward}
                                    </span>
                                    <span class="task-date">
                                        <i class="fas fa-clock"></i> ${task.progressDate || task.date}
                                    </span>
                                </div>
                            </div>
                            <div class="task-actions">
                                <button class="toggle-task-status-btn-all" data-patient-id="${task.patientId}" data-task-id="${task.id}" data-status="in-progress" title="Toggle Status">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button class="view-patient-task-btn" data-patient-id="${task.patientId}" title="View Patient">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="delete-task-all-btn" data-patient-id="${task.patientId}" data-task-id="${task.id}" title="Delete Task">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        `;
                        inProgressSection.appendChild(taskItem);
                    });
                    
                    wardGroup.appendChild(inProgressSection);
                }
                
                // Completed tasks section
                const completedTasks = tasksByWard[ward].completed;
                if (completedTasks.length > 0) {
                    const completedSection = document.createElement('div');
                    completedSection.className = 'task-section';
                    
                    const completedHeader = document.createElement('div');
                    completedHeader.className = 'task-section-header';
                    completedHeader.innerHTML = `
                        <h3><i class="fas fa-check"></i> Completed Tasks (${completedTasks.length})</h3>
                    `;
                    completedSection.appendChild(completedHeader);
                    
                    // Sort completed tasks by date (newest first)
                    completedTasks.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    completedTasks.forEach(task => {
                        const taskItem = document.createElement('div');
                        taskItem.className = `task-item ${task.priority}`;
                        taskItem.innerHTML = `
                            <div class="task-content">
                                <div class="task-text">${task.text}</div>
                                <div class="task-meta">
                                    <span class="task-patient">
                                        <i class="fas fa-user"></i> ${task.patientName} (${task.patientId})
                                    </span>
                                    <span class="task-location">
                                        <i class="fas fa-map-marker-alt"></i> ${task.ward}
                                    </span>
                                    <span class="task-date">
                                        <i class="fas fa-clock"></i> ${task.date}
                                    </span>
                                </div>
                            </div>
                            <div class="task-actions">
                                <button class="toggle-task-status-btn-all" data-patient-id="${task.patientId}" data-task-id="${task.id}" data-status="completed" title="Toggle Status">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button class="view-patient-task-btn" data-patient-id="${task.patientId}" title="View Patient">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="delete-task-all-btn" data-patient-id="${task.patientId}" data-task-id="${task.id}" title="Delete Task">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        `;
                        completedSection.appendChild(taskItem);
                    });
                    
                    wardGroup.appendChild(completedSection);
                }
                
                allTasksContainer.appendChild(wardGroup);
            });
            
            // Add event listeners for task actions
            document.querySelectorAll('.toggle-task-status-btn-all').forEach(button => {
                button.addEventListener('click', toggleTaskStatusFromAll);
            });
            
            document.querySelectorAll('.complete-task-btn-all').forEach(button => {
                button.addEventListener('click', markTaskCompleteFromAll);
            });
            
            document.querySelectorAll('.view-patient-task-btn').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const patientId = this.getAttribute('data-patient-id');
                    showPatientDetails(patientId);
                });
            });
            
            document.querySelectorAll('.delete-task-all-btn').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const patientId = this.getAttribute('data-patient-id');
                    const taskId = parseInt(this.getAttribute('data-task-id'));
                    deleteTaskFromAll(patientId, taskId);
                });
            });
            
        }
        
        // Function to show edit task modal
        function showEditTaskModal(taskId) {
            currentEditingTaskId = taskId;
            const patient = patients.find(p => p.id === currentPatientId);
            
            if (!patient) return;
            
            const task = patient.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            // Populate form fields
            editTaskText.value = task.text;
            editTaskDescription.value = task.description || '';
            editTaskPriority.value = task.priority;
            
            // Set task type based on tags
            if (task.tags && task.tags.length > 0) {
                if (task.tags.includes('bloods')) {
                    editTaskType.value = 'bloods';
                } else if (task.tags.includes('imaging')) {
                    editTaskType.value = 'imaging';
                } else if (task.tags.includes('other')) {
                    editTaskType.value = 'other';
                } else if (task.tags.includes('investigation')) {
                    editTaskType.value = 'investigation';
                } else {
                    editTaskType.value = 'none';
                }
            } else {
                editTaskType.value = 'none';
            }
            
            // Update modal title for bloods task
            const modalTitle = document.querySelector('#task-edit-modal h2');
            if (task.isBloodsTask || task.text.toLowerCase().includes("blood")) {
                modalTitle.textContent = 'Edit Bloods Task';
                
                // Add hint to include specific tests if the description is brief
                if (!task.description || task.description.length < 50) {
                    editTaskDescription.placeholder = "Specify which blood tests are required (e.g., FBC, U&Es, LFTs, Coags, etc.)";
                }
            } else {
                modalTitle.textContent = 'Edit Task';
                editTaskDescription.placeholder = "Add detailed information about this task...";
            }
            
            // Show the modal
            taskEditModal.classList.remove('hidden');
        }
        
        // Function to save edited task
        function saveEditedTask(e) {
            e.preventDefault();
            
            const text = editTaskText.value.trim();
            const description = editTaskDescription.value.trim();
            const priority = editTaskPriority.value;
            const taskType = editTaskType.value;
            
            if (text && currentPatientId && currentEditingTaskId) {
                const patientIndex = patients.findIndex(p => p.id === currentPatientId);
                
                if (patientIndex === -1) return;
                
                const taskIndex = patients[patientIndex].tasks.findIndex(t => t.id === currentEditingTaskId);
                
                if (taskIndex === -1) return;
                
                const task = patients[patientIndex].tasks[taskIndex];
                
                // Update task properties
                task.text = text;
                task.description = description;
                task.priority = priority;
                
                // Initialize tags array if it doesn't exist
                if (!task.tags) {
                    task.tags = [];
                }
                
                // Handle task type from dropdown
                if (taskType !== 'none') {
                    // First, reset any existing categorization
                    task.tags = task.tags.filter(tag => 
                        tag !== 'investigation' && 
                        tag !== 'bloods' && 
                        tag !== 'imaging' && 
                        tag !== 'other'
                    );
                    
                    // Set isBloodsTask to false by default unless needed
                    if (taskType !== 'bloods') {
                        task.isBloodsTask = false;
                    }
                    
                    // Add new tags based on selection
                    if (taskType === 'investigation' || taskType === 'bloods' || taskType === 'imaging' || taskType === 'other') {
                        task.tags.push('investigation');
                        
                        if (taskType !== 'investigation') {
                            task.tags.push(taskType);
                            
                            // Set isBloodsTask for bloods
                            if (taskType === 'bloods') {
                                task.isBloodsTask = true;
                            }
                        }
                    }
                } 
                // If "none" was selected, remove all type tags
                else if (taskType === 'none') {
                    task.tags = task.tags.filter(tag => 
                        tag !== 'investigation' && 
                        tag !== 'bloods' && 
                        tag !== 'imaging' && 
                        tag !== 'other'
                    );
                    task.isBloodsTask = false;
                }
                
                // Auto-detect task type if no type was explicitly selected
                if (taskType === 'none') {
                    // Convert to lowercase for consistent matching
                    const lowercaseText = text.toLowerCase();
                    
                    // Use regular expressions with word boundaries for accurate matching
                    const isBloodTask = /\b(blood|fbc|cbc|hb|hgb|wcc|plt|u&e|lft|lfts|coag|bnp|trop|troponin)\b/.test(lowercaseText);
                    const isImagingTask = /\b(xray|x-ray|ultrasound|scan|mri|ct scan|cat scan|pet|imaging|radiology)\b/.test(lowercaseText);
                    
                    // Handle blood tasks
                    if (isBloodTask) {
                        task.isBloodsTask = true;
                        
                        if (!task.tags.includes("investigation")) {
                            task.tags.push("investigation");
                        }
                        if (!task.tags.includes("bloods")) {
                            task.tags.push("bloods");
                        }
                    }
                    
                    // Handle imaging tasks
                    if (isImagingTask) {
                        if (!task.tags.includes("investigation")) {
                            task.tags.push("investigation");
                        }
                        if (!task.tags.includes("imaging")) {
                            task.tags.push("imaging");
                        }
                    }
                }
                
                // If this is a bloods task and the button exists on the patient card, update its state
                if (task.isBloodsTask) {
                    const button = document.querySelector(`.bloods-button[data-patient-id="${currentPatientId}"]`);
                    if (button) {
                        // Remove existing status classes
                        button.classList.remove('normal', 'in-progress', 'completed');
                        
                        // Add the new status class
                        button.classList.add(priority);
                        button.setAttribute('data-task-id', currentEditingTaskId);
                    }
                }
                
                localStorage.setItem('patients', JSON.stringify(patients));
                
                // Close modal and refresh task list
                taskEditModal.classList.add('hidden');
                renderTasks(patients[patientIndex]);
            }
        }
        
        // Function to show edit note modal
        let currentEditingNoteId = null;
        function showEditNoteModal(noteId) {
            currentEditingNoteId = noteId;
            const patient = patients.find(p => p.id === currentPatientId);
            
            if (!patient) return;
            
            const note = patient.clinicalNotes.find(n => n.id === noteId);
            if (!note) return;
            
            // Populate form fields
            document.getElementById('edit-note-text').value = note.text;
            
            // Show the modal
            document.getElementById('note-edit-modal').classList.remove('hidden');
            
            // Add event listeners for close button
            document.querySelector('.close-note-modal').addEventListener('click', function() {
                document.getElementById('note-edit-modal').classList.add('hidden');
            });
            
            // Handle click outside modal
            document.getElementById('note-edit-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.add('hidden');
                }
            });
        }
        
        // Function to save edited note
        function saveEditedNote(e) {
            e.preventDefault();
            
            const text = document.getElementById('edit-note-text').value.trim();
            
            if (text && currentPatientId && currentEditingNoteId) {
                const patientIndex = patients.findIndex(p => p.id === currentPatientId);
                
                if (patientIndex === -1) return;
                
                const noteIndex = patients[patientIndex].clinicalNotes.findIndex(n => n.id === currentEditingNoteId);
                
                if (noteIndex === -1) return;
                
                // Update note
                patients[patientIndex].clinicalNotes[noteIndex].text = text;
                patients[patientIndex].clinicalNotes[noteIndex].editDate = new Date().toLocaleString(); // Optional: add edit date
                
                localStorage.setItem('patients', JSON.stringify(patients));
                
                // Close modal and refresh notes list
                document.getElementById('note-edit-modal').classList.add('hidden');
                renderClinicalNotes(patients[patientIndex]);
            }
        }
        
        // Function to show edit diagnosis modal
        let currentEditingDiagnosisId = null;
        function showEditDiagnosisModal(diagnosisId) {
            currentEditingDiagnosisId = diagnosisId;
            const patient = patients.find(p => p.id === currentPatientId);
            
            if (!patient) return;
            
            const diagnosis = patient.medicalHistory.find(d => d.id === diagnosisId);
            if (!diagnosis) return;
            
            // Populate form fields
            document.getElementById('edit-diagnosis-text').value = diagnosis.diagnosis;
            
            // Show the modal
            document.getElementById('diagnosis-edit-modal').classList.remove('hidden');
            
            // Add event listeners for close button
            document.querySelector('.close-diagnosis-modal').addEventListener('click', function() {
                document.getElementById('diagnosis-edit-modal').classList.add('hidden');
            });
            
            // Handle click outside modal
            document.getElementById('diagnosis-edit-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.add('hidden');
                }
            });
        }
        
        // Function to save edited diagnosis
        function saveEditedDiagnosis(e) {
            e.preventDefault();
            
            const text = document.getElementById('edit-diagnosis-text').value.trim();
            
            if (text && currentPatientId && currentEditingDiagnosisId) {
                const patientIndex = patients.findIndex(p => p.id === currentPatientId);
                
                if (patientIndex === -1) return;
                
                const diagnosisIndex = patients[patientIndex].medicalHistory.findIndex(d => d.id === currentEditingDiagnosisId);
                
                if (diagnosisIndex === -1) return;
                
                // Update diagnosis
                patients[patientIndex].medicalHistory[diagnosisIndex].diagnosis = text;
                patients[patientIndex].medicalHistory[diagnosisIndex].editDate = new Date().toLocaleString(); // Optional: add edit date
                
                localStorage.setItem('patients', JSON.stringify(patients));
                
                // Close modal and refresh diagnosis list
                document.getElementById('diagnosis-edit-modal').classList.add('hidden');
                renderMedicalHistory(patients[patientIndex]);
            }
        }
        
        // Function to show edit social history modal
        let currentEditingSocialHistoryId = null;
        function showEditSocialHistoryModal(socialHistoryId) {
            currentEditingSocialHistoryId = socialHistoryId;
            const patient = patients.find(p => p.id === currentPatientId);
            
            if (!patient) return;
            
            const socialHistory = patient.socialHistory.find(s => s.id === socialHistoryId);
            if (!socialHistory) return;
            
            // Populate form fields
            document.getElementById('edit-social-history-text').value = socialHistory.text;
            
            // Show the modal
            document.getElementById('social-history-edit-modal').classList.remove('hidden');
            
            // Add event listeners for close button
            document.querySelector('.close-social-history-modal').addEventListener('click', function() {
                document.getElementById('social-history-edit-modal').classList.add('hidden');
            });
            
            // Handle click outside modal
            document.getElementById('social-history-edit-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.add('hidden');
                }
            });
        }
        
        // Function to save edited social history
        function saveEditedSocialHistory(e) {
            e.preventDefault();
            
            const text = document.getElementById('edit-social-history-text').value.trim();
            
            if (text && currentPatientId && currentEditingSocialHistoryId) {
                const patientIndex = patients.findIndex(p => p.id === currentPatientId);
                
                if (patientIndex === -1) return;
                
                const socialHistoryIndex = patients[patientIndex].socialHistory.findIndex(s => s.id === currentEditingSocialHistoryId);
                
                if (socialHistoryIndex === -1) return;
                
                // Update social history
                patients[patientIndex].socialHistory[socialHistoryIndex].text = text;
                patients[patientIndex].socialHistory[socialHistoryIndex].editDate = new Date().toLocaleString(); // Optional: add edit date
                
                localStorage.setItem('patients', JSON.stringify(patients));
                
                // Close modal and refresh social history list
                document.getElementById('social-history-edit-modal').classList.add('hidden');
                renderSocialHistory(patients[patientIndex]);
            }
        }
        
        // Toggle task description in form
        function toggleTaskDetails() {
            const descriptionContainer = document.querySelector('.task-description-container');
            descriptionContainer.classList.toggle('expanded');
            toggleTaskDetailsBtn.classList.toggle('active');
            
            const icon = toggleTaskDetailsBtn.querySelector('i');
            const buttonText = toggleTaskDetailsBtn.querySelector('span');
            
            if (descriptionContainer.classList.contains('expanded')) {
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
                buttonText.textContent = 'Hide Description';
            } else {
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
                buttonText.textContent = 'Description';
            }
        }
        
        // Function to handle showing the patient add modal
        function showAddPatientModal() {
            modalTitle.textContent = 'Add New Patient';
            patientForm.reset();
            
            // Initialize location selector to default (dropdown mode)
            const otherLocationToggle = document.getElementById('other-location-toggle');
            otherLocationToggle.checked = false;
            toggleOtherLocation();
            
            // Update bed selector based on first ward
            if (wards.length > 0) {
                const wardSelect = document.getElementById('patient-ward-select');
                if (wardSelect.options.length > 1) {
                    wardSelect.selectedIndex = 1; // Select first ward
                    updateBedSelectors(wardSelect.value);
                }
            }
            
            // Clear any existing diagnosis inputs
            diagnosesContainer.innerHTML = '';
            
            // Add one empty diagnosis input
            addDiagnosisInput('');
            
            patientModal.classList.remove('hidden');
        }
        
        // Event listeners
        addPatientBtn.addEventListener('click', showAddPatientModal);
        addDiagnosisBtn.addEventListener('click', () => addDiagnosisInput());
        backToListBtn.addEventListener('click', () => {
            patientDetailView.classList.add('hidden');
            patientListView.classList.remove('hidden');
            // Update the patient list to show any new urgent tasks
            renderPatientList();
        });
        editPatientBtn.addEventListener('click', showEditPatientModal);
        deletePatientBtn.addEventListener('click', deletePatient);
        closeModal.addEventListener('click', () => patientModal.classList.add('hidden'));
        closeTaskModal.addEventListener('click', () => taskEditModal.classList.add('hidden'));
        toggleTaskDetailsBtn.addEventListener('click', toggleTaskDetails);
        
        // Add event listener for DOB field to update calculated age
        document.getElementById('patient-dob-input').addEventListener('change', function() {
            updateCalculatedAge(this.value);
        });
        
        patientForm.addEventListener('submit', savePatient);
        taskForm.addEventListener('submit', addTask);
        editTaskForm.addEventListener('submit', saveEditedTask);
        clinicalNoteForm.addEventListener('submit', addClinicalNote);
        medicalHistoryForm.addEventListener('submit', addDiagnosis);
        document.getElementById('social-history-form').addEventListener('submit', addSocialHistory);
        document.getElementById('edit-note-form').addEventListener('submit', saveEditedNote);
        document.getElementById('edit-diagnosis-form').addEventListener('submit', saveEditedDiagnosis);
        document.getElementById('edit-social-history-form').addEventListener('submit', saveEditedSocialHistory);
        patientSearch.addEventListener('input', searchPatients);
        
        // Tab switching
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Remove active class from all tabs
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                
                // Add active class to clicked tab
                button.classList.add('active');
                const tabId = button.getAttribute('data-tab');
                document.getElementById(`${tabId}-tab`).classList.add('active');
            });
        });
        
        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === patientModal) {
                patientModal.classList.add('hidden');
            }
            if (e.target === taskEditModal) {
                taskEditModal.classList.add('hidden');
            }
        });
        
        // Main tab switching
        mainTabButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Remove active class from all tabs
                mainTabButtons.forEach(btn => btn.classList.remove('active'));
                mainViews.forEach(view => view.classList.remove('active'));
                
                // Add active class to clicked tab
                button.classList.add('active');
                const viewId = button.getAttribute('data-view');
                
                // Hide patient detail view no matter which tab is clicked
                patientDetailView.classList.add('hidden');
                
                if (viewId === 'patients') {
                    patientListView.classList.add('active');
                    patientListView.classList.remove('hidden');
                    allTasksView.classList.remove('active');
                    allTasksView.classList.add('hidden');
                    settingsView.classList.remove('active');
                    settingsView.classList.add('hidden');
                    renderPatientList();
                } else if (viewId === 'all-tasks') {
                    allTasksView.classList.add('active');
                    allTasksView.classList.remove('hidden');
                    patientListView.classList.remove('active');
                    patientListView.classList.add('hidden');
                    settingsView.classList.remove('active');
                    settingsView.classList.add('hidden');
                    
                    // Get selected filters and render tasks
                    const selectedFilters = Array.from(document.querySelectorAll('.task-filter-checkbox:checked'))
                        .map(cb => cb.value);
                    const searchTerm = document.getElementById('task-search').value.trim();
                    renderAllTasks(selectedFilters, searchTerm);
                } else if (viewId === 'settings') {
                    settingsView.classList.add('active');
                    settingsView.classList.remove('hidden');
                    patientListView.classList.remove('active');
                    patientListView.classList.add('hidden');
                    allTasksView.classList.remove('active');
                    allTasksView.classList.add('hidden');
                    renderWardList();
                }
            });
        });
        
        // Event listeners for task filter checkboxes
        document.querySelectorAll('.task-filter-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const searchTerm = taskSearch.value.trim();
                
                // Get all selected filter values
                const selectedFilters = Array.from(document.querySelectorAll('.task-filter-checkbox:checked'))
                    .map(cb => cb.value);
                
                // Visual feedback - add selected class to parent label
                document.querySelectorAll('.task-filter-label').forEach(label => {
                    const cb = label.querySelector('input[type="checkbox"]');
                    if (cb.checked) {
                        label.classList.add('selected');
                    } else {
                        label.classList.remove('selected');
                    }
                });
                
                // Get task type filter
                const taskTypeFilters = document.querySelectorAll('.task-type-filter-checkbox:checked');
                let taskTypeFilter = 'all';
                
                if (taskTypeFilters.length > 0) {
                    const checkedTypeFilter = taskTypeFilters[0];
                    taskTypeFilter = checkedTypeFilter.value;
                }
                
                renderAllTasks(selectedFilters, searchTerm, taskTypeFilter);
            });
        });
        
        // Event listeners for task type filter checkboxes
        document.querySelectorAll('.task-type-filter-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const searchTerm = taskSearch.value.trim();
                
                // Get all selected task status filter values
                const selectedFilters = Array.from(document.querySelectorAll('.task-filter-checkbox:checked'))
                    .map(cb => cb.value);
                
                // Make sure only one task type filter is selected at a time
                if (this.checked) {
                    document.querySelectorAll('.task-type-filter-checkbox').forEach(cb => {
                        if (cb !== this) {
                            cb.checked = false;
                            cb.closest('.task-type-filter-label').classList.remove('selected');
                        }
                    });
                    
                    this.closest('.task-type-filter-label').classList.add('selected');
                } else {
                    // If unchecking, check the "All Types" filter
                    document.querySelector('.task-type-filter-checkbox[value="all"]').checked = true;
                    document.querySelector('.task-type-filter-checkbox[value="all"]').closest('.task-type-filter-label').classList.add('selected');
                    this.closest('.task-type-filter-label').classList.remove('selected');
                }
                
                // Get the selected task type filter
                const taskTypeFilter = this.checked ? this.value : 'all';
                
                renderAllTasks(selectedFilters, searchTerm, taskTypeFilter);
            });
        });
        
        // Initialize selected state for labels
        document.querySelectorAll('.task-filter-label').forEach(label => {
            const cb = label.querySelector('input[type="checkbox"]');
            if (cb.checked) {
                label.classList.add('selected');
            }
        });
        
        // Initialize selected state for task type filter labels
        document.querySelectorAll('.task-type-filter-label').forEach(label => {
            const cb = label.querySelector('input[type="checkbox"]');
            if (cb.checked) {
                label.classList.add('selected');
            }
        });
        
        // Event listener for task search
        taskSearch.addEventListener('input', function() {
            const searchTerm = this.value.trim();
            
            // Get all selected filter values
            const selectedFilters = Array.from(document.querySelectorAll('.task-filter-checkbox:checked'))
                .map(cb => cb.value);
            
            // Get task type filter
            const taskTypeFilters = document.querySelectorAll('.task-type-filter-checkbox:checked');
            let taskTypeFilter = 'all';
            
            if (taskTypeFilters.length > 0) {
                const checkedTypeFilter = taskTypeFilters[0];
                taskTypeFilter = checkedTypeFilter.value;
            }
                
            renderAllTasks(selectedFilters, searchTerm, taskTypeFilter);
        });
        
        // Add event listeners for delete buttons in the all tasks view
        document.querySelectorAll('.delete-task-all-btn').forEach(button => {
            button.addEventListener('click', function() {
                const patientId = this.getAttribute('data-patient-id');
                const taskId = parseInt(this.getAttribute('data-task-id'));
                deleteTaskFromAll(patientId, taskId);
            });
        });
        
        // Function to delete a task from the all tasks view
        function deleteTaskFromAll(patientId, taskId) {
            const patientIndex = patients.findIndex(p => p.id === patientId);
            if (patientIndex === -1) return;
            
            const taskIndex = patients[patientIndex].tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;
            
            const task = patients[patientIndex].tasks[taskIndex];
            
            // Confirm before deleting
            if (confirm(`Are you sure you want to delete this task from ${patients[patientIndex].name}?`)) {
                // Remove the task
                patients[patientIndex].tasks.splice(taskIndex, 1);
                
                // If this was a bloods task, update any bloods button associated with this patient
                if (task.isBloodsTask || (task.tags && task.tags.includes('bloods')) || 
                    task.text.toLowerCase().includes('blood')) {
                    const button = document.querySelector(`.bloods-button[data-patient-id="${patientId}"][data-task-id="${taskId}"]`);
                    if (button) {
                        // Reset the button state
                        button.classList.remove('normal', 'in-progress', 'completed');
                        button.removeAttribute('data-task-id');
                    }
                }
                
                // Save changes to localStorage
                localStorage.setItem('patients', JSON.stringify(patients));
                
                // Re-render the all tasks view
                const selectedFilters = Array.from(document.querySelectorAll('.task-filter-checkbox:checked'))
                    .map(cb => cb.value);
                const searchTerm = document.getElementById('task-search').value.trim();
                
                // Get task type filter
                const taskTypeFilters = document.querySelectorAll('.task-type-filter-checkbox:checked');
                let taskTypeFilter = 'all';
                if (taskTypeFilters.length > 0) {
                    const checkedTypeFilter = taskTypeFilters[0];
                    taskTypeFilter = checkedTypeFilter.value;
                }
                
                renderAllTasks(selectedFilters, searchTerm, taskTypeFilter);
            }
        }
        
        // Define the toggleTaskStatusFromAll function properly 
        function toggleTaskStatusFromAll() {
            const patientId = this.getAttribute('data-patient-id');
            const taskId = parseInt(this.getAttribute('data-task-id'));
            const currentStatus = this.getAttribute('data-status');
            
            const patientIndex = patients.findIndex(p => p.id === patientId);
            if (patientIndex === -1) return;
            
            const taskIndex = patients[patientIndex].tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;
            
            // Cycle through statuses: normal → in-progress → completed → normal
            if (currentStatus === 'normal' || currentStatus === 'urgent') {
                // Move to in-progress
                patients[patientIndex].tasks[taskIndex].priority = 'in-progress';
                patients[patientIndex].tasks[taskIndex].progressDate = new Date().toLocaleString();
            } else if (currentStatus === 'in-progress') {
                // Move to completed
                patients[patientIndex].tasks[taskIndex].priority = 'completed';
                patients[patientIndex].tasks[taskIndex].completedDate = new Date().toLocaleString();
            } else if (currentStatus === 'completed') {
                // Move back to normal
                patients[patientIndex].tasks[taskIndex].priority = 'normal';
                delete patients[patientIndex].tasks[taskIndex].completedDate;
                delete patients[patientIndex].tasks[taskIndex].progressDate;
            }
            
            localStorage.setItem('patients', JSON.stringify(patients));
            
            // Re-render the all tasks view
            const selectedFilters = Array.from(document.querySelectorAll('.task-filter-checkbox:checked'))
                .map(cb => cb.value);
            const searchTerm = document.getElementById('task-search').value.trim();
            renderAllTasks(selectedFilters, searchTerm);
        }
        
        // Function to mark a task as complete directly from pending in All Tasks view
        function markTaskCompleteFromAll() {
            const patientId = this.getAttribute('data-patient-id');
            const taskId = parseInt(this.getAttribute('data-task-id'));
            
            const patientIndex = patients.findIndex(p => p.id === patientId);
            if (patientIndex === -1) return;
            
            const taskIndex = patients[patientIndex].tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;
            
            // Set directly to completed
            patients[patientIndex].tasks[taskIndex].priority = 'completed';
            patients[patientIndex].tasks[taskIndex].completedDate = new Date().toLocaleString();
            
            localStorage.setItem('patients', JSON.stringify(patients));
            
            // Re-render the all tasks view
            const selectedFilters = Array.from(document.querySelectorAll('.task-filter-checkbox:checked'))
                .map(cb => cb.value);
            const searchTerm = document.getElementById('task-search').value.trim();
            renderAllTasks(selectedFilters, searchTerm);
        }
        
        // Task management functions for the patient card
        
        // Function to add a task from the patient card
        function addTaskFromCard(patientId, taskText, taskPriority, taskType = 'none') {
            const patientIndex = patients.findIndex(p => p.id === patientId);
            if (patientIndex === -1) return;
            
            // Create new task
            const newTask = {
                id: Date.now(),
                text: taskText,
                priority: taskPriority,
                date: new Date().toLocaleString(),
                tags: []
            };
            
            // Ensure patient has a tasks array
            if (!patients[patientIndex].tasks) {
                patients[patientIndex].tasks = [];
            }
            
            // Handle task type from selection
            if (taskType !== 'none') {
                // Add tags based on selected type
                if (taskType === 'investigation' || taskType === 'bloods' || taskType === 'imaging' || taskType === 'other') {
                    if (!newTask.tags.includes('investigation')) {
                        newTask.tags.push('investigation');
                    }
                    
                    if (taskType !== 'investigation') {
                        newTask.tags.push(taskType);
                    }
                    
                    // Set isBloodsTask for bloods
                    if (taskType === 'bloods') {
                        newTask.isBloodsTask = true;
                    }
                }
            } 
            // Auto-detect type from text if no type was selected
            else {
                // Convert to lowercase for consistent matching
                const lowercaseText = taskText.toLowerCase();
                
                // Use regular expressions with word boundaries for accurate matching
                const isBloodTask = /\b(blood|fbc|cbc|hb|hgb|wcc|plt|u&e|lft|lfts|coag|bnp|trop|troponin)\b/.test(lowercaseText);
                const isImagingTask = /\b(xray|x-ray|ultrasound|scan|mri|ct scan|cat scan|pet|imaging|radiology)\b/.test(lowercaseText);
                
                if (isBloodTask || isImagingTask) {
                    // Add investigation tag
                    if (!newTask.tags.includes('investigation')) {
                        newTask.tags.push('investigation');
                    }
                    
                    // Add specific tag based on content
                    if (isBloodTask) {
                        if (!newTask.tags.includes('bloods')) {
                            newTask.tags.push('bloods');
                        }
                        newTask.isBloodsTask = true;
                    } else if (isImagingTask) {
                        if (!newTask.tags.includes('imaging')) {
                            newTask.tags.push('imaging');
                        }
                    }
                }
            }
            
            // Add the new task
            patients[patientIndex].tasks.push(newTask);
            
            // Save changes
            localStorage.setItem('patients', JSON.stringify(patients));
            
            // Re-render the patient list to show the updated task
            renderPatientList();
        }
        
        // Function to mark a task as complete from the patient card
        function markTaskCompleteFromCard(patientId, taskId) {
            const patientIndex = patients.findIndex(p => p.id === patientId);
            if (patientIndex === -1) return;
            
            const taskIndex = patients[patientIndex].tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;
            
            // Set to completed
            patients[patientIndex].tasks[taskIndex].priority = 'completed';
            patients[patientIndex].tasks[taskIndex].completedDate = new Date().toLocaleString();
            
            // Save changes
            localStorage.setItem('patients', JSON.stringify(patients));
            
            // Re-render the patient list
            renderPatientList();
        }
        
        // Function to mark a task as in-progress from the patient card
        function markTaskInProgressFromCard(patientId, taskId) {
            const patientIndex = patients.findIndex(p => p.id === patientId);
            if (patientIndex === -1) return;
            
            const taskIndex = patients[patientIndex].tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;
            
            // Set to in-progress
            patients[patientIndex].tasks[taskIndex].priority = 'in-progress';
            patients[patientIndex].tasks[taskIndex].progressDate = new Date().toLocaleString();
            
            // Save changes
            localStorage.setItem('patients', JSON.stringify(patients));
            
            // Re-render the patient list
            renderPatientList();
        }
        
        // Function to reopen a completed task from the patient card
        function reopenTaskFromCard(patientId, taskId) {
            const patientIndex = patients.findIndex(p => p.id === patientId);
            if (patientIndex === -1) return;
            
            const taskIndex = patients[patientIndex].tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;
            
            // Set back to normal
            patients[patientIndex].tasks[taskIndex].priority = 'normal';
            delete patients[patientIndex].tasks[taskIndex].completedDate;
            delete patients[patientIndex].tasks[taskIndex].progressDate;
            
            // Save changes
            localStorage.setItem('patients', JSON.stringify(patients));
            
            // Re-render the patient list
            renderPatientList();
        }
        
        // Function to delete a task from the patient card
        function deleteTaskFromCard(patientId, taskId) {
            const patientIndex = patients.findIndex(p => p.id === patientId);
            if (patientIndex === -1) return;
            
            // Find the task
            const task = patients[patientIndex].tasks.find(t => t.id === taskId);
            if (!task) return;
            
            // Ask for confirmation
            if (confirm(`Are you sure you want to delete the task "${task.text}"?`)) {
                // Remove the task from the patient's tasks array
                patients[patientIndex].tasks = patients[patientIndex].tasks.filter(t => t.id !== taskId);
                
                // Save changes
                localStorage.setItem('patients', JSON.stringify(patients));
                
                // If this was a bloods task, update any bloods button associated with this patient
                if (task.isBloodsTask || task.text.toLowerCase().includes("blood")) {
                    const button = document.querySelector(`.bloods-button[data-patient-id="${patientId}"][data-task-id="${taskId}"]`);
                    if (button) {
                        // Reset the button state
                        button.classList.remove('normal', 'in-progress', 'completed');
                        button.removeAttribute('data-task-id');
                    }
                }
                
                // Re-render the patient list
                renderPatientList();
            }
        }
        
        // Function to show the edit task modal from patient card
        function showEditTaskModalFromCard(patientId, taskId) {
            currentPatientId = patientId; // Set the current patient ID
            currentEditingTaskId = taskId;
            
            const patientIndex = patients.findIndex(p => p.id === patientId);
            if (patientIndex === -1) return;
            
            const task = patients[patientIndex].tasks.find(t => t.id === taskId);
            if (!task) return;
            
            // Populate form fields
            editTaskText.value = task.text;
            editTaskDescription.value = task.description || '';
            editTaskPriority.value = task.priority;
            
            // Set task type based on tags
            if (task.tags && task.tags.length > 0) {
                if (task.tags.includes('bloods')) {
                    editTaskType.value = 'bloods';
                } else if (task.tags.includes('imaging')) {
                    editTaskType.value = 'imaging';
                } else if (task.tags.includes('other')) {
                    editTaskType.value = 'other';
                } else if (task.tags.includes('investigation')) {
                    editTaskType.value = 'investigation';
                } else {
                    editTaskType.value = 'none';
                }
            } else {
                editTaskType.value = 'none';
            }
            
            // Update modal title for bloods task
            const modalTitle = document.querySelector('#task-edit-modal h2');
            if (task.isBloodsTask || task.text.toLowerCase().includes("blood")) {
                modalTitle.textContent = 'Edit Bloods Task';
                
                // Add hint to include specific tests if the description is brief
                if (!task.description || task.description.length < 50) {
                    editTaskDescription.placeholder = "Specify which blood tests are required (e.g., FBC, U&Es, LFTs, Coags, etc.)";
                }
            } else {
                modalTitle.textContent = 'Edit Task';
                editTaskDescription.placeholder = "Add detailed information about this task...";
            }
            
            // Show the modal
            taskEditModal.classList.remove('hidden');
        }
        
        // Ward and Bed management functions
        
        // Initialize wards with default values if empty
        function initializeWardsIfEmpty() {
            if (wards.length === 0) {
                // Add default wards based on existing patient data
                const existingWards = new Set();
                
                patients.forEach(patient => {
                    if (patient.ward) {
                        const wardMatch = patient.ward.match(/([A-Za-z0-9]+)[-\/]/);
                        if (wardMatch && wardMatch[1]) {
                            existingWards.add(wardMatch[1]);
                        }
                    }
                });
                
                // Add extracted wards
                wards = Array.from(existingWards);
                
                // Add some default wards if none were found
                if (wards.length === 0) {
                    wards = ['A1', 'B2', 'C3', 'D4'];
                }
                
                // Save to localStorage
                localStorage.setItem('wards', JSON.stringify(wards));
            }
            
            // Initialize beds for each ward if not already done
            wards.forEach(ward => {
                if (!wardBeds[ward]) {
                    // Default 20 beds per ward (numbers 1-20)
                    wardBeds[ward] = Array.from({length: 20}, (_, i) => (i + 1).toString());
                }
            });
            
            // Save wardBeds to localStorage
            localStorage.setItem('wardBeds', JSON.stringify(wardBeds));
        }
        
        // Render the ward list in settings
        function renderWardList() {
            const wardList = document.getElementById('ward-list');
            wardList.innerHTML = '';
            
            if (wards.length === 0) {
                wardList.innerHTML = '<p class="no-items">No wards added yet. Add a ward above.</p>';
                return;
            }
            
            wards.forEach(ward => {
                const wardItem = document.createElement('div');
                wardItem.className = 'list-item';
                wardItem.innerHTML = `
                    <span class="item-name">${ward}</span>
                    <div class="item-actions">
                        <button class="edit-ward-btn" data-ward="${ward}" title="Edit Ward Name">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="edit-beds-btn" data-ward="${ward}" title="Edit Beds">
                            <i class="fas fa-bed"></i>
                        </button>
                        <button class="delete-ward-btn" data-ward="${ward}" title="Delete Ward">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
                
                wardList.appendChild(wardItem);
            });
            
            // Add event listeners
            document.querySelectorAll('.edit-ward-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const ward = this.getAttribute('data-ward');
                    showEditWardModal(ward);
                });
            });
            
            document.querySelectorAll('.edit-beds-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const ward = this.getAttribute('data-ward');
                    selectWardForBedManagement(ward);
                });
            });
            
            document.querySelectorAll('.delete-ward-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const ward = this.getAttribute('data-ward');
                    deleteWard(ward);
                });
            });
        }
        
        // Select ward for bed management
        function selectWardForBedManagement(ward) {
            currentSelectedWard = ward;
            document.getElementById('selected-ward-name').textContent = ward;
            document.getElementById('add-bed-btn').disabled = false;
            document.getElementById('sort-beds-numeric-btn').disabled = false;
            document.getElementById('sort-beds-alpha-btn').disabled = false;
            renderBedList(ward);
        }
        
        // Render bed list for a specific ward
        function renderBedList(ward) {
            const bedList = document.getElementById('bed-list');
            bedList.innerHTML = '';
            
            if (!wardBeds[ward] || wardBeds[ward].length === 0) {
                bedList.innerHTML = '<p class="no-items">No beds added for this ward yet. Add a bed above.</p>';
                return;
            }
            
            wardBeds[ward].forEach(bed => {
                const bedItem = document.createElement('div');
                bedItem.className = 'list-item';
                bedItem.setAttribute('data-bed', bed);
                bedItem.innerHTML = `
                    <div class="drag-handle" title="Drag to reorder"><i class="fas fa-grip-vertical"></i></div>
                    <span class="item-name">Bed ${bed}</span>
                    <div class="item-actions">
                        <button class="delete-bed-btn" data-bed="${bed}" title="Delete Bed">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
                
                bedList.appendChild(bedItem);
            });
            
            // Add event listeners for bed deletion
            document.querySelectorAll('.delete-bed-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const bed = this.getAttribute('data-bed');
                    deleteBed(currentSelectedWard, bed);
                });
            });
            
            // Attach drag and drop events to enable reordering
            if (typeof bedSorting !== 'undefined' && bedSorting.attachDragEvents) {
                bedSorting.attachDragEvents();
            }
            
            // Add tooltip to explain drag-and-drop
            const dragHint = document.createElement('div');
            dragHint.className = 'drag-hint';
            dragHint.innerHTML = '<i class="fas fa-info-circle"></i> Drag and drop to reorder beds, or use the sort buttons.';
            bedList.parentNode.insertBefore(dragHint, bedList.nextSibling);
        }
        
        // Add a new ward
        function addWard() {
            const newWardInput = document.getElementById('new-ward-input');
            const wardName = newWardInput.value.trim();
            
            if (wardName && !wards.includes(wardName)) {
                wards.push(wardName);
                wardBeds[wardName] = [];
                
                // Save to localStorage
                localStorage.setItem('wards', JSON.stringify(wards));
                localStorage.setItem('wardBeds', JSON.stringify(wardBeds));
                
                newWardInput.value = '';
                renderWardList();
                updateWardSelectors();
            }
        }
        
        // Delete a ward
        function deleteWard(ward) {
            if (confirm(`Are you sure you want to delete ward ${ward} and all its beds?`)) {
                // Remove the ward from the wards array
                wards = wards.filter(w => w !== ward);
                
                // Remove the ward's beds
                delete wardBeds[ward];
                
                // Save changes to localStorage
                localStorage.setItem('wards', JSON.stringify(wards));
                localStorage.setItem('wardBeds', JSON.stringify(wardBeds));
                
                renderWardList();
                updateWardSelectors();
                
                // Clear bed management if the deleted ward was selected
                if (currentSelectedWard === ward) {
                    currentSelectedWard = null;
                    document.getElementById('selected-ward-name').textContent = 'None selected';
                    document.getElementById('add-bed-btn').disabled = true;
                    document.getElementById('bed-list').innerHTML = '';
                }
            }
        }
        
        // Add a new bed to the selected ward
        function addBed() {
            if (!currentSelectedWard) return;
            
            const newBedInput = document.getElementById('new-bed-input');
            const bedIdentifier = newBedInput.value.trim();
            
            if (bedIdentifier && !wardBeds[currentSelectedWard].includes(bedIdentifier)) {
                wardBeds[currentSelectedWard].push(bedIdentifier);
                
                // Sort beds numerically if possible
                wardBeds[currentSelectedWard].sort((a, b) => {
                    const numA = parseInt(a, 10);
                    const numB = parseInt(b, 10);
                    
                    if (!isNaN(numA) && !isNaN(numB)) {
                        return numA - numB;
                    }
                    
                    return a.localeCompare(b);
                });
                
                // Save to localStorage
                localStorage.setItem('wardBeds', JSON.stringify(wardBeds));
                
                newBedInput.value = '';
                renderBedList(currentSelectedWard);
                updateWardSelectors();
            }
        }
        
        // Delete a bed from a ward
        function deleteBed(ward, bed) {
            if (!ward || !bed) return;
            
            if (confirm(`Are you sure you want to delete bed ${bed} from ward ${ward}?`)) {
                wardBeds[ward] = wardBeds[ward].filter(b => b !== bed);
                
                // Save changes to localStorage
                localStorage.setItem('wardBeds', JSON.stringify(wardBeds));
                
                renderBedList(ward);
                updateWardSelectors();
            }
        }
        
        // Update ward selectors in patient forms
        function updateWardSelectors() {
            const wardSelect = document.getElementById('patient-ward-select');
            
            // Save the current selection
            const currentValue = wardSelect.value;
            
            // Clear current options except the placeholder
            while (wardSelect.options.length > 1) {
                wardSelect.remove(1);
            }
            
            // Add ward options
            wards.forEach(ward => {
                const option = document.createElement('option');
                option.value = ward;
                option.textContent = ward;
                wardSelect.appendChild(option);
            });
            
            // Restore previous selection if valid
            if (wards.includes(currentValue)) {
                wardSelect.value = currentValue;
            }
        }
        
        // Update bed selectors based on selected ward
        function updateBedSelectors(ward) {
            const bedSelect = document.getElementById('patient-bed-select');
            
            // Clear current options except the placeholder
            while (bedSelect.options.length > 1) {
                bedSelect.remove(1);
            }
            
            if (!ward || !wardBeds[ward]) {
                bedSelect.disabled = true;
                return;
            }
            
            // Add bed options for the selected ward
            wardBeds[ward].forEach(bed => {
                const option = document.createElement('option');
                option.value = bed;
                option.textContent = `Bed ${bed}`;
                bedSelect.appendChild(option);
            });
            
            bedSelect.disabled = false;
        }
        
        // Toggle between dropdown and custom location input
        function toggleOtherLocation() {
            const isChecked = document.getElementById('other-location-toggle').checked;
            const selectGroup = document.querySelector('.location-select-group');
            const otherContainer = document.querySelector('.other-location-container');
            
            if (isChecked) {
                selectGroup.style.display = 'none';
                otherContainer.style.display = 'block';
            } else {
                selectGroup.style.display = 'flex';
                otherContainer.style.display = 'none';
            }
        }
        
        // Function to handle ward selection change
        function handleWardChange() {
            const selectedWard = this.value;
            updateBedSelectors(selectedWard);
        }
        
        // Function to update the hidden input with location value
        function updateLocationValue() {
            const otherLocationToggle = document.getElementById('other-location-toggle');
            const wardInput = document.getElementById('patient-ward-input');
            
            if (otherLocationToggle.checked) {
                // Use custom location
                const customLocation = document.getElementById('patient-other-location').value.trim();
                wardInput.value = customLocation;
                console.log('Using custom location:', customLocation);
            } else {
                // Use dropdown values
                const ward = document.getElementById('patient-ward-select').value;
                const bed = document.getElementById('patient-bed-select').value;
                
                if (ward) {
                    if (bed) {
                        // Both ward and bed are selected
                        wardInput.value = `${ward}/${bed}`;
                        console.log(`Setting location to ${ward}/${bed}`);
                    } else {
                        // Only ward is selected
                        wardInput.value = ward;
                        console.log(`Setting location to ward ${ward} without specific bed`);
                    }
                } else {
                    wardInput.value = '';
                    console.log('No ward selected');
                }
            }
        }
        
        // Function to parse existing location string and set form values
        function setLocationFormValues(locationString) {
            const otherLocationToggle = document.getElementById('other-location-toggle');
            const wardSelect = document.getElementById('patient-ward-select');
            const bedSelect = document.getElementById('patient-bed-select');
            const otherLocation = document.getElementById('patient-other-location');
            const wardInput = document.getElementById('patient-ward-input');
            
            // Default to dropdown mode
            otherLocationToggle.checked = false;
            toggleOtherLocation();
            
            if (!locationString) {
                return;
            }
            
            // Try to match the simple Ward/Bed pattern (e.g., "B4/12")
            const wardBedMatch = locationString.match(/([A-Za-z0-9]+)\/(\d+)/);
            
            if (wardBedMatch) {
                const [_, ward, bed] = wardBedMatch;
                
                // Check if the ward exists in our list
                if (wards.includes(ward)) {
                    wardSelect.value = ward;
                    updateBedSelectors(ward);
                    
                    // Check if the bed exists for this ward
                    if (wardBeds[ward] && wardBeds[ward].includes(bed)) {
                        bedSelect.value = bed;
                        return;
                    }
                }
            } else if (/^[A-Za-z0-9]+$/.test(locationString)) {
                // Check if location is just a ward name (simple string, no slashes or special chars)
                const ward = locationString;
                
                // Check if the ward exists in our list
                if (wards.includes(ward)) {
                    wardSelect.value = ward;
                    updateBedSelectors(ward);
                    bedSelect.value = ''; // No bed selected
                    return;
                }
            }
            
            // If we can't match the pattern or values aren't in our lists,
            // fall back to "other location"
            otherLocationToggle.checked = true;
            toggleOtherLocation();
            otherLocation.value = locationString;
            wardInput.value = locationString;
        }
        
        // Initialize drag-and-drop for bed reordering
        function initBedSorting() {
            const bedList = document.getElementById('bed-list');
            let dragSrcEl = null;
            
            function handleDragStart(e) {
                this.style.opacity = '0.4';
                dragSrcEl = this;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', this.innerHTML);
            }
            
            function handleDragOver(e) {
                if (e.preventDefault) {
                    e.preventDefault();
                }
                e.dataTransfer.dropEffect = 'move';
                return false;
            }
            
            function handleDragEnter() {
                this.classList.add('over');
            }
            
            function handleDragLeave() {
                this.classList.remove('over');
            }
            
            function handleDrop(e) {
                if (e.stopPropagation) {
                    e.stopPropagation();
                }
                
                if (dragSrcEl !== this) {
                    // Get the bed identifiers
                    const draggedBedId = dragSrcEl.getAttribute('data-bed');
                    const targetBedId = this.getAttribute('data-bed');
                    
                    // Get their positions in the array
                    const beds = wardBeds[currentSelectedWard];
                    const fromIndex = beds.indexOf(draggedBedId);
                    const toIndex = beds.indexOf(targetBedId);
                    
                    // Reorder the array
                    if (fromIndex !== -1 && toIndex !== -1) {
                        // Remove the item from its original position
                        const [item] = beds.splice(fromIndex, 1);
                        // Insert it at the new position
                        beds.splice(toIndex, 0, item);
                        
                        // Save to localStorage
                        localStorage.setItem('wardBeds', JSON.stringify(wardBeds));
                        
                        // Re-render the list
                        renderBedList(currentSelectedWard);
                        updateWardSelectors();
                    }
                }
                
                return false;
            }
            
            function handleDragEnd() {
                this.style.opacity = '1';
                
                document.querySelectorAll('.list-item').forEach(item => {
                    item.classList.remove('over');
                });
            }
            
            function attachDragEvents() {
                const items = document.querySelectorAll('#bed-list .list-item');
                items.forEach(item => {
                    item.setAttribute('draggable', 'true');
                    item.addEventListener('dragstart', handleDragStart, false);
                    item.addEventListener('dragenter', handleDragEnter, false);
                    item.addEventListener('dragover', handleDragOver, false);
                    item.addEventListener('dragleave', handleDragLeave, false);
                    item.addEventListener('drop', handleDrop, false);
                    item.addEventListener('dragend', handleDragEnd, false);
                });
            }
            
            return { attachDragEvents };
        }
        
        // Function to show the ward edit modal
        function showEditWardModal(ward) {
            const wardEditModal = document.getElementById('ward-edit-modal');
            const editWardNameInput = document.getElementById('edit-ward-name');
            
            // Set the current ward name
            editWardNameInput.value = ward;
            editWardNameInput.setAttribute('data-original-ward', ward);
            
            // Show the modal
            wardEditModal.classList.remove('hidden');
        }
        
        // Function to save edited ward name
        function saveEditedWard(e) {
            e.preventDefault();
            
            const editWardNameInput = document.getElementById('edit-ward-name');
            const newWardName = editWardNameInput.value.trim();
            const originalWard = editWardNameInput.getAttribute('data-original-ward');
            
            if (newWardName && originalWard && newWardName !== originalWard) {
                // Check if the new name already exists
                if (wards.includes(newWardName)) {
                    alert(`Ward "${newWardName}" already exists. Please choose a different name.`);
                    return;
                }
                
                // Update ward name in the wards array
                const wardIndex = wards.indexOf(originalWard);
                if (wardIndex !== -1) {
                    wards[wardIndex] = newWardName;
                }
                
                // Update beds for this ward
                if (wardBeds[originalWard]) {
                    wardBeds[newWardName] = [...wardBeds[originalWard]];
                    delete wardBeds[originalWard];
                }
                
                // Update patients with this ward
                patients.forEach(patient => {
                    if (patient.ward && patient.ward.startsWith(originalWard + '/')) {
                        patient.ward = patient.ward.replace(originalWard + '/', newWardName + '/');
                    } else if (patient.ward === originalWard) {
                        patient.ward = newWardName;
                    }
                });
                
                // Save changes
                localStorage.setItem('wards', JSON.stringify(wards));
                localStorage.setItem('wardBeds', JSON.stringify(wardBeds));
                localStorage.setItem('patients', JSON.stringify(patients));
                
                // Update UI
                if (currentSelectedWard === originalWard) {
                    currentSelectedWard = newWardName;
                    document.getElementById('selected-ward-name').textContent = newWardName;
                }
                
                renderWardList();
                updateWardSelectors();
                
                // Close the modal
                document.getElementById('ward-edit-modal').classList.add('hidden');
            }
        }
        
        // Sort beds numerically function
        function sortBedsNumeric() {
            if (!currentSelectedWard) return;
            
            wardBeds[currentSelectedWard].sort((a, b) => {
                const numA = parseInt(a, 10);
                const numB = parseInt(b, 10);
                
                if (!isNaN(numA) && !isNaN(numB)) {
                    return numA - numB;
                }
                
                return a.localeCompare(b);
            });
            
            // Save to localStorage
            localStorage.setItem('wardBeds', JSON.stringify(wardBeds));
            
            // Re-render
            renderBedList(currentSelectedWard);
            updateWardSelectors();
        }
        
        // Sort beds alphabetically function
        function sortBedsAlpha() {
            if (!currentSelectedWard) return;
            
            wardBeds[currentSelectedWard].sort((a, b) => a.localeCompare(b));
            
            // Save to localStorage
            localStorage.setItem('wardBeds', JSON.stringify(wardBeds));
            
            // Re-render
            renderBedList(currentSelectedWard);
            updateWardSelectors();
        }
        
        // Initialize settings and location management
        function initLocationSettings() {
            // Initialize ward and bed data
            initializeWardsIfEmpty();
            
            // Initialize the bed sorting functionality
            const bedSorting = initBedSorting();
            
            // Event listeners for settings page
            document.getElementById('add-ward-btn').addEventListener('click', addWard);
            document.getElementById('add-bed-btn').addEventListener('click', addBed);
            document.getElementById('sort-beds-numeric-btn').addEventListener('click', sortBedsNumeric);
            document.getElementById('sort-beds-alpha-btn').addEventListener('click', sortBedsAlpha);
            
            // Ward edit modal
            document.getElementById('edit-ward-form').addEventListener('submit', saveEditedWard);
            document.querySelector('.close-ward-modal').addEventListener('click', function() {
                document.getElementById('ward-edit-modal').classList.add('hidden');
            });
            
            // Close modal when clicking outside
            window.addEventListener('click', (e) => {
                const wardEditModal = document.getElementById('ward-edit-modal');
                if (e.target === wardEditModal) {
                    wardEditModal.classList.add('hidden');
                }
            });
            
            // Event listeners for location selection in patient form
            const wardSelect = document.getElementById('patient-ward-select');
            const bedSelect = document.getElementById('patient-bed-select');
            const otherLocationToggle = document.getElementById('other-location-toggle');
            const otherLocationInput = document.getElementById('patient-other-location');
            
            // Add event listener for ward selection
            wardSelect.addEventListener('change', function() {
                handleWardChange.call(this); // Update bed options
                updateLocationValue(); // Update hidden field
            });
            
            // Add event listener for bed selection
            bedSelect.addEventListener('change', function() {
                updateLocationValue(); // Update hidden field when bed changes
            });
            
            // Add event listener for other location toggle
            otherLocationToggle.addEventListener('change', function() {
                toggleOtherLocation();
                updateLocationValue(); // Update hidden field when toggle changes
            });
            
            // Add event listener for other location input
            otherLocationInput.addEventListener('input', function() {
                updateLocationValue(); // Update hidden field when custom location changes
            });
            
            // Update location values before form submission as a fail-safe
            document.getElementById('patient-form').addEventListener('submit', function() {
                updateLocationValue();
            });
            
            // Initialize the ward list and selectors
            renderWardList();
            updateWardSelectors();
            
            // Add event listener for settings tab
            document.querySelector('.main-tab-btn[data-view="settings"]').addEventListener('click', function() {
                renderWardList();
            });
            
            // Export the bed sorting functionality so it can be used in renderBedList
            return { bedSorting };
        }
        
        // Settings view
        const settingsView = document.getElementById('settings-view');
        
        // Initial render
        renderPatientList();
        
        // Initialize ward and bed settings
        const { bedSorting } = initLocationSettings();
    </script>
</body>
</html> 