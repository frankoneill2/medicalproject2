<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ward Round List</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="app-container">
        <!-- Main Navigation Tabs -->
        <div class="main-tabs">
            <button class="main-tab-btn active" data-view="patients">
                <i class="fas fa-user-injured"></i> Patients
            </button>
            <button class="main-tab-btn" data-view="all-tasks">
                <i class="fas fa-tasks"></i> All Tasks
            </button>
        </div>
        
        <!-- Main View (Patient List) -->
        <div id="patient-list-view" class="main-view active" role="region" aria-label="Patient list">
            <header>
                <div class="title-section">
                    <h1><i class="fas fa-clipboard-list"></i> Ward Round List</h1>
                    <button id="theme-toggle" class="theme-toggle" aria-label="Toggle dark mode">
                        <i class="fas fa-moon" aria-hidden="true"></i>
                    </button>
                </div>
                <div class="header-actions">
                    <button id="add-patient-btn" class="primary-btn">
                        <i class="fas fa-user-plus"></i> Add Patient
                    </button>
                </div>
            </header>
            
            <div class="search-container">
                <input type="text" id="patient-search" placeholder="Search patients...">
                <i class="fas fa-search search-icon"></i>
            </div>
            
            <div id="patients-container" class="patients-list">
                <!-- Patients will be listed here -->
            </div>
        </div>
        
        <!-- All Tasks View -->
        <div id="all-tasks-view" class="main-view" role="region" aria-label="All tasks">
            <header>
                <h1><i class="fas fa-tasks"></i> All Tasks</h1>
                <div class="header-actions">
                    <select id="task-filter" class="task-filter-select">
                        <option value="all">All Tasks</option>
                        <option value="urgent">Urgent Only</option>
                        <option value="normal">Normal Only</option>
                        <option value="in-progress">In Progress Only</option>
                        <option value="completed">Completed Only</option>
                        <option value="pending">Pending Only</option>
                    </select>
                </div>
            </header>
            
            <div class="search-container">
                <input type="text" id="task-search" placeholder="Search tasks...">
                <i class="fas fa-search search-icon"></i>
            </div>
            
            <div id="all-tasks-container">
                <!-- Tasks will be listed here -->
            </div>
        </div>
        
        <!-- Patient Detail View (Hidden initially) -->
        <div id="patient-detail-view" class="hidden" role="region" aria-label="Patient details">
            <header class="detail-header">
                <button id="back-to-list-btn" class="secondary-btn">
                    <i class="fas fa-arrow-left"></i> Back to List
                </button>
                <h2 id="patient-name-header">Patient Name</h2>
                <div class="patient-actions">
                    <button id="edit-patient-btn" class="secondary-btn">
                        <i class="fas fa-user-edit"></i> Edit
                    </button>
                    <button id="delete-patient-btn" class="danger-btn">
                        <i class="fas fa-user-minus"></i> Delete
                    </button>
                </div>
            </header>
            
            <div class="patient-info-container">
                <div class="patient-basic-info">
                    <div class="info-group">
                        <p><strong>Hospital #:</strong> <span id="patient-id"></span></p>
                        <p><strong>Age/Gender:</strong> <span id="patient-age"></span>/<span id="patient-gender"></span></p>
                    </div>
                    <div class="info-group">
                        <p><strong>Ward/Bed:</strong> <span id="patient-ward"></span></p>
                        <p><strong>Diagnoses:</strong> <span id="patient-diagnoses"></span></p>
                    </div>
                </div>
                
                <!-- Tabs for Tasks, Notes and Medical History -->
                <div class="tabs">
                    <button class="tab-btn active" data-tab="tasks">Tasks</button>
                    <button class="tab-btn" data-tab="notes">Notes</button>
                    <button class="tab-btn" data-tab="medical-history">History</button>
                </div>
                
                <!-- Tasks Tab Content -->
                <div id="tasks-tab" class="tab-content active">
                    <div class="note-form">
                        <form id="task-form" class="task-add-form">
                            <div class="form-group">
                                <input type="text" id="task-input" placeholder="Add new task title..." class="styled-input" required>
                            </div>
                            <div class="task-form-expandable" id="task-form-expandable">
                                <div class="form-group">
                                    <textarea id="task-description-input" placeholder="Add optional description..." rows="2" class="styled-textarea"></textarea>
                                </div>
                                <div class="form-row task-form-bottom">
                                    <div class="form-group priority-select-container">
                                        <select id="task-priority" class="styled-select">
                                            <option value="normal">Normal</option>
                                            <option value="urgent">Urgent</option>
                                            <option value="in-progress">In Progress</option>
                                            <option value="completed">Completed</option>
                                        </select>
                                    </div>
                                    <button type="submit" class="primary-btn">Add Task</button>
                                </div>
                            </div>
                            <div class="task-form-toggle">
                                <button type="button" id="toggle-task-details" class="toggle-details-btn">
                                    <i class="fas fa-chevron-down"></i> <span>Add details</span>
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div id="tasks-list" class="tasks-list">
                        <!-- Tasks will be added here -->
                    </div>
                </div>
                
                <!-- Notes Tab Content -->
                <div id="notes-tab" class="tab-content">
                    <div class="note-form">
                        <form id="clinical-note-form">
                            <textarea id="clinical-note-input" placeholder="Enter clinical note..." rows="3"></textarea>
                            <button type="submit" class="primary-btn">Add Note</button>
                        </form>
                    </div>
                    
                    <div id="clinical-notes-list" class="notes-list">
                        <!-- Clinical notes will be added here -->
                    </div>
                </div>
                
                <!-- Medical History Tab Content -->
                <div id="medical-history-tab" class="tab-content">
                    <div class="note-form">
                        <form id="medical-history-form">
                            <input type="text" id="diagnosis-input" placeholder="Enter diagnosis...">
                            <button type="submit" class="primary-btn">Add Diagnosis</button>
                        </form>
                    </div>
                    
                    <div id="medical-history-list" class="diagnosis-list">
                        <!-- Medical history items will be added here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Add/Edit Patient Modal (Hidden initially) -->
        <div id="patient-modal" class="modal hidden">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <h2 id="modal-title">Add New Patient</h2>
                <form id="patient-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="patient-name-input">Name</label>
                            <input type="text" id="patient-name-input" required>
                        </div>
                        <div class="form-group">
                            <label for="patient-id-input">Hospital #</label>
                            <input type="text" id="patient-id-input" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="patient-age-input">Age</label>
                            <input type="number" id="patient-age-input" min="0" max="120">
                        </div>
                        <div class="form-group">
                            <label for="patient-gender-input">Gender</label>
                            <select id="patient-gender-input">
                                <option value="">Select</option>
                                <option value="M">M</option>
                                <option value="F">F</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="patient-ward-input">Ward/Bed</label>
                            <input type="text" id="patient-ward-input" placeholder="e.g. B4/12">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="patient-diagnoses-container">Diagnoses</label>
                        <div id="patient-diagnoses-container" class="diagnoses-container">
                            <div class="diagnosis-input-group">
                                <input type="text" class="diagnosis-input styled-input" placeholder="Enter diagnosis">
                                <button type="button" class="remove-diagnosis-btn"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                        <button type="button" id="add-diagnosis-btn" class="secondary-btn"><i class="fas fa-plus"></i> Add Another Diagnosis</button>
                    </div>
                    <button type="submit" id="save-patient-btn" class="primary-btn">Save Patient</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Edit Task Modal (Hidden initially) -->
    <div id="task-edit-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-task-modal">&times;</span>
            <h2>Edit Task</h2>
            <form id="edit-task-form" class="styled-form">
                <div class="form-section">
                    <h3 class="form-section-title">Task Details</h3>
                    <div class="form-group">
                        <label for="edit-task-text">Title</label>
                        <input type="text" id="edit-task-text" class="styled-input" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-task-description">Description (Optional)</label>
                        <textarea id="edit-task-description" class="styled-textarea" rows="3" placeholder="Add detailed information about this task..."></textarea>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3 class="form-section-title">Task Status</h3>
                    <div class="form-group">
                        <label for="edit-task-priority">Priority</label>
                        <select id="edit-task-priority" class="styled-select" required>
                            <option value="normal">Normal</option>
                            <option value="urgent">Urgent</option>
                            <option value="in-progress">In Progress</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="primary-btn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Data structure
        let patients = JSON.parse(localStorage.getItem('patients') || '[]');
        let currentPatientId = null;
        
        // If no patients exist, add sample data
        if (patients.length === 0) {
            patients = [
                {
                    id: 'MRN12345',
                    name: 'John Smith',
                    age: 67,
                    gender: 'M',
                    ward: 'B4/12',
                    diagnoses: ['Myocardial Infarction', 'Hypertension', 'Type 2 Diabetes'],
                    tasks: [
                        {
                            id: Date.now() - 50000,
                            text: 'Arrange echo',
                            priority: 'normal',
                            date: new Date(Date.now() - 50000).toLocaleString()
                        },
                        {
                            id: Date.now() - 60000,
                            text: 'Cardiology review',
                            priority: 'urgent',
                            date: new Date(Date.now() - 60000).toLocaleString()
                        },
                        {
                            id: Date.now() - 70000,
                            text: 'Discharge planning',
                            priority: 'completed',
                            date: new Date(Date.now() - 70000).toLocaleString()
                        }
                    ],
                    clinicalNotes: [
                        {
                            id: Date.now() - 100000,
                            text: 'Patient admitted with chest pain. ECG shows ST elevation in leads V1-V4. Started on aspirin and referred for urgent angiography.',
                            date: new Date(Date.now() - 100000).toLocaleString()
                        }
                    ],
                    medicalHistory: [
                        {
                            id: Date.now() - 200000,
                            diagnoses: ['Hypertension'],
                            date: new Date(Date.now() - 200000).toLocaleString()
                        },
                        {
                            id: Date.now() - 300000,
                            diagnoses: ['Type 2 Diabetes'],
                            date: new Date(Date.now() - 300000).toLocaleString()
                        }
                    ]
                },
                {
                    id: 'MRN67890',
                    name: 'Sarah Johnson',
                    age: 42,
                    gender: 'F',
                    ward: 'A2/05',
                    diagnoses: ['Subarachnoid Hemorrhage', 'Migraine'],
                    tasks: [
                        {
                            id: Date.now() - 55000,
                            text: 'Nimodipine due at 2pm',
                            priority: 'urgent',
                            date: new Date(Date.now() - 55000).toLocaleString()
                        },
                        {
                            id: Date.now() - 65000,
                            text: 'Check Na+',
                            priority: 'normal',
                            date: new Date(Date.now() - 65000).toLocaleString()
                        }
                    ],
                    clinicalNotes: [
                        {
                            id: Date.now() - 400000,
                            text: 'Patient presented with sudden onset headache and neck stiffness. CT scan shows subarachnoid hemorrhage. Neurosurgery consulted.',
                            date: new Date(Date.now() - 400000).toLocaleString()
                        }
                    ],
                    medicalHistory: [
                        {
                            id: Date.now() - 500000,
                            diagnoses: ['Migraine'],
                            date: new Date(Date.now() - 500000).toLocaleString()
                        }
                    ]
                },
                {
                    id: 'MRN24680',
                    name: 'Michael Chen',
                    age: 55,
                    gender: 'M',
                    ward: 'C1/08',
                    diagnoses: ['Colorectal Adenocarcinoma', 'Hyperlipidemia'],
                    tasks: [
                        {
                            id: Date.now() - 75000,
                            text: 'Prescribe antiemetics',
                            priority: 'normal',
                            date: new Date(Date.now() - 75000).toLocaleString()
                        },
                        {
                            id: Date.now() - 85000,
                            text: 'Discuss scan results',
                            priority: 'urgent',
                            date: new Date(Date.now() - 85000).toLocaleString()
                        },
                        {
                            id: Date.now() - 95000,
                            text: 'Order CBC',
                            priority: 'completed',
                            date: new Date(Date.now() - 95000).toLocaleString()
                        }
                    ],
                    clinicalNotes: [
                        {
                            id: Date.now() - 600000,
                            text: 'Cycle 3 of FOLFOX chemotherapy administered today. Patient tolerating treatment well with mild peripheral neuropathy.',
                            date: new Date(Date.now() - 600000).toLocaleString()
                        }
                    ],
                    medicalHistory: [
                        {
                            id: Date.now() - 700000,
                            diagnoses: ['Colorectal Adenocarcinoma'],
                            date: new Date(Date.now() - 700000).toLocaleString()
                        },
                        {
                            id: Date.now() - 800000,
                            diagnoses: ['Hyperlipidemia'],
                            date: new Date(Date.now() - 800000).toLocaleString()
                        }
                    ]
                }
            ];
            localStorage.setItem('patients', JSON.stringify(patients));
        }
        
        // DOM Elements
        const patientListView = document.getElementById('patient-list-view');
        const patientDetailView = document.getElementById('patient-detail-view');
        const patientsContainer = document.getElementById('patients-container');
        const patientSearch = document.getElementById('patient-search');
        const addPatientBtn = document.getElementById('add-patient-btn');
        const backToListBtn = document.getElementById('back-to-list-btn');
        const editPatientBtn = document.getElementById('edit-patient-btn');
        const deletePatientBtn = document.getElementById('delete-patient-btn');
        const patientModal = document.getElementById('patient-modal');
        const closeModal = document.querySelector('.close-modal');
        const patientForm = document.getElementById('patient-form');
        const modalTitle = document.getElementById('modal-title');
        const diagnosesContainer = document.getElementById('patient-diagnoses-container');
        const addDiagnosisBtn = document.getElementById('add-diagnosis-btn');
        const taskForm = document.getElementById('task-form');
        const taskInput = document.getElementById('task-input');
        const taskDescriptionInput = document.getElementById('task-description-input');
        const taskPriority = document.getElementById('task-priority');
        const taskFormExpandable = document.getElementById('task-form-expandable');
        const toggleTaskDetailsBtn = document.getElementById('toggle-task-details');
        const tasksList = document.getElementById('tasks-list');
        const clinicalNoteForm = document.getElementById('clinical-note-form');
        const clinicalNoteInput = document.getElementById('clinical-note-input');
        const clinicalNotesList = document.getElementById('clinical-notes-list');
        const medicalHistoryForm = document.getElementById('medical-history-form');
        const diagnosisInput = document.getElementById('diagnosis-input');
        const medicalHistoryList = document.getElementById('medical-history-list');
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // Task Edit Modal Elements
        const taskEditModal = document.getElementById('task-edit-modal');
        const closeTaskModal = document.querySelector('.close-task-modal');
        const editTaskForm = document.getElementById('edit-task-form');
        const editTaskText = document.getElementById('edit-task-text');
        const editTaskDescription = document.getElementById('edit-task-description');
        const editTaskPriority = document.getElementById('edit-task-priority');
        let currentEditingTaskId = null;
        
        // Get main tab elements
        const mainTabButtons = document.querySelectorAll('.main-tab-btn');
        const mainViews = document.querySelectorAll('.main-view');
        const allTasksView = document.getElementById('all-tasks-view');
        const allTasksContainer = document.getElementById('all-tasks-container');
        const taskFilter = document.getElementById('task-filter');
        const taskSearch = document.getElementById('task-search');
        
        // At the top of your script section, add these variables and functions
        const themeToggle = document.getElementById('theme-toggle');
        
        // Function to set theme
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            
            // Update theme toggle icon
            if (theme === 'dark') {
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            }
        }
        
        // Check for saved theme preference
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                setTheme(savedTheme);
            } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                // Use dark mode if user prefers dark mode
                setTheme('dark');
            } else {
                // Default to light mode
                setTheme('light');
            }
        }
        
        // Event listener for theme toggle
        themeToggle.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
        });
        
        // Call initTheme at the bottom of your script section, before the initial render
        initTheme();
        
        // Add this function to create patient cards
        function createPatientCard(patient) {
            const patientCard = document.createElement('div');
            patientCard.className = 'patient-card';
            
            // Count tasks by priority
            const taskCounts = {
                normal: 0,
                urgent: 0,
                'in-progress': 0,
                completed: 0
            };
            
            if (patient.tasks) {
                patient.tasks.forEach(task => {
                    if (taskCounts.hasOwnProperty(task.priority)) {
                        taskCounts[task.priority]++;
                    }
                });
            }
            
            // Get primary diagnosis for card display
            let primaryDiagnosis = 'No diagnosis';
            if (patient.diagnoses && patient.diagnoses.length > 0) {
                primaryDiagnosis = patient.diagnoses[0];
                
                // If there are multiple diagnoses, add a count
                if (patient.diagnoses.length > 1) {
                    primaryDiagnosis += ` +${patient.diagnoses.length - 1}`;
                }
            } else if (patient.diagnosis) {
                // For backward compatibility
                primaryDiagnosis = patient.diagnosis;
            }
            
            patientCard.innerHTML = `
                <div class="patient-card-content">
                    <div class="patient-main-info">
                        <h3 class="patient-name">${patient.name}</h3>
                        <div class="patient-quick-info">
                            <span class="patient-location">${patient.ward || ''}</span>
                            <span class="patient-id">${patient.id}</span>
                        </div>
                    </div>
                    <div class="patient-secondary-info">
                        <div class="diagnosis-badge">${primaryDiagnosis}</div>
                        <div class="patient-age-gender">${patient.age || '-'}/${patient.gender || '-'}</div>
                    </div>
                    <div class="patient-footer">
                        <div class="task-indicators">
                            ${taskCounts.urgent > 0 ? 
                            `<div class="task-indicator urgent-indicator">
                                <span class="task-count urgent">${taskCounts.urgent}</span>
                            </div>` : ''}
                            ${taskCounts.normal > 0 ? 
                            `<div class="task-indicator normal-indicator">
                                <span class="task-count normal">${taskCounts.normal}</span>
                            </div>` : ''}
                            ${taskCounts['in-progress'] > 0 ? 
                            `<div class="task-indicator progress-indicator">
                                <span class="task-count in-progress">${taskCounts['in-progress']}</span>
                            </div>` : ''}
                            ${taskCounts.completed > 0 ? 
                            `<div class="task-indicator completed-indicator">
                                <span class="task-count completed">${taskCounts.completed}</span>
                            </div>` : ''}
                        </div>
                        <button class="view-patient-btn" data-id="${patient.id}">View</button>
                    </div>
                </div>
            `;
            
            // Add event listener to view button
            patientCard.querySelector('.view-patient-btn').addEventListener('click', function() {
                const patientId = this.getAttribute('data-id');
                showPatientDetails(patientId);
            });
            
            return patientCard;
        }
        
        // Render patient list
        function renderPatientList(searchTerm = '') {
            // Group patients by ward
            const patientsByWard = {};
            
            patients.forEach(patient => {
                // Extract the ward name without "Ward " prefix if it exists
                let wardName = patient.ward.split('/')[0];
                
                // Remove "Ward " prefix if it exists
                wardName = wardName.replace(/^Ward\s+/i, '');
                
                if (!patientsByWard[wardName]) {
                    patientsByWard[wardName] = [];
                }
                patientsByWard[wardName].push(patient);
            });
            
            // Clear the container
            patientsContainer.innerHTML = '';
            
            // Create and display wards
            Object.keys(patientsByWard).sort().forEach(ward => {
                const wardPatients = patientsByWard[ward];
                
                // Filter patients if search term is provided
                const filteredPatients = searchTerm 
                    ? wardPatients.filter(patient => 
                        patient.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        patient.id.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        patient.diagnosis.toLowerCase().includes(searchTerm.toLowerCase()))
                    : wardPatients;
                    
                if (filteredPatients.length === 0) return;
                
                const wardGroup = document.createElement('div');
                wardGroup.className = 'ward-group';
                
                const wardHeader = document.createElement('div');
                wardHeader.className = 'ward-header';
                wardHeader.innerHTML = `<i class="fas fa-hospital"></i> ${ward}`;
                
                wardGroup.appendChild(wardHeader);
                
                // Sort patients by bed number within the ward
                filteredPatients.sort((a, b) => {
                    // Handle empty ward fields
                    const aWard = a.ward || '';
                    const bWard = b.ward || '';
                    
                    // Function to extract bed number from ward string
                    const extractBedNumber = (wardString) => {
                        // Common formats: "B4/12", "Ward B4 Bed 12", "4-12", etc.
                        
                        // Try to find bed number after a slash (most common format like B4/12)
                        const slashMatch = wardString.match(/\/(\d+)/);
                        if (slashMatch) return parseInt(slashMatch[1]);
                        
                        // Try to find bed number after "bed" or "bay" (like "Ward B4 Bed 12")
                        const bedMatch = wardString.match(/bed\s+(\d+)/i);
                        if (bedMatch) return parseInt(bedMatch[1]);
                        
                        // Try to find bed number after a dash (like "4-12")
                        const dashMatch = wardString.match(/-(\d+)/);
                        if (dashMatch) return parseInt(dashMatch[1]);
                        
                        // If all else fails, just find any number at the end
                        const endMatch = wardString.match(/(\d+)$/);
                        if (endMatch) return parseInt(endMatch[1]);
                        
                        // No bed number found
                        return Infinity;
                    };
                    
                    // Get bed numbers
                    const aBed = extractBedNumber(aWard);
                    const bBed = extractBedNumber(bWard);
                    
                    // Sort by bed number, putting patients without bed numbers at the end
                    return aBed - bBed;
                });
                
                // Add patients for this ward
                filteredPatients.forEach(patient => {
                    // Create patient card
                    const patientCard = createPatientCard(patient);
                    wardGroup.appendChild(patientCard);
                });
                
                patientsContainer.appendChild(wardGroup);
            });
            
            // Show message if no patients found
            if (patientsContainer.children.length === 0) {
                patientsContainer.innerHTML = '<p class="no-items">No patients found. Add a patient or adjust your search.</p>';
            }
        }
        
        // Show patient details
        function showPatientDetails(patientId) {
            currentPatientId = patientId;
            const patient = patients.find(p => p.id === patientId);
            
            if (!patient) return;
            
            // Update patient info
            document.getElementById('patient-name-header').textContent = patient.name;
            document.getElementById('patient-id').textContent = patient.id;
            document.getElementById('patient-age').textContent = patient.age || 'Not specified';
            document.getElementById('patient-gender').textContent = patient.gender || 'Not specified';
            document.getElementById('patient-ward').textContent = patient.ward || 'Not specified';
            
            // Format diagnoses for display
            let diagnosesText = 'None';
            if (patient.diagnoses && patient.diagnoses.length > 0) {
                diagnosesText = patient.diagnoses.join(', ');
            } else if (patient.diagnosis) {
                // For backward compatibility with older data structure
                diagnosesText = patient.diagnosis;
            }
            document.getElementById('patient-diagnoses').textContent = diagnosesText;
            
            // Show patient detail view FIRST, then render components
            patientListView.classList.add('hidden');
            allTasksView.classList.add('hidden');
            patientDetailView.classList.remove('hidden');
            
            // Now render everything with the patient
            renderTasks(patient);
            renderClinicalNotes(patient);
            renderMedicalHistory(patient);
            
            // Reset to tasks tab
            document.querySelector('.tab-btn[data-tab="tasks"]').click();
        }
        
        // Render tasks
        function renderTasks(patient) {
            const tasksList = document.getElementById('tasks-list');
            tasksList.innerHTML = '';
            
            // Make sure we have a valid patient
            if (!patient) {
                tasksList.innerHTML = '<p class="no-items">No tasks available.</p>';
                return;
            }
            
            if (!patient.tasks || patient.tasks.length === 0) {
                tasksList.innerHTML = '<p class="no-items">No tasks yet. Add a task above.</p>';
                return;
            }
            
            // Group tasks by status
            const normalTasks = patient.tasks.filter(task => 
                task.priority === 'normal' || task.priority === 'urgent');
            const inProgressTasks = patient.tasks.filter(task => 
                task.priority === 'in-progress');
            const completedTasks = patient.tasks.filter(task => 
                task.priority === 'completed');
            
            // Normal Tasks Section
            if (normalTasks.length > 0) {
                const normalSection = document.createElement('div');
                normalSection.className = 'task-status-section';
                normalSection.innerHTML = `<h4><i class="fas fa-clipboard-list"></i> Pending Tasks</h4>`;
                
                // Sort by urgency then date
                normalTasks.sort((a, b) => {
                    if (a.priority === 'urgent' && b.priority !== 'urgent') return -1;
                    if (a.priority !== 'urgent' && b.priority === 'urgent') return 1;
                    return new Date(b.date) - new Date(a.date);
                });
                
                normalTasks.forEach(task => {
                    const taskItem = document.createElement('div');
                    taskItem.className = `task-item ${task.priority}`;
                    taskItem.innerHTML = `
                        <div class="task-content">
                            <div class="task-text">${task.text}</div>
                            ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                            <div class="task-date">${task.date}</div>
                        </div>
                        <div class="task-actions">
                            <button class="edit-task-btn" data-id="${task.id}" title="Edit Task">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="toggle-task-status-btn" data-id="${task.id}" data-status="normal" data-next-state="Mark In Progress" title="Toggle Status">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="complete-task-btn" data-id="${task.id}" title="Mark Complete">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="delete-task-btn" data-id="${task.id}" title="Delete Task">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    `;
                    normalSection.appendChild(taskItem);
                });
                
                tasksList.appendChild(normalSection);
            }
            
            // In Progress Tasks Section
            if (inProgressTasks.length > 0) {
                const progressSection = document.createElement('div');
                progressSection.className = 'task-status-section';
                progressSection.innerHTML = `<h4><i class="fas fa-spinner"></i> In Progress</h4>`;
                
                inProgressTasks.forEach(task => {
                    const taskItem = document.createElement('div');
                    taskItem.className = `task-item in-progress`;
                    taskItem.innerHTML = `
                        <div class="task-content">
                            <div class="task-text">${task.text}</div>
                            ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                            <div class="task-date">${task.progressDate || task.date}</div>
                        </div>
                        <div class="task-actions">
                            <button class="edit-task-btn" data-id="${task.id}" title="Edit Task">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="toggle-task-status-btn" data-id="${task.id}" data-status="in-progress" data-next-state="Mark Complete" title="Toggle Status">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="delete-task-btn" data-id="${task.id}" title="Delete Task">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    `;
                    progressSection.appendChild(taskItem);
                });
                
                tasksList.appendChild(progressSection);
            }
            
            // Completed Tasks Section
            if (completedTasks.length > 0) {
                const completedSection = document.createElement('div');
                completedSection.className = 'task-status-section';
                completedSection.innerHTML = `<h4><i class="fas fa-check-circle"></i> Completed</h4>`;
                
                completedTasks.forEach(task => {
                    const taskItem = document.createElement('div');
                    taskItem.className = `task-item completed`;
                    taskItem.innerHTML = `
                        <div class="task-content">
                            <div class="task-text">${task.text}</div>
                            ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                            <div class="task-date">${task.completedDate || task.date}</div>
                        </div>
                        <div class="task-actions">
                            <button class="edit-task-btn" data-id="${task.id}" title="Edit Task">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="toggle-task-status-btn" data-id="${task.id}" data-status="completed" data-next-state="Reopen Task" title="Toggle Status">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="delete-task-btn" data-id="${task.id}" title="Delete Task">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    `;
                    completedSection.appendChild(taskItem);
                });
                
                tasksList.appendChild(completedSection);
            }
            
            // Add event listeners for the buttons
            document.querySelectorAll('#tasks-list .toggle-task-status-btn').forEach(button => {
                button.addEventListener('click', toggleTaskStatus);
            });
            
            document.querySelectorAll('#tasks-list .delete-task-btn').forEach(button => {
                button.addEventListener('click', deleteTask);
            });
            
            document.querySelectorAll('#tasks-list .edit-task-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const taskId = parseInt(this.getAttribute('data-id'));
                    showEditTaskModal(taskId);
                });
            });
            
            document.querySelectorAll('#tasks-list .complete-task-btn').forEach(button => {
                button.addEventListener('click', markTaskComplete);
            });
        }
        
        // New function to toggle task status in a cycle
        function toggleTaskStatus() {
            const taskId = parseInt(this.getAttribute('data-id'));
            const currentStatus = this.getAttribute('data-status');
            const patient = patients.find(p => p.id === currentPatientId);
            
            if (!patient) return;
            
            const taskIndex = patient.tasks.findIndex(task => task.id === taskId);
            if (taskIndex === -1) return;
            
            // Cycle through statuses: normal → in-progress → completed → normal
            if (currentStatus === 'normal' || currentStatus === 'urgent') {
                // Move to in-progress
                patient.tasks[taskIndex].priority = 'in-progress';
                patient.tasks[taskIndex].progressDate = new Date().toLocaleString();
            } else if (currentStatus === 'in-progress') {
                // Move to completed
                patient.tasks[taskIndex].priority = 'completed';
                patient.tasks[taskIndex].completedDate = new Date().toLocaleString();
            } else if (currentStatus === 'completed') {
                // Move back to normal
                patient.tasks[taskIndex].priority = 'normal';
                delete patient.tasks[taskIndex].completedDate;
                delete patient.tasks[taskIndex].progressDate;
            }
            
            localStorage.setItem('patients', JSON.stringify(patients));
            renderTasks(patient);
        }
        
        // Function to mark a task as complete directly from pending
        function markTaskComplete() {
            const taskId = parseInt(this.getAttribute('data-id'));
            const patient = patients.find(p => p.id === currentPatientId);
            
            if (!patient) return;
            
            const taskIndex = patient.tasks.findIndex(task => task.id === taskId);
            if (taskIndex === -1) return;
            
            // Set directly to completed
            patient.tasks[taskIndex].priority = 'completed';
            patient.tasks[taskIndex].completedDate = new Date().toLocaleString();
            
            localStorage.setItem('patients', JSON.stringify(patients));
            renderTasks(patient);
        }
        
        // Render clinical notes
        function renderClinicalNotes(patient) {
            clinicalNotesList.innerHTML = '';
            
            if (!patient.clinicalNotes || patient.clinicalNotes.length === 0) {
                clinicalNotesList.innerHTML = '<p class="no-notes">No clinical notes yet.</p>';
                return;
            }
            
            // Sort notes by date (newest first)
            const sortedNotes = [...patient.clinicalNotes].sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );
            
            sortedNotes.forEach(note => {
                const noteElement = document.createElement('div');
                noteElement.className = 'note';
                noteElement.innerHTML = `
                    <div class="note-header">
                        <span class="note-date">${note.date}</span>
                        <button class="delete-note-btn" data-id="${note.id}">×</button>
                    </div>
                    <p class="note-text">${note.text}</p>
                `;
                clinicalNotesList.appendChild(noteElement);
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-note-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const noteId = parseInt(this.getAttribute('data-id'));
                    deleteClinicalNote(noteId);
                });
            });
        }
        
        // Render medical history
        function renderMedicalHistory(patient) {
            medicalHistoryList.innerHTML = '';
            
            if (!patient.medicalHistory || patient.medicalHistory.length === 0) {
                medicalHistoryList.innerHTML = '<p class="no-notes">No medical history recorded.</p>';
                return;
            }
            
            patient.medicalHistory.forEach(item => {
                const historyElement = document.createElement('div');
                historyElement.className = 'diagnosis-item';
                historyElement.innerHTML = `
                    <div class="diagnosis-header">
                        <span class="diagnosis-text">${item.diagnosis}</span>
                        <div class="diagnosis-actions">
                            <button class="delete-diagnosis-btn" data-id="${item.id}">×</button>
                        </div>
                    </div>
                `;
                medicalHistoryList.appendChild(historyElement);
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-diagnosis-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const diagnosisId = parseInt(this.getAttribute('data-id'));
                    deleteDiagnosis(diagnosisId);
                });
            });
        }
        
        // Add task
        function addTask(e) {
            e.preventDefault();
            const text = taskInput.value.trim();
            const description = taskDescriptionInput.value.trim();
            const priority = taskPriority.value;
            
            if (text && currentPatientId) {
                const patientIndex = patients.findIndex(p => p.id === currentPatientId);
                
                if (patientIndex === -1) return;
                
                const newTask = {
                    id: Date.now(),
                    text,
                    description,
                    priority,
                    date: new Date().toLocaleString()
                };
                
                if (!patients[patientIndex].tasks) {
                    patients[patientIndex].tasks = [];
                }
                
                patients[patientIndex].tasks.push(newTask);
                localStorage.setItem('patients', JSON.stringify(patients));
                
                // Reset form
                taskInput.value = '';
                taskDescriptionInput.value = '';
                taskPriority.value = 'normal';
                
                // Hide the expanded section
                if (taskFormExpandable.classList.contains('expanded')) {
                    toggleTaskDetails();
                }
                
                renderTasks(patients[patientIndex]);
            }
        }
        
        // Delete task
        function deleteTask() {
            const taskId = parseInt(this.getAttribute('data-id'));
            const patient = patients.find(p => p.id === currentPatientId);
            
            if (!patient) return;
            
            // Find the task index and remove it
            const taskIndex = patient.tasks.findIndex(task => task.id === taskId);
            if (taskIndex !== -1) {
                // Confirm before deleting
                if (confirm('Are you sure you want to delete this task?')) {
                    patient.tasks.splice(taskIndex, 1);
                    localStorage.setItem('patients', JSON.stringify(patients));
                    renderTasks(patient);
                }
            }
        }
        
        // Add clinical note
        function addClinicalNote(e) {
            e.preventDefault();
            const text = clinicalNoteInput.value.trim();
            
            if (text && currentPatientId) {
                const patientIndex = patients.findIndex(p => p.id === currentPatientId);
                
                if (patientIndex === -1) return;
                
                const newNote = {
                    id: Date.now(),
                    text,
                    date: new Date().toLocaleString()
                };
                
                if (!patients[patientIndex].clinicalNotes) {
                    patients[patientIndex].clinicalNotes = [];
                }
                
                patients[patientIndex].clinicalNotes.push(newNote);
                localStorage.setItem('patients', JSON.stringify(patients));
                clinicalNoteInput.value = '';
                renderClinicalNotes(patients[patientIndex]);
            }
        }
        
        // Delete clinical note
        function deleteClinicalNote(noteId) {
            const patientIndex = patients.findIndex(p => p.id === currentPatientId);
            
            if (patientIndex === -1) return;
            
            patients[patientIndex].clinicalNotes = patients[patientIndex].clinicalNotes.filter(
                note => note.id !== noteId
            );
            
            localStorage.setItem('patients', JSON.stringify(patients));
            renderClinicalNotes(patients[patientIndex]);
        }
        
        // Add diagnosis to medical history
        function addDiagnosis(e) {
            e.preventDefault();
            const diagnosis = diagnosisInput.value.trim();
            
            if (diagnosis && currentPatientId) {
                const patientIndex = patients.findIndex(p => p.id === currentPatientId);
                
                if (patientIndex === -1) return;
                
                const newDiagnosis = {
                    id: Date.now(),
                    diagnosis,
                    date: new Date().toLocaleString()
                };
                
                if (!patients[patientIndex].medicalHistory) {
                    patients[patientIndex].medicalHistory = [];
                }
                
                patients[patientIndex].medicalHistory.push(newDiagnosis);
                localStorage.setItem('patients', JSON.stringify(patients));
                diagnosisInput.value = '';
                renderMedicalHistory(patients[patientIndex]);
            }
        }
        
        // Delete diagnosis
        function deleteDiagnosis(diagnosisId) {
            const patientIndex = patients.findIndex(p => p.id === currentPatientId);
            
            if (patientIndex === -1) return;
            
            patients[patientIndex].medicalHistory = patients[patientIndex].medicalHistory.filter(
                item => item.id !== diagnosisId
            );
            
            localStorage.setItem('patients', JSON.stringify(patients));
            renderMedicalHistory(patients[patientIndex]);
        }
        
        // Show add patient modal
        function showAddPatientModal() {
            modalTitle.textContent = 'Add New Patient';
            patientForm.reset();
            patientModal.classList.remove('hidden');
        }
        
        // Show edit patient modal
        function showEditPatientModal() {
            const patient = patients.find(p => p.id === currentPatientId);
            
            if (!patient) return;
            
            modalTitle.textContent = 'Edit Patient';
            document.getElementById('patient-name-input').value = patient.name;
            document.getElementById('patient-id-input').value = patient.id;
            document.getElementById('patient-age-input').value = patient.age;
            document.getElementById('patient-gender-input').value = patient.gender;
            document.getElementById('patient-ward-input').value = patient.ward;
            
            // Clear existing diagnosis inputs except the first one
            diagnosesContainer.innerHTML = '';
            
            // Add diagnosis inputs based on patient data
            if (patient.diagnoses && patient.diagnoses.length > 0) {
                patient.diagnoses.forEach((diagnosis, index) => {
                    addDiagnosisInput(diagnosis);
                });
            } else if (patient.diagnosis) {
                // For backward compatibility
                addDiagnosisInput(patient.diagnosis);
            } else {
                // Add an empty diagnosis input if none exist
                addDiagnosisInput('');
            }
            
            patientModal.classList.remove('hidden');
        }
        
        // Function to add a diagnosis input field
        function addDiagnosisInput(value = '') {
            const diagnosisGroup = document.createElement('div');
            diagnosisGroup.className = 'diagnosis-input-group';
            diagnosisGroup.innerHTML = `
                <input type="text" class="diagnosis-input styled-input" placeholder="Enter diagnosis" value="${value}">
                <button type="button" class="remove-diagnosis-btn"><i class="fas fa-times"></i></button>
            `;
            
            diagnosesContainer.appendChild(diagnosisGroup);
            
            // Add event listener to remove button
            const removeBtn = diagnosisGroup.querySelector('.remove-diagnosis-btn');
            removeBtn.addEventListener('click', function() {
                // Don't remove if it's the last diagnosis field
                if (diagnosesContainer.querySelectorAll('.diagnosis-input-group').length > 1) {
                    diagnosisGroup.remove();
                }
            });
        }
        
        // Save patient (add or edit)
        function savePatient(e) {
            e.preventDefault();
            
            // Collect diagnoses from all input fields
            const diagnoses = [];
            document.querySelectorAll('.diagnosis-input').forEach(input => {
                const value = input.value.trim();
                if (value) {
                    diagnoses.push(value);
                }
            });
            
            // Handle potentially empty fields
            const ageInput = document.getElementById('patient-age-input').value;
            
            const patientData = {
                name: document.getElementById('patient-name-input').value,
                id: document.getElementById('patient-id-input').value,
                age: ageInput ? parseInt(ageInput) : '',
                gender: document.getElementById('patient-gender-input').value || '',
                ward: document.getElementById('patient-ward-input').value || '',
                diagnoses: diagnoses
            };
            
            if (modalTitle.textContent === 'Edit Patient') {
                // Edit existing patient
                const patientIndex = patients.findIndex(p => p.id === currentPatientId);
                
                if (patientIndex === -1) return;
                
                // Preserve notes, tasks and medical history
                patientData.tasks = patients[patientIndex].tasks || [];
                patientData.clinicalNotes = patients[patientIndex].clinicalNotes || [];
                patientData.medicalHistory = patients[patientIndex].medicalHistory || [];
                
                patients[patientIndex] = patientData;
                
                // Update current patient ID in case hospital number changed
                currentPatientId = patientData.id;
                
                // Update patient details view
                document.getElementById('patient-name-header').textContent = patientData.name;
                document.getElementById('patient-id').textContent = patientData.id;
                document.getElementById('patient-age').textContent = patientData.age || 'Not specified';
                document.getElementById('patient-gender').textContent = patientData.gender || 'Not specified';
                document.getElementById('patient-ward').textContent = patientData.ward || 'Not specified';
                document.getElementById('patient-diagnoses').textContent = patientData.diagnoses.length > 0 ? patientData.diagnoses.join(', ') : 'None';
            } else {
                // Add new patient
                patientData.tasks = [];
                patientData.clinicalNotes = [];
                patientData.medicalHistory = [];
                patients.push(patientData);
            }
            
            localStorage.setItem('patients', JSON.stringify(patients));
            patientModal.classList.add('hidden');
            renderPatientList();
        }
        
        // Delete patient
        function deletePatient() {
            const confirmDialog = document.createElement('div');
            confirmDialog.className = 'confirm-dialog';
            confirmDialog.innerHTML = `
                <div class="confirm-dialog-content">
                    <h3>Delete Patient</h3>
                    <p>Are you sure you want to delete this patient and all their data? This action cannot be undone.</p>
                    <div class="confirm-dialog-actions">
                        <button class="secondary-btn" id="cancel-delete">Cancel</button>
                        <button class="danger-btn" id="confirm-delete">Delete</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmDialog);
            
            document.getElementById('cancel-delete').addEventListener('click', () => {
                document.body.removeChild(confirmDialog);
            });
            
            document.getElementById('confirm-delete').addEventListener('click', () => {
                // Actual deletion logic
                patients = patients.filter(p => p.id !== currentPatientId);
                localStorage.setItem('patients', JSON.stringify(patients));
                document.body.removeChild(confirmDialog);
                
                patientDetailView.classList.add('hidden');
                patientListView.classList.remove('hidden');
                renderPatientList();
            });
        }
        
        // Search patients
        function searchPatients() {
            const searchTerm = this.value.trim().toLowerCase();
            renderPatientList(searchTerm);
        }
        
        // Function to render all tasks
        function renderAllTasks(filter = 'all', searchTerm = '') {
            allTasksContainer.innerHTML = '';
            
            // Group tasks by ward and completion status
            const tasksByWard = {};
            let totalTasksFound = 0;
            
            patients.forEach(patient => {
                if (!patient.tasks || patient.tasks.length === 0) return;
                
                const wardName = patient.ward.split('/')[0]; // Extract ward part
                
                if (!tasksByWard[wardName]) {
                    tasksByWard[wardName] = {
                        pending: [],
                        'in-progress': [],
                        completed: []
                    };
                }
                
                patient.tasks.forEach(task => {
                    // Apply filters
                    if (filter !== 'all') {
                        if (filter === 'urgent' && task.priority !== 'urgent') return;
                        if (filter === 'normal' && task.priority !== 'normal') return;
                        if (filter === 'in-progress' && task.priority !== 'in-progress') return;
                        if (filter === 'completed' && task.priority !== 'completed') return;
                        if (filter === 'pending' && (task.priority === 'completed' || task.priority === 'in-progress')) return;
                    }
                    
                    // Apply search term
                    if (searchTerm && !task.text.toLowerCase().includes(searchTerm.toLowerCase())) {
                        return;
                    }
                    
                    // Add patient info to task
                    const taskWithPatient = {
                        ...task,
                        patientName: patient.name,
                        patientId: patient.id,
                        ward: patient.ward
                    };
                    
                    // Group by status
                    if (task.priority === 'completed') {
                        tasksByWard[wardName].completed.push(taskWithPatient);
                    } else if (task.priority === 'in-progress') {
                        tasksByWard[wardName]['in-progress'].push(taskWithPatient);
                    } else {
                        tasksByWard[wardName].pending.push(taskWithPatient);
                    }
                    
                    totalTasksFound++;
                });
            });
            
            if (totalTasksFound === 0) {
                allTasksContainer.innerHTML = `
                    <div class="no-tasks">
                        <i class="fas fa-check-circle"></i>
                        <p>No tasks found matching your criteria</p>
                    </div>
                `;
                return;
            }
            
            // Sort wards alphabetically
            const sortedWards = Object.keys(tasksByWard).sort();
            
            sortedWards.forEach(ward => {
                const wardGroup = document.createElement('div');
                wardGroup.className = 'ward-group';
                
                const wardHeader = document.createElement('div');
                wardHeader.className = 'ward-header';
                wardHeader.innerHTML = `<i class="fas fa-hospital"></i> ${ward}`;
                wardGroup.appendChild(wardHeader);
                
                // Pending tasks section
                const pendingTasks = tasksByWard[ward].pending;
                if (pendingTasks.length > 0) {
                    const pendingSection = document.createElement('div');
                    pendingSection.className = 'task-section';
                    
                    const pendingHeader = document.createElement('div');
                    pendingHeader.className = 'task-section-header';
                    pendingHeader.innerHTML = `
                        <h3><i class="fas fa-clipboard-list"></i> Pending Tasks (${pendingTasks.length})</h3>
                    `;
                    pendingSection.appendChild(pendingHeader);
                    
                    // Sort pending tasks by priority and date
                    pendingTasks.sort((a, b) => {
                        if (a.priority === 'urgent' && b.priority !== 'urgent') return -1;
                        if (a.priority !== 'urgent' && b.priority === 'urgent') return 1;
                        return new Date(b.date) - new Date(a.date);
                    });
                    
                    pendingTasks.forEach(task => {
                        const taskItem = document.createElement('div');
                        taskItem.className = `task-item ${task.priority}`;
                        taskItem.innerHTML = `
                            <div class="task-content">
                                <div class="task-text">${task.text}</div>
                                <div class="task-meta">
                                    <span class="task-patient">
                                        <i class="fas fa-user"></i> ${task.patientName} (${task.patientId})
                                    </span>
                                    <span class="task-location">
                                        <i class="fas fa-map-marker-alt"></i> ${task.ward}
                                    </span>
                                    <span class="task-date">
                                        <i class="fas fa-clock"></i> ${task.date}
                                    </span>
                                </div>
                            </div>
                            <div class="task-actions">
                                <button class="toggle-task-status-btn-all" data-patient-id="${task.patientId}" data-task-id="${task.id}" data-status="normal" title="Toggle Status">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button class="complete-task-btn-all" data-patient-id="${task.patientId}" data-task-id="${task.id}" title="Mark Complete">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="view-patient-task-btn" data-patient-id="${task.patientId}" title="View Patient">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        `;
                        pendingSection.appendChild(taskItem);
                    });
                    
                    wardGroup.appendChild(pendingSection);
                }
                
                // In-progress tasks section
                const inProgressTasks = tasksByWard[ward]['in-progress'];
                if (inProgressTasks.length > 0) {
                    const inProgressSection = document.createElement('div');
                    inProgressSection.className = 'task-section';
                    
                    const inProgressHeader = document.createElement('div');
                    inProgressHeader.className = 'task-section-header';
                    inProgressHeader.innerHTML = `
                        <h3><i class="fas fa-spinner"></i> In Progress (${inProgressTasks.length})</h3>
                    `;
                    inProgressSection.appendChild(inProgressHeader);
                    
                    // Sort by date
                    inProgressTasks.sort((a, b) => new Date(b.progressDate || b.date) - new Date(a.progressDate || a.date));
                    
                    inProgressTasks.forEach(task => {
                        const taskItem = document.createElement('div');
                        taskItem.className = `task-item in-progress`;
                        taskItem.innerHTML = `
                            <div class="task-content">
                                <div class="task-text">${task.text}</div>
                                <div class="task-meta">
                                    <span class="task-patient">
                                        <i class="fas fa-user"></i> ${task.patientName} (${task.patientId})
                                    </span>
                                    <span class="task-location">
                                        <i class="fas fa-map-marker-alt"></i> ${task.ward}
                                    </span>
                                    <span class="task-date">
                                        <i class="fas fa-clock"></i> ${task.progressDate || task.date}
                                    </span>
                                </div>
                            </div>
                            <div class="task-actions">
                                <button class="toggle-task-status-btn-all" data-patient-id="${task.patientId}" data-task-id="${task.id}" data-status="in-progress" title="Toggle Status">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button class="view-patient-task-btn" data-patient-id="${task.patientId}" title="View Patient">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        `;
                        inProgressSection.appendChild(taskItem);
                    });
                    
                    wardGroup.appendChild(inProgressSection);
                }
                
                // Completed tasks section
                const completedTasks = tasksByWard[ward].completed;
                if (completedTasks.length > 0) {
                    const completedSection = document.createElement('div');
                    completedSection.className = 'task-section';
                    
                    const completedHeader = document.createElement('div');
                    completedHeader.className = 'task-section-header';
                    completedHeader.innerHTML = `
                        <h3><i class="fas fa-check"></i> Completed Tasks (${completedTasks.length})</h3>
                    `;
                    completedSection.appendChild(completedHeader);
                    
                    // Sort completed tasks by date (newest first)
                    completedTasks.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    completedTasks.forEach(task => {
                        const taskItem = document.createElement('div');
                        taskItem.className = `task-item ${task.priority}`;
                        taskItem.innerHTML = `
                            <div class="task-content">
                                <div class="task-text">${task.text}</div>
                                <div class="task-meta">
                                    <span class="task-patient">
                                        <i class="fas fa-user"></i> ${task.patientName} (${task.patientId})
                                    </span>
                                    <span class="task-location">
                                        <i class="fas fa-map-marker-alt"></i> ${task.ward}
                                    </span>
                                    <span class="task-date">
                                        <i class="fas fa-clock"></i> ${task.date}
                                    </span>
                                </div>
                            </div>
                            <div class="task-actions">
                                <button class="toggle-task-status-btn-all" data-patient-id="${task.patientId}" data-task-id="${task.id}" data-status="completed" title="Toggle Status">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button class="view-patient-task-btn" data-patient-id="${task.patientId}" title="View Patient">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        `;
                        completedSection.appendChild(taskItem);
                    });
                    
                    wardGroup.appendChild(completedSection);
                }
                
                allTasksContainer.appendChild(wardGroup);
            });
            
            // Add event listeners for task actions
            document.querySelectorAll('.toggle-task-status-btn-all').forEach(button => {
                button.addEventListener('click', toggleTaskStatusFromAll);
            });
            
            document.querySelectorAll('.complete-task-btn-all').forEach(button => {
                button.addEventListener('click', markTaskCompleteFromAll);
            });
            
            document.querySelectorAll('.view-patient-task-btn').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const patientId = this.getAttribute('data-patient-id');
                    showPatientDetails(patientId);
                });
            });
            
            document.querySelectorAll('.delete-task-all-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const patientId = this.getAttribute('data-patient-id');
                    const taskId = parseInt(this.getAttribute('data-task-id'));
                    deleteTaskFromAll(patientId, taskId);
                });
            });
        }
        
        // Function to show edit task modal
        function showEditTaskModal(taskId) {
            currentEditingTaskId = taskId;
            const patient = patients.find(p => p.id === currentPatientId);
            
            if (!patient) return;
            
            const task = patient.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            // Populate form fields
            editTaskText.value = task.text;
            editTaskDescription.value = task.description || '';
            editTaskPriority.value = task.priority;
            
            // Show the modal
            taskEditModal.classList.remove('hidden');
        }
        
        // Function to save edited task
        function saveEditedTask(e) {
            e.preventDefault();
            
            const text = editTaskText.value.trim();
            const description = editTaskDescription.value.trim();
            const priority = editTaskPriority.value;
            
            if (text && currentPatientId && currentEditingTaskId) {
                const patientIndex = patients.findIndex(p => p.id === currentPatientId);
                
                if (patientIndex === -1) return;
                
                const taskIndex = patients[patientIndex].tasks.findIndex(t => t.id === currentEditingTaskId);
                
                if (taskIndex === -1) return;
                
                // Update task
                patients[patientIndex].tasks[taskIndex].text = text;
                patients[patientIndex].tasks[taskIndex].description = description;
                patients[patientIndex].tasks[taskIndex].priority = priority;
                
                localStorage.setItem('patients', JSON.stringify(patients));
                
                // Close modal and refresh task list
                taskEditModal.classList.add('hidden');
                renderTasks(patients[patientIndex]);
            }
        }
        
        // Toggle task details in form
        function toggleTaskDetails() {
            taskFormExpandable.classList.toggle('expanded');
            toggleTaskDetailsBtn.classList.toggle('active');
            
            const buttonText = toggleTaskDetailsBtn.querySelector('span');
            if (taskFormExpandable.classList.contains('expanded')) {
                buttonText.textContent = 'Hide details';
            } else {
                buttonText.textContent = 'Add details';
            }
        }
        
        // Function to handle showing the patient add modal
        function showAddPatientModal() {
            modalTitle.textContent = 'Add New Patient';
            patientForm.reset();
            
            // Clear any existing diagnosis inputs
            diagnosesContainer.innerHTML = '';
            
            // Add one empty diagnosis input
            addDiagnosisInput('');
            
            patientModal.classList.remove('hidden');
        }
        
        // Event listeners
        addPatientBtn.addEventListener('click', showAddPatientModal);
        addDiagnosisBtn.addEventListener('click', () => addDiagnosisInput());
        backToListBtn.addEventListener('click', () => {
            patientDetailView.classList.add('hidden');
            patientListView.classList.remove('hidden');
            // Update the patient list to show any new urgent tasks
            renderPatientList();
        });
        editPatientBtn.addEventListener('click', showEditPatientModal);
        deletePatientBtn.addEventListener('click', deletePatient);
        closeModal.addEventListener('click', () => patientModal.classList.add('hidden'));
        closeTaskModal.addEventListener('click', () => taskEditModal.classList.add('hidden'));
        toggleTaskDetailsBtn.addEventListener('click', toggleTaskDetails);
        patientForm.addEventListener('submit', savePatient);
        taskForm.addEventListener('submit', addTask);
        editTaskForm.addEventListener('submit', saveEditedTask);
        clinicalNoteForm.addEventListener('submit', addClinicalNote);
        medicalHistoryForm.addEventListener('submit', addDiagnosis);
        patientSearch.addEventListener('input', searchPatients);
        
        // Tab switching
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Remove active class from all tabs
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                
                // Add active class to clicked tab
                button.classList.add('active');
                const tabId = button.getAttribute('data-tab');
                document.getElementById(`${tabId}-tab`).classList.add('active');
            });
        });
        
        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === patientModal) {
                patientModal.classList.add('hidden');
            }
            if (e.target === taskEditModal) {
                taskEditModal.classList.add('hidden');
            }
        });
        
        // Main tab switching
        mainTabButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Remove active class from all tabs
                mainTabButtons.forEach(btn => btn.classList.remove('active'));
                mainViews.forEach(view => view.classList.remove('active'));
                
                // Add active class to clicked tab
                button.classList.add('active');
                const viewId = button.getAttribute('data-view');
                
                // Hide patient detail view no matter which tab is clicked
                patientDetailView.classList.add('hidden');
                
                if (viewId === 'patients') {
                    patientListView.classList.add('active');
                    patientListView.classList.remove('hidden');
                    allTasksView.classList.remove('active');
                    allTasksView.classList.add('hidden');
                    renderPatientList();
                } else if (viewId === 'all-tasks') {
                    allTasksView.classList.add('active');
                    allTasksView.classList.remove('hidden');
                    patientListView.classList.remove('active');
                    patientListView.classList.add('hidden');
                    renderAllTasks();
                }
            });
        });
        
        // Event listener for task filter
        taskFilter.addEventListener('change', function() {
            const searchTerm = taskSearch.value.trim();
            renderAllTasks(this.value, searchTerm);
        });
        
        // Event listener for task search
        taskSearch.addEventListener('input', function() {
            const currentFilter = taskFilter.value;
            const searchTerm = this.value.trim();
            renderAllTasks(currentFilter, searchTerm);
        });
        
        // Add event listeners for delete buttons in the all tasks view
        document.querySelectorAll('.delete-task-all-btn').forEach(button => {
            button.addEventListener('click', function() {
                const patientId = this.getAttribute('data-patient-id');
                const taskId = parseInt(this.getAttribute('data-task-id'));
                deleteTaskFromAll(patientId, taskId);
            });
        });
        
        // Function to delete a task from the all tasks view
        function deleteTaskFromAll(patientId, taskId) {
            const patientIndex = patients.findIndex(p => p.id === patientId);
            if (patientIndex === -1) return;
            
            const taskIndex = patients[patientIndex].tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;
            
            // Confirm before deleting
            if (confirm(`Are you sure you want to delete this task from ${patients[patientIndex].name}?`)) {
                patients[patientIndex].tasks.splice(taskIndex, 1);
                localStorage.setItem('patients', JSON.stringify(patients));
                
                // Re-render the all tasks view
                const currentFilter = document.getElementById('task-filter').value;
                const searchTerm = document.getElementById('task-search').value.trim();
                renderAllTasks(currentFilter, searchTerm);
            }
        }
        
        // Define the toggleTaskStatusFromAll function properly 
        function toggleTaskStatusFromAll() {
            const patientId = this.getAttribute('data-patient-id');
            const taskId = parseInt(this.getAttribute('data-task-id'));
            const currentStatus = this.getAttribute('data-status');
            
            const patientIndex = patients.findIndex(p => p.id === patientId);
            if (patientIndex === -1) return;
            
            const taskIndex = patients[patientIndex].tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;
            
            // Cycle through statuses: normal → in-progress → completed → normal
            if (currentStatus === 'normal' || currentStatus === 'urgent') {
                // Move to in-progress
                patients[patientIndex].tasks[taskIndex].priority = 'in-progress';
                patients[patientIndex].tasks[taskIndex].progressDate = new Date().toLocaleString();
            } else if (currentStatus === 'in-progress') {
                // Move to completed
                patients[patientIndex].tasks[taskIndex].priority = 'completed';
                patients[patientIndex].tasks[taskIndex].completedDate = new Date().toLocaleString();
            } else if (currentStatus === 'completed') {
                // Move back to normal
                patients[patientIndex].tasks[taskIndex].priority = 'normal';
                delete patients[patientIndex].tasks[taskIndex].completedDate;
                delete patients[patientIndex].tasks[taskIndex].progressDate;
            }
            
            localStorage.setItem('patients', JSON.stringify(patients));
            
            // Re-render the all tasks view
            const currentFilter = document.getElementById('task-filter').value;
            const searchTerm = document.getElementById('task-search').value.trim();
            renderAllTasks(currentFilter, searchTerm);
        }
        
        // Function to mark a task as complete directly from pending in All Tasks view
        function markTaskCompleteFromAll() {
            const patientId = this.getAttribute('data-patient-id');
            const taskId = parseInt(this.getAttribute('data-task-id'));
            
            const patientIndex = patients.findIndex(p => p.id === patientId);
            if (patientIndex === -1) return;
            
            const taskIndex = patients[patientIndex].tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;
            
            // Set directly to completed
            patients[patientIndex].tasks[taskIndex].priority = 'completed';
            patients[patientIndex].tasks[taskIndex].completedDate = new Date().toLocaleString();
            
            localStorage.setItem('patients', JSON.stringify(patients));
            
            // Re-render the all tasks view
            const currentFilter = document.getElementById('task-filter').value;
            const searchTerm = document.getElementById('task-search').value.trim();
            renderAllTasks(currentFilter, searchTerm);
        }
        
        // Initial render
        renderPatientList();
    </script>
</body>
</html> 